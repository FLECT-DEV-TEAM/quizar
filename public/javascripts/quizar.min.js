/*! quizar 2014-03-24 */
"undefined"==typeof flect&&(flect={}),$(function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}flect.Connection=function(b,c){function d(){if(0==arguments.length)return y;var a=arguments[0];return y=a?a:null,t}function e(a){return q()?(u.onRequest&&u.onRequest(a.command,a.data),y?f(a):g(a),t):(o(function(){e(a)}),void(socket=r()))}function f(b){c.log("ajax",b.command);var d=(new Date).getTime(),e=++v,f=b.url?b.url:y,g=b.success;if(b.command&&(a(f,"/")||(f+="/"),f+=b.command,delete b.command),f+="?id="+e,b.log&&(f+="&log="+b.log,delete b.log),b.url=f,b.type||(b.type="POST"),b.data){var h=JSON.stringify(b.data);b.data={data:h}}b.success=function(a){if(u.onMessage&&u.onMessage(a,d),a){if("error"==a.type)return void(u.onServerError&&u.onServerError(a.data));var c=g;c||(c=x[b.command]),c&&c(a.data)}},$.ajax(b)}function g(a){c.log("ws",a.command);var b=(new Date).getTime(),d=++v;w[d]=b,a.success&&(x[d]=a.success);var e={id:d,command:a.command,data:a.data};a.log&&(e.log=a.log),socket.send(JSON.stringify(e))}function h(a,b){return x[a]=b,t}function i(a){return delete x[a],t}function j(a){A=0;for(var b=0;b<z.length;b++)z[b]();z=[],u.onOpen&&u.onOpen(a)}function k(a){var b=JSON.parse(a.data),d=w[b.id],e=null;return d&&delete w[b.id],u.onMessage&&u.onMessage(b,d),"error"==b.type?void(u.onServerError&&u.onServerError(b.data)):(b.id&&x[b.id]?(e=x[b.id],delete x[b.id]):b.command&&x[b.command]&&(e=x[b.command]),void(e?e(b.data):c.log("UnknownMessage",a.data)))}function l(a){u.onClose&&u.onClose(a),s>A&&(A++,setTimeout(function(){socket=r()},1e3*A))}function m(a){u.onSocketError&&u.onSocketError(a)}function n(a,b){return setInterval(function(){e($.extend(!0,{},b))},a)}function o(a){q()?a():z.push(a)}function p(){q()&&(A=s,socket.close())}function q(){return 1==socket.readyState}function r(){var a=new WebSocket(b);return a.onopen=j,a.onmessage=k,a.onerror=m,a.onclose=l,a}var s=5,t=this,u={},v=0,w={},x={},y=null,z=[],A=0;socket=r(),$.extend(this,{useAjax:d,request:e,addEventListener:h,removeEventListener:i,polling:n,ready:o,close:p,isConnected:q,onOpen:function(a){return u.onOpen=a,this},onClose:function(a){return u.onClose=a,this},onRequest:function(a){return u.onRequest=a,this},onMessage:function(a){return u.onMessage=a,this},onSocketError:function(a){return u.onSocketError=a,this},onServerError:function(a){return u.onServerError=a,this}})}}),"undefined"==typeof flect&&(flect={}),$(function(){function a(){function a(a){return c[a]}function b(a,b){c[a]=b}var c={};$.extend(this,{getItem:a,setItem:b})}var b=300;flect.TemplateManager=function(c,d){function e(a){"string"==typeof a&&(a={name:a});var b=a.name;"function"==typeof b&&(b=b());var c=h.getItem("template."+b);c?g(c,a):f(b,function(c){h.setItem("template."+b,c),g(c,a)})}function f(a,b){c.request({command:"template",log:a,data:{name:a},success:b})}function g(a,c){function e(){c.afterShow&&c.afterShow(d)}i&&i(d),d.hide(),j&&j(d),d.empty(),d.html(a),c.beforeShow&&c.beforeShow(d),i=c.beforeHide,j=c.afterHide,setTimeout(function(){var a=c.direction||"right",f=c.effect;"none"==f?d.show(0,e):d.show("slide",{direction:a},b,e)},0)}var h=window.sessionStorage?window.sessionStorage:new a,i=null,j=null;$.extend(this,{show:e,loadTemplate:f})}}),"undefined"==typeof flect&&(flect={}),$(function(){flect.MessageDialog=function(a){function b(b){b=b||3,a.css({"animation-name":"fade","-webkit-animation-name":"fade","animation-duration":b+"s","-webkit-animation-duration":b+"s"}),a.show(),setTimeout(function(){if(a.hide(),a.css("animation-name",""),a.css("-webkit-animation-name",""),f=!1,g.length>0){var b=g;g=[],setTimeout(function(){c(b)},10)}else if(h.length>0){var b=h;h=[],setTimeout(function(){d(b)},10)}},1e3*b)}function c(c,d){if(f)return void g.push(c);f=!0,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var h=$("<span class='message'></span>");h.text(c[e]),a.append(h)}b(d)}function d(c,d){if(f)return void h.push(c);f=!0,d=d||3,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var g=c[e],i=$("<div class='tweet'><img/><p></p><p></p></div>");i.find("img").attr("src",g.img),i.find("p:first").text(g.username),i.find("p:last").text(g.msg),a.append(i)}b(d)}function e(a,b){d({userId:a.id,username:a.name,msg:b,img:a.imageUrl})}var f=!1,g=[],h=[];$.extend(this,{show:c,notifyTweet:d,notifyUserAction:e})}}),$(function(){function a(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}function b(a){return a.split("\n").filter(function(a){return a.length>0}).join("\n")}function c(a){return a.each(function(){var a=$(this),b=a.attr("id");b&&a.attr("name",b)}),a}function d(a){for(var b in a)delete a[b]}function e(a,b){b||(b=a.find(".option-panel"),a=a.find(".option-ctrl")),a.click(function(){var c=a.find("i");c.hasClass("fa-caret-down")?(c.removeClass("fa-caret-down").addClass("fa-caret-up"),a.addClass("active")):(c.removeClass("fa-caret-up").addClass("fa-caret-down"),a.removeClass("active")),b.slideToggle()})}function f(a){return Math.round(a/10)/100}function g(a,b){a.show("slide",{direction:b},A)}function h(){function a(){var a=e.getFullYear(),b=e.getMonth()+1,c=e.getDate();return 10>b&&(b="0"+b),10>c&&(c="0"+c),a+"-"+b+"-"+c}function b(){var a=e.getHours(),b=e.getMinutes();return 10>a&&(a="0"+a),10>b&&(b="0"+b),a+":"+b}function c(){return a().substring(5)+" "+b()}function d(){return e.getTime()}var e;switch(arguments.length){case 1:e=new Date(arguments[0]);break;case 2:e=new Date(arguments[0]+" "+arguments[1])}$.extend(this,{dateStr:a,timeStr:b,datetimeStr:c,getTime:d})}function i(b,c,d,e){function f(){l>0&&(l-=e,d(l,e,!1),h())}function g(){c>l+e&&(l+=e,d(l,e,!0),h())}function h(){a(m,l>0),a(n,c>l+e)}function i(){return 0==arguments.length?c:(c=arguments[0],this)}function j(){return{swipeLeft:function(a){g(),a.stopImmediatePropagation()},swipeRight:function(a){f(),a.stopImmediatePropagation()},tap:function(a,b){z&&$(b).click()}}}function k(){m=null,n=null}var l=0,m=b.find(".paging-bar-left"),n=b.find(".paging-bar-right");e=e||10,m.click(f),n.click(g),h(),$.extend(this,{prev:f,next:g,recordCount:i,swipeParams:j,release:k})}function j(a){function b(b,c){c||(c=5),a.animateDialog(b,{name:"rotateZoom",duration:c+"s"})}$.extend(this,{show:b})}function k(a){function b(){return!!n.userId}function c(){return!!n.userEventId}function d(){return n.eventStatus==D.Running}function e(){return!!n.eventAdmin}function f(){return!!n.roomId}function g(){return!!n.roomAdmin}function h(){return!!n.userQuiz}function i(){return!!n.debug}function j(a,b){n.eventId=a,n.eventStatus=D.Running,n.eventAdmin=b}function k(){n.eventId=0,n.eventStatus=D.Prepared,n.userEventId=0,n.eventAdmin=!1}function l(a){n.userEventId=a}function m(){return b()&&f()&&!g()}var n=this;$.extend(this,a,{isLogined:b,isEntryEvent:c,isEventRunning:d,isEventAdmin:e,isInRoom:f,isRoomAdmin:g,isPostQuestionAllowed:h,isDebug:i,openEvent:j,closeEvent:k,entryEvent:l,canEntryEvent:m}),this.eventStatus||(this.eventStatus=D.Prepared)}function l(a){function b(){return this.imageUrl}function c(){return this.imageUrl.replace("_mini","_normal")}function e(){return this.imageUrl.replace("_mini","_bigger")}$.extend(this,a,{getMiniImageUrl:b,getNormalImageUrl:c,getBiggerImageUrl:e}),d(a)}function m(a,b,c){function d(){var a=$(this).attr("data-id");a&&(location.href="/room/"+a)}function e(){var a=n.tabs("option","active"),b=$(0==a?"#event-future":"#event-yours");$("#event-detail").hide(),g(b,"left")}function f(a){$("#room-detail-enter").attr("data-id",a.id),$("#room-detail-name").text(a.name),a.userQuiz&&$("#room-detail-userQuiz").attr("checked","checked"),$("#room-detail-description").val(a.description||""),a.event?($("#room-detail-event").show(),$("#room-detail-title").text(a.event.title||"-"),$("#room-detail-date").text(a.event.exceDate?new h(a.event.execDate).datetimeStr():"-"),$("#room-detail-capacity").text(a.event.capacity),$("#room-detail-description2").val(a.event.description||"")):$("#room-detail-event").hide(),n.find(".tab-pane").hide(),g($("#event-detail"),"right")}function i(a){a.find("tbody tr").click(function(){var a=$.data(this,"room");a&&f(a)})}function j(c,d){for(var e=c.find("tbody"),f={},g=0;g<d.length;g++){var i=d[g],j=$("<tr><td class='event-date'></td><td class='event-title'><img src='"+B+"'/></td><td class='event-capacity'></td></tr>"),k=j.find("img"),m=MSG.undecided,n=i.name,o="";i.event&&(i.event.title&&(n+="("+i.event.title+")"),i.event.status==D.Running?m=MSG.eventRunning:i.event.execDate&&(m=new h(i.event.execDate).datetimeStr()),i.event.capacity&&(o=""+i.event.capacity+MSG.people)),j.attr("data-room",i.id),j.find(".event-date").text(m),j.find(".event-title").append(n),j.find(".event-capacity").text(o),b[i.owner]?k.attr("src",b[i.owner].getMiniImageUrl()):f[i.owner]?k.attr("data-userId",i.owner):(f[i.owner]=!0,k.attr("data-userId",i.owner),a.request({command:"getUser",data:i.owner,success:function(a){var d=new l(a);b[d.id]=d,c.find("[data-userId="+d.id+"]").attr("src",d.getMiniImageUrl()).removeAttr("data-userId")}})),$.data(j[0],"room",i),e.append(j)}}function k(b){var f=$("#event-future"),g=$("#event-yours");a.request({command:"listRoom",data:{limit:10,offset:0},success:function(a){j(f,a),i(f),n=b.find(".tab-content").tabs().show()}}),c&&a.request({command:"listRoom",data:{limit:10,offset:0,userId:c},success:function(a){j(g,a),i(g)}}),$("#room-detail-enter").click(d),$("#room-detail-back").click(e)}function m(){n=null}var n=null;$.extend(this,{init:k,clear:m})}function n(a,b,c,d){function e(a){for(var e=$("#mypage-entries tbody"),f=$("#mypage-owners tbody"),g={},h=0;h<a.length;h++){var i=a[h],j=$("<tr><td class='event-title'><img src='"+B+"'/></td></tr>"),k=j.find("img");j.find(".event-title").append(i.name),c[i.owner]?k.attr("src",c[i.owner].getMiniImageUrl()):g[i.owner]?k.attr("data-userId",i.owner):(g[i.owner]=!0,k.attr("data-userId",i.owner),d.request({command:"getUser",data:i.owner,success:function(a){var b=new l(a);c[b.id]=b,$el.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId")}})),$.data(j[0],"room",i),i.owner==b.userId?f.append(j):e.append(j)}}function f(a){d.request({command:"listRoom",data:{limit:10,offset:0,userId:b.userId},success:function(b){e(b),h=a.find(".tab-content").tabs().show()}})}function g(){h=null}var h=null;$.extend(this,{init:f,clear:g})}function o(a,b,c,d){function e(a,c){b&&d.request({command:"tweet",data:{userId:b,msg:a,twitter:c}})}function f(){return a.is(":hidden")&&$("#chat-notify").is(":checked")}function g(a){return 0==arguments.length?o.text():void o.text(a)}function h(a){j>i&&n.find("li:first").remove();var c=a.userId==b?"align-left":"align-right",d=$("<li style='display:none;'><div class='contributor'><img/><span/></div><div class='balloon'><div class='balloon-border'><p class='text'></p></div></div></li>"),e=d.find("img"),f=d.find(".contributor span"),g=d.find(".text");d.addClass(c),f.text(a.username),e.attr("src",a.img),g.text(a.msg),n.append(d),d.show("slow"),j++}var i=20,j=0,k=$("#chat-text"),l=$("#chat-twitter"),m=$("#chat-text-len"),n=a.find(".tweet-box ul"),o=$("#room-member");b&&($("#btn-tweet").click(function(){var a=k.val(),b=l.is(":checked");0==a.length||a.length>140||a==c||(k.val(c),e(a,b))}),k.keyup(function(){var a=140-k.val().length;0>=a?m.addClass("error"):m.removeClass("error"),m.text(a)})),c?"#"!=c.charAt(0)&&(c="#"+c):c="",k.val(c),$.extend(this,{member:g,append:h,tweet:e,isNotifyTweet:f})}function p(a,b,d){function f(a){return a.attr("id").substring(5)}function g(){if(m&&m.form()){var c=l||{id:-1,owner:b};j.find(":input").each(function(){var a=$(this),b=f(a);a.is(":checkbox")?c[b]=a.is(":checked"):a.val()&&(c[b]=a.val())}),d.request(l?{command:"updateRoom",data:c,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"makeRoom",data:c,success:function(a){a.id&&(d.close(),location.href="/room/"+a.id)}})}}function h(a){if(k&&!l)return void d.request({command:"getRoom",data:k,success:function(b){l=b,h(a)}});j=$("#make-room-form"),c(j.find(":input")).each(function(){var a=$(this);if(l){var b=f(a);l[b]&&(a.is(":checkbox")?a.attr("checked","checked"):a.val(l[b]))}}),m=j.validate({rules:{"room-name":{required:!0,maxlength:100},"room-tags":{maxlength:100},"room-hashtag":{maxlength:20},"room-description":{maxlength:400}},focusInvalid:!0});var b=$("#btn-make-room").click(g),i=$("#make-room-desc");l?($("#room-admin").show(),i.text(MSG.makeRoomDescForEdit),b.text(MSG.update)):($("#room-admin").hide(),i.text(MSG.makeRoomDescForCreate),b.text(MSG.create)),e(a)}function i(){j=null,m=null,k=0,l=null}var j=null,k=0,l=null,m=null;$.extend(this,{init:h,clear:i,edit:function(a){k=a}})}function q(b,c,d,e){function f(f,g){function h(a){for(var b=0;b<s.length;b++){var c=s[b];if(c.id==a)return c}return null}function i(a,i){var j=$("<tr><td class='q-creator'><img src='"+B+"'/></td><td class='q-text'></td>"+(g?"<td class='q-answerer'></td>":"<td class='q-publish'><button class='btn blue'>"+MSG.publish+"</button></td>")+"</tr>"),k=j.find("img");if(j.attr("data-id",a.id),j.attr("data-at",a.answerType),j.find(".q-text").text(a.question),c[a.createdBy]?k.attr("src",c[a.createdBy].getMiniImageUrl()).after(c[a.createdBy].name):i[a.createdBy]?k.attr("data-userId",a.createdBy):(i[a.createdBy]=!0,k.attr("data-userId",a.createdBy),e.request({command:"getUser",data:a.createdBy,success:function(a){var b=new l(a);c[b.id]=b,f.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId").after(b.name)}})),g){var m=a.correctCount+"/"+a.publishCount;j.find(".q-answerer").text(m),publishedQuestions[a.id]&&j.addClass("q-published")}else d.isEventRunning()?j.find("button").click(function(){var a=$(this).parents("tr"),c=parseInt(a.attr("data-id")),f=a.attr("data-at");e.request({command:"publishQuestion",data:{questionId:c,eventId:d.eventId,includeRanking:f!=C.NoAnswer},success:function(a){"OK"!=a&&b.showMessage(a)}})}):j.find("button").attr("disabled","disabled").removeClass("blue").addClass("disabled");j.click(function(){var a=$(this).attr("data-id");b.showMakeQuestion(h(a))}),t.append(j)}function j(a,b,c){e.request({command:"listQuestion",data:{published:g,offset:a,limit:b},success:function(a){var b=t.parents("table"),d={};s=a,t.empty(),c&&b.hide();for(var e=0;e<a.length;e++)i(a[e],d);c&&b.show("slide",{direction:c},A)}})}function k(){r>0&&(r-=m,j(r,m,"left"),p())}function n(){q>r+m&&(r+=m,j(r,m,"right"),p())}function o(){return 0==arguments.length?q:(q=arguments[0],this)}function p(){a($btnPrev,r>0),a($btnNext,q>r+m)}var q=0,r=0,s=[],t=f.find("table tbody");f.swipe({swipeLeft:function(a){n(),a.stopImmediatePropagation()},swipeRight:function(a){k(),a.stopImmediatePropagation()},tap:function(a,b){z&&$(b).click()}}),$.extend(this,{prev:k,next:n,load:j,count:o,activate:p})}function g(){var a=$tab.tabs("option","active");return 0==a?n:publishedTable}function h(a){e.request({command:"countQuestion",success:function(b){n.count(b.count-b.published),publishedTable.count(b.published),$("#question-stock-count").text(n.count()),$("#question-published-count").text(publishedTable.count()),a&&n.activate()}})}function i(a){n=new f($("#edit-question-stock"),!1),publishedTable=new f($("#edit-question-published"),!0),$tab=a.find(".tab-content").tabs({activate:function(){g().activate()}}),h(!0),d.isEventRunning()&&e.request({command:"getPublishedQuestions",data:d.eventId,success:function(a){for(var b=0;b<a.length;b++)publishedQuestions[a[b]]=!0}}),n.load(0,m),publishedTable.load(0,m),$("#edit-question-new").click(function(){b.showMakeQuestion()}),$btnPrev=$("#edit-question-left").click(function(){g().prev()}),$btnNext=$("#edit-question-right").click(function(){g().next()})}function j(){n&&(h(g()==n),n.load(0,m))}function k(){n=null,publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={}}var m=10,n=null;publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={},$.extend(this,{init:i,clear:k,reload:j})}function r(d,f,g){function h(){$("#make-q-question").val(""),$("#make-q-answers").val(""),$("#make-q-answerType").val(C.FirstRow),$("#make-q-tags").val(""),$("#make-q-description").val(""),$("#make-q-relatedUrl").val("")}function i(){var a={id:0,roomId:f.roomId,createdBy:f.userId};return s&&(a.id=s.id,a.createdBy=s.createdBy),t.find(":input").each(function(){var b=$(this),c=j(b),d=b.val();"answerType"==c&&(d=parseInt(d)),a[c]=d}),a.answers=b(a.answers),a}function j(a){return a.attr("id").substring(7)}function k(){return 0==arguments.length?r:(r=arguments[0],this)}function l(){return r=0,this}function m(){if(s&&s.publishCount>0&&d.showMessage("Can not update published question"),y&&y.form()){var b=i();g.request(s?{command:"updateQuestion",data:b,success:function(){s=b,r?d.showMessage(MSG.successUpdate):d.showQuestionList("left"),a(v,!0)}}:{command:"createQuestion",data:b,success:function(b){f.isRoomAdmin()?(s=b,f.isEventAdmin()?(d.showMessage(MSG.successUpdate),u.text(MSG.update),x.show("slow"),a(v,!0)):d.showQuestionList("left")):(d.showMessage(MSG.questionPosted),h())}})}}function n(){g.request({command:"publishQuestion",data:{questionId:s.id,eventId:r,includeRanking:w.is(":checked")},success:function(a){"OK"!=a&&d.showMessage(a)}})}function o(b){a(w,b),b||w.removeAttr("checked")}function p(b){t=$("#make-q-form"),c(t.find(":input")).each(function(){var a=$(this);if(s){var b=j(a);s[b]&&a.val(s[b])}}),y=t.validate({rules:{"make-q-question":{required:!0},"make-q-answers":{quizChoices:!0,required:!0},"make-q-tags":{maxlength:100},"make-q-relatedUrl":{url:!0,maxlength:256}},focusInvalid:!0}),t.find(":input").change(function(){a(v,!1)}),u=$("#make-q-update-btn").click(m),x=$("#make-q-publish"),w=$("#make-q-includeRank"),s&&r&&x.show(),v=$("#make-q-publish-btn").click(n),e(b),s&&($("#make-q-desc").text(r?MSG.editAndPublishQuestion:MSG.editQuestion),u.text(MSG.update),s.publishCount>0&&(a(t.find(":input"),!1),a(u,!1)),s.answerType==C.NoAnswer&&o(!1)),$("#make-q-answerType").change(function(){var a=$(this).val();o(a!=C.NoAnswer)}),f.isRoomAdmin()?$("#make-q-back-btn").click(function(){d.showQuestionList("left")}).show():u.text(MSG.post)}function q(){s=null,t=null,u=null,v=null,w=null,x=null,y=null}var r=0,s=null,t=null,u=null,v=null,w=null,x=null,y=null;$.extend(this,{openEvent:k,closeEvent:l,init:p,clear:q,edit:function(a){s=a}})}function s(b,c,d){function e(a,b){$("#answer-"+a).find(".answer-cnt .count").text(b)}function f(a){a.removeClass("white disabled").addClass("blue"),a.find("li:first").empty().append("<i class='fa fa-check fa-2x'></i>")}function g(b){a(b,!1),b.removeClass("white").addClass("disabled")}function h(a){a.removeClass("white blue disabled").addClass("green"),a.find("li:first").empty().append("<i class='fa fa-circle-o fa-2x'></i>")}function i(a){a.removeClass("white blue disabled").addClass("red"),a.find("li:first").empty().append("<i class='fa fa-times fa-2x'></i>")}function j(){if(D)for(var a=0;v>a;a++){var b=""+(a+1),c=x[b]||0;e(b,c)}D.find(".answer-cnt").show()}function k(){var a=(new Date).getTime()-A,e=$(this),h=parseInt(e.attr("id").substring(7));if(!z){if(z=!0,g(D),f(e),E=e,a>u)return void b.showMessage("timeLimitExceeded");d.request({command:"answer",data:{userId:c.userId,publishId:w.id,eventId:c.eventId,userEventId:c.userEventId,answer:h,time:a}}),j()}}function l(a){var b=""+a.answer,d=(x[b]||0)+1;x[b]=d,(c.isEventAdmin()||z)&&e(b,d)}function m(){function a(){var a=-1;for(var b in x){var c=x[b]||0;0!=c&&(-1==a||a>c)&&(a=c)}return a}function b(){var a=-1;for(var b in x){var c=x[b]||0;0!=c&&c>a&&(a=c)}return a}switch(y.answerType){case C.FirstRow:for(var c=y.answers.split("\n")[0],d=0;d<D.length;d++){var e=$(D[d]);if(e.find(".answer").text()==c)return e}break;case C.Most:case C.Least:var f=y.answerType==C.Most?b():a();if(-1==f)return null;var g=[];return D.each(function(){$(this).find(".answer-cnt .count").text()==f&&g.push(this)}),$(g);case C.NoAnswer:return null}throw"IllegalState: "+y.answerType}function n(a){function c(a,b){var c=!1,d=a.attr("id");return b.each(function(){d==$(this).attr("id")&&(c=!0)}),c}if(D){var d=m();if(d){if(E){var e=c(E,d);msg=e?MSG.correctAnswer:MSG.wrongAnswer,e||i(E),a&&b.showEffect(msg,1)}h(d)}if(y.description){var f=$("#publish-q-description");f.find("textarea").val(y.description),f.show()}if(y.relatedUrl){var g=$("#publish-q-url"),j=g.find("a");j.attr("href",y.relatedUrl).text(y.relatedUrl),g.show()}a?$("#publish-q-detail").slideDown():$("#publish-q-detail").show()}}function o(a){y=a,B&&n(!0)}function p(){function a(){b--,e.css("width",b+"%"),20>b?e.removeClass("progress-bar-warning").addClass("progress-bar-danger"):60>b&&e.removeClass("progress-bar-success").addClass("progress-bar-warning"),z&&(-1==c&&(c=b+1),f.css("width",c-b+"%")),b>0?setTimeout(a,d):(g(D),j(),B=!0,y&&n(!0))}var b=100,c=-1,d=u/100,e=$("#publish-q-progress"),f=$("#publish-q-progress-answered"),h=null,i=0,k=0;e.css("width","100%"),f.css("width","0%"),setTimeout(a,d),F.contents().each(function(){$(this).replaceWith($(this).text().replace(/(\S)/g,"<span>$1</span>"))}),F.append('<span class="cur">_</span>'),h=F.find(".cur"),i=setInterval(function(){h&&h.toggle()},200),k=F.children().size();for(var l=0;k>l;l++){var m=F.children("span:eq("+l+")");l==k-1?setTimeout(function(){m.hide(),clearInterval(i)},50*l+2e3):m.delay(50*l).fadeIn(10)}}function q(a){var d=$("#publish-q-seq");if(F=$("#publish-q-text"),$("#publish-q-none").hide(),D=a.find(".btn-question").hide(),w){d.text(MSG.format(MSG.questionSeq,w.seq));for(var e=0;e<w.answers.length;e++){var f=$("#answer-"+(e+1)).show();f.find(".answer-seq").text(e+1+"."),f.find(".answer").text(w.answers[e])}F.text(w.question)}y?($(".publish-q-animation").css({"animation-name":"","-webkit-animation-name":""}),j(),g(D),n(!1)):w?($(".publish-q-animation").css({"animation-name":"inout","-webkit-animation-name":"inout"}),c.isEventAdmin()?j():c.userEventId?D.click(k):g(D)):($("#publish-q-default").hide(),$("#publish-q-none").show()),$("#publish-q-ranking").click(function(){b.showRanking()})}function r(){y||(A=(new Date).getTime(),p())}function s(){D=null,E=null,F=null}function t(a){w=a,x={},y=null,z=!1,A=0,B=!1}var u=1e4,v=5,w=null,x={},y=null,z=!1,A=0,B=!1,D=null,E=null,F=null;$.extend(this,{init:q,afterShow:r,clear:s,receiveAnswer:l,receiveAnswerDetail:o,setQuestion:t})}function t(a,b,c){function d(){return b.isEventRunning()&&!b.isEntryEvent()}function e(){d()&&$(".entry-event").show()}function f(){$(".entry-event").hide()}function g(d){var e={userId:b.userId,username:b.username,userImage:b.userImage,eventId:b.eventId};d&&(e.passcode=d),c.request({command:"entryEvent",data:e,success:function(c){c.error?a.showMessage(c.error):c.requirePass?a.showPasscode():c.userEventId?(b.userEventId=c.userEventId,d&&a.showChat()):alert("Invalid data: "+JSON.stringify(c))}})}function h(){d()&&(g(),$("#entry-event-alert").hide())}function i(){$("#event-passcode-btn").click(function(){var a=$("#event-passcode-user").val();g(a)}),$("#event-cancel-btn").click(function(){a.showChat()})}function j(){}$(".entry-event-btn").click(h),$("#not-entry-event").click(function(){$("#entry-event-alert").hide()}),d()&&e(),$.extend(this,{init:i,clear:j,openEvent:e,closeEvent:f})}function u(a,b,d){function f(a){if(a){for(var b in a){var c=$("#event-"+b);c.length&&c.val(a[b])}if(a.execDate){var d=new h(a.execDate);$("#event-date").val(d.dateStr()),$("#event-time").val(d.timeStr())}}}function g(){var a=$("#event-date").val(),c=$("#event-time").val(),d={id:b.eventId||0,roomId:b.roomId,status:b.eventStatus};return m.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6),c=a.val();c&&(d[b]=a.val())}),a&&(c&&(a+=" "+c),d.execDate=new Date(a).getTime()),d.capacity=parseInt(d.capacity),d}function i(){b.eventStatus==D.Prepared&&(b.eventId?d.request({command:"openEvent",data:{id:b.eventId,admin:b.userId},success:function(b){b?a.showQuestionList():a.showMessage(MSG.failOpenEvent)}}):j(!0))}function j(c){if(n&&n.form()){var e=g();d.request(e.id?{command:"updateEvent",data:e,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"createEvent",data:e,success:function(d){b.eventId=d.id,b.eventStatus=d.status,c?i():a.showMessage(MSG.successUpdate)}})}}function k(a){m=a.find("form"),c(m.find(":input")),n=m.validate({rules:{"event-capacity":{required:!0,digits:!0},"event-title":{maxlength:100},"event-date":{date:!0},"event-time":{time:!0},"event-passcode":{maxlength:100},"event-description":{maxlength:400}},focusInvalid:!0}),e(a),$("#event-start-btn").click(i),$("#event-update-btn").click(function(){j(!1)}),d.request({command:"getCurrentEvent",success:f})}function l(){m=null,n=null}var m=null,n=null;$.extend(this,{init:k,clear:l})}function v(a,b,c){function d(a,b,c){for(var d=0;d<b.length;d++){var e=b[d],g=$("<tr><td class='r-rank'/><td class='r-name'/><td class='r-correct'/><td class='r-time'/></tr>"),h=g.find(".r-rank"),i=g.find(".r-name"),j=$("<img/>");h.text(e.correctCount>0?c+d+1:"-"),j.attr("src",e.imageUrl),i.append(j),i.append(e.username),e.correctCount&&(g.find(".r-correct").text(e.correctCount),g.find(".r-time").text(f(e.time))),a.append(g)}}function e(a,e,f){var g;"boolean"==typeof f&&(g=f?"right":"left"),c.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(b){var c=$("#event-members-tbl"),e=c.find("tbody");e.empty(),g&&c.hide(),d(e,b,a),g&&c.show("slide",{direction:g},A)}})}function g(){b.isEventRunning()&&c.request({command:"closeEvent",data:b.eventId,success:function(b){b&&a.showRanking()}})}function h(a){$("#event-finish-btn").click(g),c.request({command:"getMemberCount",data:b.eventId,success:function(b){k=new i(a.find(".paging-bar"),b,e,10),e(0,10)}})}function j(){k=null}var k=null;$.extend(this,{init:h,clear:j})}function w(a,b,c,d){function e(a,b){3>=b?a.html("<span class='badge circle rank-blue'>"+b+"</span>"):a.text(b),a.attr("data-sortAs",b)}function g(){var a=$(this),b=parseInt(a.attr("data-eventId"));d.request({command:"getEventRanking",data:{eventId:b,limit:10},success:function(a){k($("#ranking-event-detail-tbl"),a),z.find(".tab-pane").hide(),$("#ranking-event-detail").show("slide",{direction:"right"},A)}})}function i(){var a=$(this),e=parseInt(a.attr("data-userId")),f=c[e];d.request({command:"getUserEvent",data:{roomId:b.roomId,userId:e},success:function(b){o(b),$("#ranking-user-img").attr("src",f.getBiggerImageUrl()),$("#ranking-user-name").text(f.name),$("#ranking-user-point").text(a.attr("data-point")),z.find(".tab-pane").hide(),$("#ranking-user").show("slide",{direction:"right"},A)}})}function j(a,b,d){for(var g=$("<tr></tr>"),i=0;i<b.length;i++){var j=$("<td></td>"),k=b[i],m=null;if($.isArray(k)&&(m=k[1],k=k[0]),m||(m=w[k]),m||(m="r-"+k),j.addClass(m),"username"==k&&a.username){var n=$("<img/>");n.attr("src",a.imageUrl),j.append(n),j.append(a.username)}else"title"==k?j.text(a.title||new h(a.execDate).datetimeStr()):"rank"==k?e(j,d):"time"==k&&a.time?j.text(f(a.time)):a[k]&&j.text(a[k]);g.append(j)}return c[a.userId]||(c[a.userId]=new l({id:a.userId,name:a.username,imageUrl:a.imageUrl})),g}function k(a,b,c){var d=a.find("tbody"),g={};if(d.empty(),c&&x)for(var h=0;h<x.length;h++){var i=x[h],k=j(i,s,h+11);g[i.userId]=k,d.append(k)}for(var h=0;h<b.length;h++){var i=b[h],k=g[i.userId];k?(e(k.find(".r-rank"),h+1),k.find(".r-correct").text(i.correctCount),k.find(".r-time").text(f(i.time))):(k=j(i,s,h+1),d.append(k)),k.addClass("new")}c&&(setTimeout(function(){a.tableSort({sortBy:["numeric","nosort","nosort","nosort"]}),a.find("thead th:first").click(),setTimeout(function(){var a=d.find("tr").not(".new");a.hide("slow",function(){a.remove()})},200)},200),x=b,y=null)}function m(a){var c=$("#ranking-event-tbl").find("tbody");c.empty();for(var d=0;d<a.length;d++){var e=a[d],f=null;e.eventId!=b.eventId&&(f=j(e,t),f.attr("data-eventId",e.eventId),f.click(g),c.append(f))}}function n(a){var b=$("#ranking-total-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],e=j(d,u,c+1);e.attr("data-userId",d.userId),e.attr("data-point",d.point),e.click(i),b.append(e)}}function o(a){function c(a){for(var b=0;b<e.length;b++){var c=$(e[b]);if(c.attr("data-eventId")==a)return c.find(".r-title").text()}return"Unknown"}var d=$("#ranking-user-tbl").find("tbody"),e=$("#ranking-event-tbl").find("tbody tr");d.empty();for(var f=0;f<a.length;f++){var g=a[f],h=null,i=g.point>0?10-g.point+1:"-";g.eventId!=b.eventId&&(g.title=c(g.eventId),h=j(g,v,i),d.append(h))}}function p(){B=$("#ranking-now-tbl"),b.isEventRunning()?d.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(a){a.length&&(y=a)}}):$(".ranking-now").hide(),d.request({command:"getEventWinners",data:{roomId:b.roomId,limit:10},success:m}),d.request({command:"getTotalRanking",data:{roomId:b.roomId,limit:10},success:n}),$("#ranking-event-detail-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-event").show("slide",{direction:"left"},A)}),$("#ranking-user-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-total").show("slide",{direction:"left"},A)}),z=$("#ranking-tab").tabs({active:b.isEventRunning()?0:1,beforeActivate:function(){z.find(".tab-pane").hide()}}).show()}function q(){y&&k(B,y,!0)}function r(){z=null,B=null,console.log("Ranking#clear")}var s=["rank","username","correctCount","time"],t=["title",["username","r-winners"],"correctCount","time"],u=["rank","username","point","correctCount"],v=["title","rank","point","correctCount"],w={username:"r-name",correctCount:"r-correct"},x=null,y=null,z=null,B=null;$.extend(this,{init:p,afterShow:q,clear:r})}function x(){function a(a,b,d){c&&c.log(a,b,d)}function b(a){c=a}var c=null;$.extend(this,{log:a,setImpl:b})}function y(a,b){function c(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),f>d&&e.find("tr:first").remove();var g=$("<tr><td></td><td></td><td><div class='pull-right'></div></td></tr>"),h=g.find("td");$(h.get(0)).text(a),$(h.get(1)).text(b),c&&$(h.get(2)).find("div").text(c),e.append(g),f++,console.log(a+", "+b+(c?", "+c+"ms":""))}var d=10,e=a.find("table tbody"),f=0;b.onRequest(function(a,b){var d=a;b&&(d+=", "+JSON.stringify(b)),c("send",d)}).onMessage(function(a,b){var d=(new Date).getTime();c("receive",JSON.stringify(a),d-b)}),$("#chk-use-ajax").bootstrapSwitch().on("switchChange",function(){var a=$(this).is(":checked");b.useAjax(a?"/ajax":!1)}),$("#btn-debug-msg").click(function(){$("#effect-dialog").animateDialog("Start!",{name:"rotateZoom"});var a=$(".publish-q-animation");a.css({"animation-name":"inout","-webkit-animation-name":"inout"}),a.hide(),setTimeout(function(){a.show()},0)}),$.extend(this,{log:c})}$.validator.addMethod("quizChoices",function(a){if(!a||0==a.length)return!1;var b=a.split("\n").filter(function(a){return a.length>0});return b.length<=1||b.length>5?!1:!0},MSG.invalidQuizChoices),$.validator.addMethod("time",function(a,b){return this.optional(b)||/^\d{2}:\d{2}$/.test(a)},MSG.invalidTime);var z="ontouchstart"in window,A=300,B="/assets/images/twitter_default_profile.png",C={FirstRow:0,Most:1,Least:2,NoAnswer:3},D={Prepared:0,Running:1,Finished:2},A=300;flect.QuizApp=function(a){function b(a,b){function c(){d.is(":visible")||(U.children("div").hide(),d.show("slide",{direction:"right"},A))}var d=$("#"+a);b?$.sidr("close",c):c()}function c(){b("chat",!1)}function d(a){if(S){var b={name:"publish-question",effect:"none",beforeShow:function(b){a&&S.setQuestion(a),S.init(b)},afterShow:S.afterShow,afterHide:S.clear};U.children("div").hide(),P.show(b)}}function e(){U.children("div").hide(),P.show(Y.ranking)}function f(a){if(R){var b=$.extend({name:"edit-question"},Y["edit-question"]);a&&(b.direction=a),U.children("div").hide(),P.show(b)}}function g(a){K&&(a&&K.edit(a),U.children("div").hide(),P.show({name:"make-question",beforeShow:K.init,afterHide:K.clear}))}function h(){O&&(U.children("div").hide(),P.show({name:"passcode",beforeShow:O.init,afterHide:O.clear}))}function i(a,b){F.show(a,b)}function B(a,b){G.show(a,b)}function C(a,b){Q&&Q.tweet(a,b)}function D(){if(window.sessionStorage&&sessionStorage.clear(),E=new x,F=new flect.MessageDialog($("#msg-dialog")),G=new j($("#effect-dialog")),H=new flect.Connection(W.uri,E),I=new m(H,X,W.userId),P=new flect.TemplateManager(H,$("#content-dynamic")),U=$("#content"),W.isDebug()&&(E.setImpl(new y($("#debug"),H,F)),$("#btn-debug").click(function(){return b("debug",!0),!1
}),H.onOpen(function(a){console.log("onOpen"),console.log(a)}).onClose(function(a){console.log("onClose"),console.log(a)}).onSocketError(function(a){console.log("onSocketError"),console.log(a)}).onServerError(function(a){console.log(a),alert(a)})),H.addEventListener("redirect",function(a){location.href=a}),W.isLogined()&&(X[W.userId]=new l({id:W.userId,name:W.username,imageUrl:W.userImage}),J=new n(V,W,X,H),L=new p(app,W.userId,H)),W.isInRoom()){var a=$("#chat");Q=new o(a,W.userId,W.hashtag,H),$(".menu-chat").click(function(){return b("chat",$(this).parents("#sidr").length>0),!1}),$("#toolbar-ranking").click(function(){return e(),!1}),$("#toolbar-question").click(function(){return W.isEventAdmin()?f():d(),!1}),H.addEventListener("chat",function(a){Q.append(a),a.userId!=W.userId&&Q.isNotifyTweet()&&F.notifyTweet(a)}),H.addEventListener("member",Q.member),H.addEventListener("newEntry",function(a){var b=new l(a);X[b.id]=b,F.notifyUserAction(b,MSG.newEntry)}),H.ready(function(){0==Q.member()&&H.request({command:"member"})}),H.addEventListener("startEvent",function(a){var b=a.id,c=a.admin;G.show(MSG.start),W.openEvent(b,c==W.userId),K&&K.openEvent(W.eventId),O&&setTimeout(O.openEvent,3e3)}),H.addEventListener("finishEvent",function(){G.show(MSG.finish),W.closeEvent(),K&&K.closeEvent(),O&&O.closeEvent()}),S=new s(V,W,H),H.addEventListener("question",function(a){d(a)}),H.addEventListener("answer",S.receiveAnswer),H.addEventListener("answerDetail",S.receiveAnswerDetail),T=new w(V,W,X,H)}$("#home").length&&H.ready(function(){I.init($("#home"))}),(W.isRoomAdmin()||W.isPostQuestionAllowed())&&(K=new r(V,W,H),W.isEventRunning()&&K.openEvent(W.eventId)),W.isRoomAdmin()&&(R=new q(V,X,W,H),M=new u(V,W,H),H.addEventListener("postQuestion",function(a){var b=a,c=X[b];R.reload(),c?F.notifyUserAction(c,MSG.postQuestionMessage):H.request({command:"getUser",data:b,success:function(a){var b=new l(a);X[b.id]=b,F.notifyUserAction(b,MSG.postQuestionMessage)}})}),N=new v(V,W,H)),W.canEntryEvent()&&(O=new t(V,W,H)),$("#btn-menu").sidr({onOpen:function(){$("#toolbar").css("left","260px").find(".header-center").hide()},onClose:function(){$("#toolbar").css("left","0px").find(".header-center").show()}}),$("#content").swipe({swipeLeft:function(){$.sidr("close")},swipeRight:function(){$.sidr("open")},tap:function(a,b){z&&$(b).click()}}),H.polling(25e3,{command:"noop",log:"user="+(W.isLogined()?W.username:"(Anonymous)")}),$("#sidr a.dynamic").click(function(){var a=$(this).attr("href").substring(1),b=$.extend({name:a},Y[a]);return $.sidr("close",function(){U.children("div").hide(),P.show(b)}),!1}),$(".dropdown-button").click(function(){return $(this).next("ul").toggle(),!1}),$(".dropdown-menu a").click(function(){var a=$(this);return a.parents(".dropdown-menu").hide(),"#"!=a.attr("href")})}var E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V=this,W=new k(a),X={};D(),E.log("params",W);var Y={home:{beforeShow:I.init,afterHide:I.clear}};W.isLogined()&&$.extend(Y,{mypage:{beforeShow:J.init,afterHide:J.clear},"make-room":{beforeShow:function(a){L.clear(),L.init(a)},afterHide:L.clear},"edit-room":{name:"make-room",beforeShow:function(a){L.clear(),L.edit(W.roomId),L.init(a)},afterHide:L.clear}}),W.isRoomAdmin()?($.extend(Y,{"edit-question":{beforeShow:R.init,afterHide:R.clear}}),$.extend(Y,{"edit-event":{beforeShow:function(a){W.isEventRunning()?N.init(a):M.init(a)},name:function(){return W.isEventRunning()?"event-members":"edit-event"},afterHide:function(){W.isEventRunning()?N.clear():M.clear()}}})):W.isPostQuestionAllowed()&&$.extend(Y,{"post-question":{name:"make-question",beforeShow:K.init,afterHide:K.clear}}),W.isInRoom()&&$.extend(Y,{"publish-question":{name:"publish-question",beforeShow:S.init,afterHide:S.clear},ranking:{name:"ranking",beforeShow:T.init,afterShow:T.afterShow,afterHide:T.clear}}),$.extend(this,{showQuestionList:f,showMakeQuestion:g,showPasscode:h,showChat:c,showRanking:e,showQuestion:d,showMessage:i,showEffect:B,tweet:C})}});