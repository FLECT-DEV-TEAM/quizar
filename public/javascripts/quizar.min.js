/*! quizar 2014-03-19 */
"undefined"==typeof flect&&(flect={}),$(function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}flect.Connection=function(b,c){function d(){if(0==arguments.length)return u;var a=arguments[0];return u=a?a:null,p}function e(a){return q.onRequest&&q.onRequest(a.command,a.data),u?f(a):g(a),p}function f(b){c.log("ajax",b.command);var d=(new Date).getTime(),e=++r,f=b.url?b.url:u,g=b.success;if(b.command&&(a(f,"/")||(f+="/"),f+=b.command,delete b.command),f+="?id="+e,b.log&&(f+="&log="+b.log,delete b.log),b.url=f,b.type||(b.type="POST"),b.data){var h=JSON.stringify(b.data);b.data={data:h}}b.success=function(a){if(q.onMessage&&q.onMessage(a,d),a){if("error"==a.type)return void(q.onError&&q.onError(a.data));var c=g;c||(c=t[b.command]),c&&c(a.data)}},$.ajax(b)}function g(a){c.log("ws",a.command);var b=(new Date).getTime(),d=++r;s[d]=b,a.success&&(t[d]=a.success);var e={id:d,command:a.command,data:a.data};a.log&&(e.log=a.log),x.send(JSON.stringify(e))}function h(a,b){return t[a]=b,p}function i(a){return delete t[a],p}function j(a){w=!0;for(var b=0;b<v.length;b++)v[b]();v=null,q.onOpen&&q.onOpen(a)}function k(a){var b=JSON.parse(a.data),d=s[b.id],e=null;return d&&delete s[b.id],q.onMessage&&q.onMessage(b,d),"error"==b.type?void(q.onError&&q.onError(b.data)):(b.id&&t[b.id]?(e=t[b.id],delete t[b.id]):b.command&&t[b.command]&&(e=t[b.command]),void(e?e(b.data):c.log("UnknownMessage",a.data)))}function l(a){q.onClose&&q.onClose(a)}function m(a,b){return setInterval(function(){e($.extend(!0,{},b))},a)}function n(a){w?a():v.push(a)}function o(){w&&(x.close(),w=!1)}var p=this,q={},r=0,s={},t={},u=null,v=[],w=!1,x=new WebSocket(b);x.onopen=j,x.onmessage=k,x.onclose=l,$.extend(this,{useAjax:d,request:e,addEventListener:h,removeEventListener:i,polling:m,ready:n,close:o,onOpen:function(a){return q.onOpen=a,this},onClose:function(a){return q.onClose=a,this},onRequest:function(a){return q.onRequest=a,this},onMessage:function(a){return q.onMessage=a,this},onError:function(a){return q.onError=a,this}})}}),"undefined"==typeof flect&&(flect={}),$(function(){function a(){function a(a){return c[a]}function b(a,b){c[a]=b}var c={};$.extend(this,{getItem:a,setItem:b})}var b=300;flect.TemplateManager=function(c,d){function e(a){"string"==typeof a&&(a={name:a});var b=h.getItem("template."+a.name);b?g(b,a):f(a.name,function(b){h.setItem("template."+a.name,b),g(b,a)})}function f(a,b){c.request({command:"template",log:a,data:{name:a},success:b})}function g(a,c){function e(){c.afterShow&&c.afterShow(d)}i&&i(d),d.hide(),j&&j(d),d.empty(),d.html(a),c.beforeShow&&c.beforeShow(d),i=c.beforeHide,j=c.afterHide,setTimeout(function(){var a=c.direction||"right",f=c.effect;"none"==f?d.show(0,e):d.show("slide",{direction:a},b,e)},0)}var h=window.sessionStorage?window.sessionStorage:new a,i=null,j=null;$.extend(this,{show:e,loadTemplate:f})}}),"undefined"==typeof flect&&(flect={}),$(function(){flect.MessageDialog=function(a){function b(b){b=b||3,a.css({"animation-name":"fade","-webkit-animation-name":"fade","animation-duration":b+"s","-webkit-animation-duration":b+"s"}),a.show(),setTimeout(function(){if(a.hide(),a.css("animation-name",""),a.css("-webkit-animation-name",""),f=!1,g.length>0){var b=g;g=[],setTimeout(function(){c(b)},10)}else if(h.length>0){var b=h;h=[],setTimeout(function(){d(b)},10)}},1e3*b)}function c(c,d){if(f)return void g.push(c);f=!0,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var h=$("<span class='message'></span>");h.text(c[e]),a.append(h)}b(d)}function d(c,d){if(f)return void h.push(c);f=!0,d=d||3,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var g=c[e],i=$("<div class='tweet'><img/><p></p><p></p></div>");i.find("img").attr("src",g.img),i.find("p:first").text(g.username),i.find("p:last").text(g.msg),a.append(i)}b(d)}function e(a,b){d({userId:a.id,username:a.name,msg:b,img:a.imageUrl})}var f=!1,g=[],h=[];$.extend(this,{show:c,notifyTweet:d,notifyUserAction:e})}}),$(function(){function a(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}function b(a){return a.split("\n").filter(function(a){return a.length>0}).join("\n")}function c(a){return a.each(function(){var a=$(this),b=a.attr("id");b&&a.attr("name",b)}),a}function d(a){for(var b in a)delete a[b]}function e(a,b){b||(b=a.find(".option-panel"),a=a.find(".option-ctrl")),a.click(function(){var c=a.find("i");c.hasClass("fa-caret-down")?(c.removeClass("fa-caret-down").addClass("fa-caret-up"),a.addClass("active")):(c.removeClass("fa-caret-up").addClass("fa-caret-down"),a.removeClass("active")),b.slideToggle()})}function f(){function a(){var a=e.getFullYear(),b=e.getMonth()+1,c=e.getDate();return 10>b&&(b="0"+b),10>c&&(c="0"+c),a+"-"+b+"-"+c}function b(){var a=e.getHours(),b=e.getMinutes();return 10>a&&(a="0"+a),10>b&&(b="0"+b),a+":"+b}function c(){return a().substring(5)+" "+b()}function d(){return e.getTime()}var e;switch(arguments.length){case 1:e=new Date(arguments[0]);break;case 2:e=new Date(arguments[0]+" "+arguments[1])}$.extend(this,{dateStr:a,timeStr:b,datetimeStr:c,getTime:d})}function g(a){function b(b,c){c||(c=3),a.animateDialog(b,{name:"rotateZoom",duration:c+"s"})}$.extend(this,{show:b})}function h(a){function b(){return!!n.userId}function c(){return!!n.userEventId}function d(){return n.eventStatus==y.Running}function e(){return!!n.eventAdmin}function f(){return!!n.roomId}function g(){return!!n.roomAdmin}function h(){return!!n.userQuiz}function i(){return!!n.debug}function j(a,b){n.eventId=a,n.eventStatus=y.Running,n.eventAdmin=b}function k(){n.eventId=0,n.eventStatus=y.Prepared,n.userEventId=0,n.eventAdmin=!1}function l(a){n.userEventId=a}function m(){return b()&&f()&&!g()}var n=this;$.extend(this,a,{isLogined:b,isEntryEvent:c,isEventRunning:d,isEventAdmin:e,isInRoom:f,isRoomAdmin:g,isPostQuestionAllowed:h,isDebug:i,openEvent:j,closeEvent:k,entryEvent:l,canEntryEvent:m}),this.eventStatus||(this.eventStatus=y.Prepared)}function i(a){function b(){return this.imageUrl}$.extend(this,a,{getMiniImageUrl:b}),d(a)}function j(a,b){function c(a){a.find("tbody tr").click(function(){var a=$(this).attr("data-room");a&&(location.href="/room/"+a)})}function d(c,d){for(var e=c.find("tbody"),g={},h=0;h<d.length;h++){var j=d[h],k=$("<tr><td class='event-date'></td><td class='event-title'><img src='"+w+"'/></td><td class='event-capacity'></td></tr>"),l=k.find("img"),m=MSG.undecided,n=j.name,o="";j.event&&(j.event.title&&(n+="("+j.event.title+")"),j.event.status==y.Running?m=MSG.eventRunning:j.event.execDate&&(m=new f(j.event.execDate).datetimeStr()),j.event.capacity&&(o=""+j.event.capacity+MSG.people)),k.attr("data-room",j.id),k.find(".event-date").text(m),k.find(".event-title").append(n),k.find(".event-capacity").text(o),b[j.owner]?l.attr("src",b[j.owner].getMiniImageUrl()):g[j.owner]?l.attr("data-userId",j.owner):(g[j.owner]=!0,l.attr("data-userId",j.owner),a.request({command:"getUser",data:j.owner,success:function(a){var d=new i(a);b[d.id]=d,c.find("[data-userId="+d.id+"]").attr("src",d.getMiniImageUrl()).removeAttr("data-userId")}})),e.append(k)}}function e(b){{var e=$("#event-future");$("#event-yours")}a.request({command:"listRoom",data:{limit:10,offset:0},success:function(a){d(e,a),c(e),b.find(".tab-content").tabs().show()}})}function g(){}$.extend(this,{init:e,clear:g})}function k(a,b,c,d){function e(a,c){b&&d.request({command:"tweet",data:{userId:b,msg:a,twitter:c}})}function f(){return a.is(":hidden")&&$("#chat-notify").is(":checked")}function g(a){return 0==arguments.length?o.text():void o.text(a)}function h(a){j>i&&n.find("tr:last").remove();var b=j%2==0?"chat-left":"chat-right",c=$("<tr style='display:none;'><td class='chat-img'></td><td class='chat-msg'></td><td class='chat-img'></td></tr>"),d=$("<img/>"),e=c.find("td.chat-msg");e.addClass(b),e.html(a.username+"<br>"+a.msg),d.attr("src",a.img),"chat-left"==b?c.find("td.chat-img:first").append(d):c.find("td.chat-img:last").append(d),n.prepend(c),c.show("slow"),j++}var i=20,j=0,k=$("#chat-text"),l=$("#chat-twitter"),m=$("#chat-text-len"),n=a.find("table tbody"),o=$("#room-member");b&&($("#btn-tweet").click(function(){var a=k.val(),b=l.is(":checked");0==a.length||a.length>140||(k.val(c),e(a,b))}),k.keyup(function(){var a=140-k.val().length;0>=a?m.addClass("error"):m.removeClass("error"),m.text(a)})),c?"#"!=c.charAt(0)&&(c="#"+c):c="",k.val(c),$.extend(this,{member:g,append:h,tweet:e,isNotifyTweet:f})}function l(a,b,d){function f(a){return a.attr("id").substring(5)}function g(){if(m&&m.form()){var c=l||{id:-1,owner:b};j.find(":input").each(function(){var a=$(this),b=f(a);a.is(":checkbox")?c[b]=a.is(":checked"):a.val()&&(c[b]=a.val())}),d.request(l?{command:"updateRoom",data:c,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"makeRoom",data:c,success:function(a){a.id&&(d.close(),location.href="/room/"+a.id)}})}}function h(a){if(k&&!l)return void d.request({command:"getRoom",data:k,success:function(b){l=b,h(a)}});j=$("#make-room-form"),c(j.find(":input")).each(function(){var a=$(this);if(l){var b=f(a);l[b]&&(a.is(":checkbox")?a.attr("checked","checked"):a.val(l[b]))}}),m=j.validate({rules:{"room-name":{required:!0,maxlength:100},"room-tags":{maxlength:100},"room-hashtag":{maxlength:20},"room-description":{maxlength:400}},focusInvalid:!0});var b=$("#btn-make-room").click(g),i=$("#make-room-desc");l?($("#room-admin").show(),i.text(MSG.makeRoomDescForEdit),b.text(MSG.update)):($("#room-admin").hide(),i.text(MSG.makeRoomDescForCreate),b.text(MSG.create)),e(a)}function i(){j=null,m=null,k=0,l=null}var j=null,k=0,l=null,m=null;$.extend(this,{init:h,clear:i,edit:function(a){k=a}})}function m(b,c,d,e){function f(d,f){function g(a){for(var b=0;b<r.length;b++){var c=r[b];if(c.id==a)return c}return null}function h(a,f){var h=$("<tr><td class='q-creator'><img src='"+w+"'/></td><td class='q-text'></td><td class='q-publish'><button class='btn blue btn-info'>"+MSG.publish+"</button></td></tr>"),j=h.find("img");h.attr("data-id",a.id),h.find(".q-text").text(a.question),c[a.createdBy]?j.attr("src",c[a.createdBy].getMiniImageUrl()).after(c[a.createdBy].name):f[a.createdBy]?j.attr("data-userId",a.createdBy):(f[a.createdBy]=!0,j.attr("data-userId",a.createdBy),e.request({command:"getUser",data:a.createdBy,success:function(a){var b=new i(a);c[b.id]=b,d.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId").after(b.name)}})),h.click(function(){var a=$(this).attr("data-id");b.showMakeQuestion(g(a))}),s.append(h)}function j(a,b,c){e.request({command:"listQuestion",data:{published:f,offset:a,limit:b},success:function(a){var b=s.parents("table"),d={};r=a,s.empty(),c&&b.hide();for(var e=0;e<a.length;e++)h(a[e],d);c&&b.show("slide",{direction:c},v)}})}function k(){q>0&&(q-=m,j(q,m,"left"),o())}function l(){p>q+m&&(q+=m,j(q,m,"right"),o())}function n(){return 0==arguments.length?p:(p=arguments[0],this)}function o(){a($btnPrev,q>0),a($btnNext,p>q+m)}var p=0,q=0,r=[],s=d.find("table tbody");d.swipe({swipeLeft:function(a){l(),a.stopImmediatePropagation()},swipeRight:function(a){k(),a.stopImmediatePropagation()},tap:function(a,b){u&&$(b).click()}}),$.extend(this,{prev:k,next:l,load:j,count:n,activate:o})}function g(){var a=$tab.tabs("option","active");return 0==a?n:publishedTable}function h(a){e.request({command:"countQuestion",success:function(b){n.count(b.count-b.published),publishedTable.count(b.published),$("#question-stock-count").text(n.count()),$("#question-published-count").text(publishedTable.count()),a&&n.activate()}})}function j(a){n=new f($("#edit-question-stock"),!1),publishedTable=new f($("#edit-question-published"),!0),$tab=a.find(".tab-content").tabs({activate:function(){g().activate()}}),h(!0),n.load(0,m),publishedTable.load(0,m),$("#edit-question-new").click(function(){b.showMakeQuestion()}),$btnPrev=$("#edit-question-left").click(function(){g().prev()}),$btnNext=$("#edit-question-right").click(function(){g().next()})}function k(){n&&(h(g()==n),n.load(0,m))}function l(){n=null,publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null}var m=10,n=null;publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,$.extend(this,{init:j,clear:l,reload:k})}function n(d,f,g){function h(){$("#make-q-question").val(""),$("#make-q-answers").val(""),$("#make-q-answerType").val(x.FirstRow),$("#make-q-tags").val(""),$("#make-q-description").val(""),$("#make-q-relatedUrl").val("")}function i(){var a={id:0,roomId:f.roomId,createdBy:f.userId};return s&&(a.id=s.id,a.createdBy=s.createdBy),t.find(":input").each(function(){var b=$(this),c=j(b),d=b.val();"answerType"==c&&(d=parseInt(d)),a[c]=d}),a.answers=b(a.answers),a}function j(a){return a.attr("id").substring(7)}function k(){return 0==arguments.length?r:(r=arguments[0],this)}function l(){return r=0,this}function m(){if(s&&s.publishCount>0&&d.showMessage("Can not update published question"),z&&z.form()){var b=i();g.request(s?{command:"updateQuestion",data:b,success:function(){s=b,r?d.showMessage(MSG.successUpdate):d.showQuestionList("left"),a(v,!0)}}:{command:"createQuestion",data:b,success:function(b){f.isRoomAdmin()?(s=b,f.isEventAdmin()?(d.showMessage(MSG.successUpdate),u.text(MSG.update),y.show("slow"),a(v,!0)):d.showQuestionList("left")):(d.showMessage(MSG.questionPosted),h())}})}}function n(){g.request({command:"publishQuestion",data:{questionId:s.id,eventId:r,includeRanking:w.is(":checked")},success:function(a){"OK"!=a&&d.showMessage(a)}})}function o(b){a(w,b),b||w.removeAttr("checked")}function p(b){t=$("#make-q-form"),c(t.find(":input")).each(function(){var a=$(this);if(s){var b=j(a);s[b]&&a.val(s[b])}}),z=t.validate({rules:{"make-q-question":{required:!0},"make-q-answers":{quizChoices:!0,required:!0},"make-q-tags":{maxlength:100},"make-q-relatedUrl":{url:!0,maxlength:256}},focusInvalid:!0}),t.find(":input").change(function(){a(v,!1)}),u=$("#make-q-update-btn").click(m),y=$("#make-q-publish"),w=$("#make-q-includeRank"),s&&r&&y.show(),v=$("#make-q-publish-btn").click(n),e(b),s&&($("#make-q-desc").text(r?MSG.editAndPublishQuestion:MSG.editQuestion),u.text(MSG.update),s.publishCount>0&&(a(t.find(":input"),!1),a(u,!1)),s.answerType==x.NoAnswer&&o(!1)),$("#make-q-answerType").change(function(){var a=$(this).val();o(a!=x.NoAnswer)}),f.isRoomAdmin()?$("#make-q-back-btn").click(function(){d.showQuestionList("left")}).show():u.text(MSG.post)}function q(){s=null,t=null,u=null,v=null,w=null,y=null,z=null}var r=0,s=null,t=null,u=null,v=null,w=null,y=null,z=null;$.extend(this,{openEvent:k,closeEvent:l,init:p,clear:q,edit:function(a){s=a}})}function o(b,c,d){function e(a,b){$("#answer-"+a).find(".answer-cnt .count").text(b)}function f(a){a.css("background-color","#3276b1")}function g(a){a.css("background-color","#5cb85c")}function h(a){a.css("background-color","#d2322d")}function i(){if(C)for(var a=0;u>a;a++){var b=""+(a+1),c=w[b]||0;e(b,c)}C.find(".answer-cnt").show()}function j(){var e=(new Date).getTime()-A,g=$(this),h=parseInt(g.attr("id").substring(7));if(!z){if(f(g),z=!0,a(C,!1),D=g,e>t)return void b.showMessage("timeLimitExceeded");d.request({command:"answer",data:{userId:c.userId,publishId:v.id,eventId:c.eventId,userEventId:c.userEventId,answer:h,time:e}}),i()}}function k(a){var b=""+a.answer,d=(w[b]||0)+1;w[b]=d,(c.isEventAdmin()||z)&&e(b,d)}function l(){function a(){var a=-1;for(var b in w){var c=w[b]||0;0!=c&&(-1==a||a>c)&&(a=c)}return a}function b(){var a=-1;for(var b in w){var c=w[b]||0;0!=c&&c>a&&(a=c)}return a}switch(y.answerType){case x.FirstRow:for(var c=y.answers.split("\n")[0],d=0;d<C.length;d++){var e=$(C[d]);if(e.find(".answer").text()==c)return e}break;case x.Most:case x.Least:var f=y.answerType==x.Most?b():a();if(-1==f)return null;var g=[];return C.each(function(){$(this).find(".answer-cnt count").text()==f&&g.push(this)}),$(g);case x.NoAnswer:return null}throw"IllegalState: "+y.answerType}function m(a){function c(a,b){var c=!1,d=a.attr("id");return b.each(function(){d==$(this).attr("id")&&(c=!0)}),c}if(C){var d=l();if(d){if(D){var e=c(D,d);msg=e?MSG.correctAnswer:MSG.wrongAnswer,e||h(D),a&&b.showEffect(msg,1)}g(d)}if(y.description){var f=$("#publish-q-description");f.find("textarea").val(y.description),f.show()}if(y.relatedUrl){var i=$("#publish-q-url"),j=i.find("a");j.attr("href",y.relatedUrl).text(y.relatedUrl),i.show()}a?$("#publish-q-detail").show("slow"):$("#publish-q-detail").show()}}function n(a){y=a,B&&m(!0)}function o(){function b(){c--,f.css("width",c+"%"),20>c?f.removeClass("progress-bar-warning").addClass("progress-bar-danger"):60>c&&f.removeClass("progress-bar-success").addClass("progress-bar-warning"),z&&(-1==d&&(d=c+1),g.css("width",d-c+"%")),c>0?setTimeout(b,e):(a(C,!1),i(),B=!0,y&&m(!0))}var c=100,d=-1,e=t/100,f=$("#publish-q-progress"),g=$("#publish-q-progress-answered"),h=null,j=0,k=0;f.css("width","100%"),g.css("width","0%"),setTimeout(b,e),E.contents().each(function(){$(this).replaceWith($(this).text().replace(/(\S)/g,"<span>$1</span>"))}),E.append('<span class="cur">_</span>'),h=E.find(".cur"),j=setInterval(function(){h&&h.toggle()},200),k=E.children().size();for(var l=0;k>l;l++){var n=E.children("span:eq("+l+")");l==k-1?setTimeout(function(){n.hide(),clearInterval(j)},50*l+200):n.delay(50*l).fadeIn(10)}}function p(d){var e=$("#publish-q-seq");if(E=$("#publish-q-text"),$("#publish-q-none").hide(),C=d.find(".btn-question").hide(),v){e.text(MSG.format(MSG.questionSeq,v.seq));for(var f=0;f<v.answers.length;f++){var g=$("#answer-"+(f+1)).show();g.find(".answer-seq").text(f+1+"."),g.find(".answer").text(v.answers[f])}E.text(v.question)}y?(showText(),i(),a(C,!1),m(!1)):v?($(".publish-q-animation").css({"animation-name":"inout","-webkit-animation-name":"inout"}),c.isEventAdmin()?i():c.userEventId?C.click(j):a(C,!1)):($("#publish-q-default").hide(),$("#publish-q-none").show()),$("#publish-q-ranking").click(function(){b.showRanking()})}function q(){y||(A=(new Date).getTime(),o())}function r(){C=null,D=null,E=null}function s(a){v=a,w={},y=null,z=!1,A=0,B=!1}var t=1e4,u=5,v=null,w={},y=null,z=!1,A=0,B=!1,C=null,D=null,E=null;$.extend(this,{init:p,afterShow:q,clear:r,receiveAnswer:k,receiveAnswerDetail:n,setQuestion:s})}function p(a,b,c){function d(){return b.isEventRunning()&&!b.isEntryEvent()}function e(){d()&&$(".entry-event").show()}function f(){$(".entry-event").hide()}function g(d){var e={userId:b.userId,username:b.username,userImage:b.userImage,eventId:b.eventId};d&&(e.passcode=d),c.request({command:"entryEvent",data:e,success:function(c){c.error?a.showMessage(c.error):c.requirePass?a.showPasscode():c.userEventId?(b.userEventId=c.userEventId,d&&a.showChat()):alert("Invalid data: "+JSON.stringify(c))}})}function h(){d()&&(g(),$("#entry-event-alert").hide())}function i(){$("#event-passcode-btn").click(function(){var a=$("#event-passcode-user").val();g(a)}),$("#event-cancel-btn").click(function(){a.showChat()})}function j(){}$(".entry-event-btn").click(h),$("#not-entry-event").click(function(){$("#entry-event-alert").hide()}),d()&&e(),$.extend(this,{init:i,clear:j,openEvent:e,closeEvent:f})}function q(a,b,d){function g(a){if(a){for(var b in a){var c=$("#event-"+b);c.length&&c.val(a[b])}if(a.execDate){var d=new f(a.execDate);$("#event-date").val(d.dateStr()),$("#event-time").val(d.timeStr())}q.text(a.status==y.Prepared?MSG.start:MSG.finish)}else q.text(MSG.start)}function h(){var a=$("#event-date").val(),c=$("#event-time").val(),d={id:b.eventId||0,roomId:b.roomId,status:b.eventStatus};return o.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6),c=a.val();c&&(d[b]=a.val())}),a&&(c&&(a+=" "+c),d.execDate=new Date(a).getTime()),d.capacity=parseInt(d.capacity),d}function i(){$("#event-date").val(""),$("#event-time").val(""),o.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6);"capacity"!=b&&$(this).val("")})}function j(){b.eventStatus==y.Prepared&&(b.eventId?d.request({command:"openEvent",data:{id:b.eventId,admin:b.userId},success:function(b){b?(q.text(MSG.finish),a.showQuestionList()):a.showMessage(MSG.failOpenEvent)}}):l(!0))}function k(){b.isEventRunning()&&d.request({command:"closeEvent",data:b.eventId,success:function(a){a&&(i(),q.text(MSG.start))}})}function l(c){if(p&&p.form()){var e=h();console.log("updateEvent: "+JSON.stringify(e)),d.request(e.id?{command:"updateEvent",data:e,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"createEvent",data:e,success:function(d){b.eventId=d.id,b.eventStatus=d.status,c?j():a.showMessage(MSG.successUpdate)}})}}function m(a){o=a.find("form"),c(o.find(":input")),p=o.validate({rules:{"event-capacity":{required:!0,digits:!0},"event-title":{maxlength:100},"event-date":{date:!0},"event-time":{time:!0},"event-passcode":{maxlength:100},"event-description":{maxlength:400}},focusInvalid:!0}),e(a),q=$("#event-toggle-btn").click(function(){console.log("toggleBtn: "+b.eventStatus),b.eventStatus==y.Prepared?j():b.eventStatus==y.Running&&k()}),$("#event-update-btn").click(function(){l(!1)}),d.request({command:"getCurrentEvent",success:g})}function n(){o=null,p=null,q=null}var o=null,p=null,q=null;$.extend(this,{init:m,clear:n})}function r(a,b,c,d){function e(a,b,d){for(var e=$("<tr></tr>"),g=0;g<b.length;g++){var h=$("<td></td>"),j=b[g];if(h.addClass(j),"username"==j&&a.username){var k=$("<img/>");k.attr("src",a.imageUrl),h.append(k),h.append(a.username)}else"title"==j?h.text(a.title||new f(a.execDate).datetimeStr()):"rank"==j?h.text(d):"time"==j&&a.time?h.text(a.time+"ms"):a[j]&&h.text(a[j]);e.append(h)}return c[a.userId]||(c[a.userId]=new i({id:a.userId,name:a.username,imageUrl:a.imageUrl})),e}function g(a,b,c){var d=a.find("tbody"),f={};if(d.empty(),c&&q)for(var g=0;g<q.length;g++){var h=q[g],i=e(h,n,g+11);f[h.userId]=i,d.append(i)}for(var g=0;g<b.length;g++){var h=b[g],i=f[h.userId];i?(i.find(".rank").text(g+1),i.find(".correctCount").text(h.correctCount),i.find(".time").text(h.time+"ms")):(i=e(h,n,g+1),d.append(i)),i.addClass("new")}c&&(setTimeout(function(){a.tableSort({sortBy:["numeric","nosort","nosort","nosort"]}),a.find("thead th:first").click(),setTimeout(function(){var a=d.find("tr").not(".new");a.hide("slow",function(){a.remove()})},200)},200),q=b,r=null)}function h(a){var b=$("#ranking-event-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],f=e(d,o);b.append(f)}}function j(a){var b=$("#ranking-total-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],f=e(d,p,c+1);b.append(f)}}function k(){t=$("#ranking-now-tbl"),b.isEventRunning()?d.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(a){a.length&&(r=a,s.show())}}):$("#ranking-now").hide(),d.request({command:"getEventWinners",data:{roomId:b.roomId,limit:10},success:h}),d.request({command:"getTotalRanking",data:{roomId:b.roomId,limit:10},success:j}),s=$("#ranking-tab").tabs().show()}function l(){r&&g(t,r,!0)}function m(){s=null,t=null,console.log("Ranking#clear")}var n=["rank","username","correctCount","time"],o=["title","username","correctCount","time"],p=["rank","username","point","correctCount"],q=null,r=null,s=null,t=null;$.extend(this,{init:k,afterShow:l,clear:m})}function s(){function a(a,b,d){c&&c.log(a,b,d)}function b(a){c=a}var c=null;$.extend(this,{log:a,setImpl:b})}function t(a,b){function c(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),f>d&&e.find("tr:first").remove();var g=$("<tr><td></td><td></td><td><div class='pull-right'></div></td></tr>"),h=g.find("td");$(h.get(0)).text(a),$(h.get(1)).text(b),c&&$(h.get(2)).find("div").text(c),e.append(g),f++,console.log(a+", "+b+(c?", "+c+"ms":""))}var d=10,e=a.find("table tbody"),f=0;b.onRequest(function(a,b){var d=a;b&&(d+=", "+JSON.stringify(b)),c("send",d)}).onMessage(function(a,b){var d=(new Date).getTime();c("receive",JSON.stringify(a),d-b)}),$("#chk-use-ajax").bootstrapSwitch().on("switchChange",function(){var a=$(this).is(":checked");b.useAjax(a?"/ajax":!1)}),$("#btn-debug-msg").click(function(){$("#effect-dialog").animateDialog("Start!",{name:"rotateZoom"});var a=$(".publish-q-animation");a.css({"animation-name":"inout","-webkit-animation-name":"inout"}),a.hide(),setTimeout(function(){a.show()},0)}),$.extend(this,{log:c})}$.validator.addMethod("quizChoices",function(a){if(!a||0==a.length)return!1;var b=a.split("\n").filter(function(a){return a.length>0});return b.length<=1||b.length>5?!1:!0},MSG.invalidQuizChoices),$.validator.addMethod("time",function(a,b){return this.optional(b)||/^\d{2}:\d{2}$/.test(a)},MSG.invalidTime);var u="ontouchstart"in window,v=300,w="/assets/images/twitter_default_profile.png",x={FirstRow:0,Most:1,Least:2,NoAnswer:3},y={Prepared:0,Running:1,Finished:2};flect.QuizApp=function(a){function b(a,b){function c(){d.is(":visible")||(Q.children("div").hide(),d.show("slide",{direction:"right"},v))}var d=$("#"+a);b?$.sidr("close",c):c()}function c(){b("chat",!1)}function d(a){if(O){var b={name:"publish-question",effect:"none",beforeShow:function(b){a&&O.setQuestion(a),O.init(b)},afterShow:O.afterShow,afterHide:O.clear};Q.children("div").hide(),L.show(b)}}function e(){Q.children("div").hide(),L.show(U.ranking)}function f(a){if(N){var b=$.extend({name:"edit-question"},U["edit-question"]);a&&(b.direction=a),Q.children("div").hide(),L.show(b)}}function w(a){H&&(a&&H.edit(a),Q.children("div").hide(),L.show({name:"make-question",beforeShow:H.init,afterHide:H.clear}))}function x(){K&&(Q.children("div").hide(),L.show({name:"passcode",beforeShow:K.init,afterHide:K.clear}))}function y(a,b){D.show(a,b)}function z(a,b){E.show(a,b)}function A(a,b){M&&M.tweet(a,b)}function B(){if(window.sessionStorage&&sessionStorage.clear(),C=new s,D=new flect.MessageDialog($("#msg-dialog")),E=new g($("#effect-dialog")),F=new flect.Connection(S.uri,C),G=new j(F,T),I=new l(app,S.userId,F),L=new flect.TemplateManager(F,$("#content-dynamic")),Q=$("#content"),S.isDebug()&&(C.setImpl(new t($("#debug"),F,D)),$("#btn-debug").click(function(){return b("debug",!0),!1}),F.onError(function(a){console.log(a),alert(a)})),S.isLogined()&&(T[S.userId]=new i({id:S.userId,name:S.username,imageUrl:S.userImage})),S.isInRoom()){var a=$("#chat");M=new k(a,S.userId,S.hashtag,F),$(".menu-chat").click(function(){return b("chat",$(this).parents("#sidr").length>0),!1}),$("#toolbar-ranking").click(function(){return e(),!1}),$("#toolbar-question").click(function(){return S.isEventAdmin()?f():d(),!1}),F.addEventListener("chat",function(a){M.append(a),a.userId!=S.userId&&M.isNotifyTweet()&&D.notifyTweet(a)}),F.addEventListener("member",M.member),F.addEventListener("newEntry",function(a){var b=new i(a);T[b.id]=b,D.notifyUserAction(b,MSG.newEntry)}),F.ready(function(){0==M.member()&&F.request({command:"member"})}),F.addEventListener("startEvent",function(a){var b=a.id,c=a.admin;E.show(MSG.start),S.openEvent(b,c==S.userId),H&&H.openEvent(S.eventId),K&&setTimeout(K.openEvent,3e3)}),F.addEventListener("finishEvent",function(){E.show(MSG.finish),S.closeEvent(),H&&H.closeEvent(),K&&K.closeEvent()}),O=new o(R,S,F),F.addEventListener("question",function(a){d(a)}),F.addEventListener("answer",O.receiveAnswer),F.addEventListener("answerDetail",O.receiveAnswerDetail),P=new r(R,S,T,F)}$("#home").length&&F.ready(function(){G.init($("#home"))}),(S.isRoomAdmin()||S.isPostQuestionAllowed())&&(H=new n(R,S,F),S.isEventRunning()&&H.openEvent(S.eventId)),S.isRoomAdmin()&&(N=new m(R,T,S.userId,F),J=new q(R,S,F),F.addEventListener("postQuestion",function(a){var b=a,c=T[b];N.reload(),c?D.notifyUserAction(c,MSG.postQuestionMessage):F.request({command:"getUser",data:b,success:function(a){var b=new i(a);T[b.id]=b,D.notifyUserAction(b,MSG.postQuestionMessage)}})})),S.canEntryEvent()&&(K=new p(R,S,F)),$("#btn-menu").sidr({onOpen:function(){$("#toolbar").css("left","260px").find(".header-center").hide()},onClose:function(){$("#toolbar").css("left","0px").find(".header-center").show()}}),$("#content").swipe({swipeLeft:function(){$.sidr("close")},swipeRight:function(){$.sidr("open")},tap:function(a,b){u&&$(b).click()}}),F.polling(25e3,{command:"noop",log:"user="+(S.isLogined()?S.username:"(Anonymous)")}),$("#sidr a.dynamic").click(function(){var a=$(this).attr("href").substring(1),b=$.extend({name:a},U[a]);return $.sidr("close",function(){Q.children("div").hide(),L.show(b)}),!1}),$(".dropdown-button").click(function(){return $(this).next("ul").toggle(),!1}),$(".dropdown-menu a").click(function(){var a=$(this);return a.parents(".dropdown-menu").hide(),"#"!=a.attr("href")})}var C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R=this,S=new h(a),T={};B(),C.log("params",S),console.log("eventAdmin: "+S.eventAdmin);var U={home:{beforeShow:G.init,afterHide:G.clear},"make-room":{beforeShow:function(a){I.clear(),I.init(a)},afterHide:I.clear},"edit-room":{name:"make-room",beforeShow:function(a){I.clear(),I.edit(S.roomId),I.init(a)},afterHide:I.clear}};S.isRoomAdmin()?($.extend(U,{"edit-question":{beforeShow:N.init,afterHide:N.clear}}),$.extend(U,{"edit-event":{beforeShow:J.init,afterHide:J.clear}})):S.isPostQuestionAllowed()&&$.extend(U,{"post-question":{name:"make-question",beforeShow:H.init,afterHide:H.clear}}),S.isInRoom()&&$.extend(U,{"publish-question":{name:"publish-question",beforeShow:O.init,afterHide:O.clear},ranking:{name:"ranking",beforeShow:P.init,afterShow:P.afterShow,afterHide:P.clear}}),$.extend(this,{showQuestionList:f,showMakeQuestion:w,showPasscode:x,showChat:c,showRanking:e,showQuestion:d,showMessage:y,showEffect:z,tweet:A})}});