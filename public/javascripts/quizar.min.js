/*! quizar 2014-03-27 */
"undefined"==typeof flect&&(flect={}),$(function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}flect.Connection=function(b,c){function d(){if(0==arguments.length)return y;var a=arguments[0];return y=a?a:null,t}function e(a){return u.onRequest&&u.onRequest(a.command,a.data),y?f(a):g(a),t}function f(b){c.log("ajax",b.command);var d=(new Date).getTime(),e=++v,f=b.url?b.url:y,g=b.success;if(b.command&&(a(f,"/")||(f+="/"),f+=b.command,delete b.command),f+="?id="+e,b.log&&(f+="&log="+b.log,delete b.log),b.url=f,b.type||(b.type="POST"),b.data){var h=JSON.stringify(b.data);b.data={data:h}}b.success=function(a){if(u.onMessage&&u.onMessage(a,d),a){if("error"==a.type)return void(u.onServerError&&u.onServerError(a.data));var c=g;c||(c=x[b.command]),c&&c(a.data)}},$.ajax(b)}function g(a){c.log("ws",a.command);var b=(new Date).getTime(),d=++v;w[d]=b,a.success&&(x[d]=a.success);var e={id:d,command:a.command,data:a.data};a.log&&(e.log=a.log),socket.send(JSON.stringify(e))}function h(a,b){return x[a]=b,t}function i(a){return delete x[a],t}function j(a){A=0;for(var b=0;b<z.length;b++)z[b]();z=[],u.onOpen&&u.onOpen(a)}function k(a){var b=JSON.parse(a.data),d=w[b.id],e=null;return d&&delete w[b.id],u.onMessage&&u.onMessage(b,d),"error"==b.type?void(u.onServerError&&u.onServerError(b.data)):(b.id&&x[b.id]?(e=x[b.id],delete x[b.id]):b.command&&x[b.command]&&(e=x[b.command]),void(e?e(b.data):c.log("UnknownMessage",a.data)))}function l(a){u.onClose&&u.onClose(a),s>A&&(A++,setTimeout(function(){socket=r()},1e3*A))}function m(a){u.onSocketError&&u.onSocketError(a)}function n(a,b){return setInterval(function(){q()&&e($.extend(!0,{},b))},a)}function o(a){q()?a():z.push(a)}function p(){q()&&(A=s,socket.close())}function q(){return 1==socket.readyState}function r(){var a=new WebSocket(b);return a.onopen=j,a.onmessage=k,a.onerror=m,a.onclose=l,a}var s=5,t=this,u={},v=0,w={},x={},y=null,z=[],A=0;socket=r(),$.extend(this,{useAjax:d,request:e,addEventListener:h,removeEventListener:i,polling:n,ready:o,close:p,isConnected:q,onOpen:function(a){return u.onOpen=a,this},onClose:function(a){return u.onClose=a,this},onRequest:function(a){return u.onRequest=a,this},onMessage:function(a){return u.onMessage=a,this},onSocketError:function(a){return u.onSocketError=a,this},onServerError:function(a){return u.onServerError=a,this}})}}),"undefined"==typeof flect&&(flect={}),$(function(){function a(){function a(a){return c[a]}function b(a,b){c[a]=b}var c={};$.extend(this,{getItem:a,setItem:b})}var b=300;flect.TemplateManager=function(c,d){function e(a){"string"==typeof a&&(a={name:a});var b=a.name;"function"==typeof b&&(b=b());var c=h.getItem("template."+b);c?g(c,a):f(b,function(c){h.setItem("template."+b,c),g(c,a)})}function f(a,b){c.request({command:"template",log:a,data:{name:a},success:b})}function g(a,c){function e(){c.afterShow&&c.afterShow(d)}i&&i(d),d.hide(),j&&j(d),d.empty(),d.html(a),c.beforeShow&&c.beforeShow(d),i=c.beforeHide,j=c.afterHide,setTimeout(function(){var a=c.direction||"right",f=c.effect;"none"==f?d.show(0,e):d.show("slide",{direction:a},b,e)},0)}var h=window.sessionStorage?window.sessionStorage:new a,i=null,j=null;$.extend(this,{show:e,loadTemplate:f})}}),"undefined"==typeof flect&&(flect={}),$(function(){flect.MessageDialog=function(a){function b(b){b=b||3,a.css({"animation-name":"fade","-webkit-animation-name":"fade","animation-duration":b+"s","-webkit-animation-duration":b+"s"}),a.show(),setTimeout(function(){if(a.hide(),a.css("animation-name",""),a.css("-webkit-animation-name",""),f=!1,g.length>0){var b=g;g=[],setTimeout(function(){c(b)},10)}else if(h.length>0){var b=h;h=[],setTimeout(function(){d(b)},10)}},1e3*b)}function c(c,d){if(f)return void g.push(c);f=!0,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var h=$("<span class='message'></span>");h.text(c[e]),a.append(h)}b(d)}function d(c,d){if(f)return void h.push(c);f=!0,d=d||3,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var g=c[e],i=$("<div class='tweet'><img/><p></p><p></p></div>");i.find("img").attr("src",g.img),i.find("p:first").text(g.username),i.find("p:last").text(g.msg),a.append(i)}b(d)}function e(a,b){d({userId:a.id,username:a.name,msg:b,img:a.imageUrl})}var f=!1,g=[],h=[];$.extend(this,{show:c,notifyTweet:d,notifyUserAction:e})}}),$(function(){function a(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}function b(a){return a.split("\n").filter(function(a){return a.length>0}).join("\n")}function c(a){return a.each(function(){var a=$(this),b=a.attr("id");b&&a.attr("name",b)}),a}function d(a){for(var b in a)delete a[b]}function e(a,b){b||(b=a.find(".option-panel"),a=a.find(".option-ctrl")),a.click(function(){var c=a.find("i");c.hasClass("fa-caret-down")?(c.removeClass("fa-caret-down").addClass("fa-caret-up"),a.addClass("active")):(c.removeClass("fa-caret-up").addClass("fa-caret-down"),a.removeClass("active")),b.slideToggle()})}function f(a){return Math.round(a/10)/100}function g(a,b){a.show("slide",{direction:b},C)}function h(){function a(){var a=e.getFullYear(),b=e.getMonth()+1,c=e.getDate();return 10>b&&(b="0"+b),10>c&&(c="0"+c),a+"-"+b+"-"+c}function b(){var a=e.getHours(),b=e.getMinutes();return 10>a&&(a="0"+a),10>b&&(b="0"+b),a+":"+b}function c(){return a().substring(5)+" "+b()}function d(){return e.getTime()}var e;switch(arguments.length){case 1:e=new Date(arguments[0]);break;case 2:e=new Date(arguments[0]+" "+arguments[1])}$.extend(this,{dateStr:a,timeStr:b,datetimeStr:c,getTime:d})}function i(a,b){function c(){var a=0,b=Number.MAX_VALUE;for(var c in m)b>c&&(b=c),a++;a>k&&delete m[c]}function d(a){switch(a){case"home":return"/home";case"mypage":return"/mypage";case"user-setting":return"/userSetting";case"make-room":return"/makeRoom";case"help":return"/help";case"publish-question":return j+"/question";case"ranking":return j+"/ranking";case"edit-room":return j+"/editRoom";case"edit-event":return j+"/event";case"edit-question":return j+"/questionList";case"post-question":return j+"/postQuestion";case"chat":return j+"/chat";case"debug":return j}return null}function e(a){g({method:"dynamic",id:a},d(a))}function f(a){g({method:"static",id:a},d(a))}function g(a,b){l&&(a.seq=null==n?1:n.seq+1,"function"==a.method&&(c(),m[a.seq]=a.func,delete a.func),n=a,history.pushState(a,null,b))}function h(a,b){return null==a||null==b?!1:"lookback"!=a.method||"dynamic"!=b.method?!1:a.seq<=b.seq?!1:!0}function i(b){var c=b.originalEvent.state;if(c||n){l=!1;try{if(null==c)a.showInitial(!1);else if("dynamic"==c.method)h(n,c)?a.backToMypage():a.showDynamic(c.id);else if("static"==c.method)a.showStatic(c.id);else if("function"==c.method){var d=m[c.seq];d&&d()}else"lookback"==c.method?a.showLookback(c.qa):console.log("popState: "+JSON.stringify(c))}finally{n=c,l=!0}}}var j="/room/"+b.roomId,k=20,l=!0,m={},n=null;$(window).on("popstate",i),$.extend(this,{pushState:g,pushDynamic:e,pushStatic:f})}function j(b,c,d,e){function f(){l>0&&(l-=e,d(l,e,!1),h())}function g(){c>l+e&&(l+=e,d(l,e,!0),h())}function h(){a(m,l>0),a(n,c>l+e)}function i(){return 0==arguments.length?c:(c=arguments[0],this)}function j(){return{swipeLeft:function(a){g(),a.stopImmediatePropagation()},swipeRight:function(a){f(),a.stopImmediatePropagation()},tap:function(a,b){B&&$(b).click()}}}function k(){m=null,n=null}var l=0,m=b.find(".paging-bar-left"),n=b.find(".paging-bar-right");e=e||10,m.click(f),n.click(g),h(),$.extend(this,{prev:f,next:g,recordCount:i,swipeParams:j,release:k})}function k(a){function b(b,c){c||(c=5),a.animateDialog(b,{name:"rotateZoom",duration:c+"s"})}$.extend(this,{show:b})}function l(a){function b(){return!!o.userId}function c(){return!!o.userEventId}function d(){return o.eventStatus==F.Running}function e(){return!!o.eventAdmin}function f(){return!!o.roomId}function g(){return!!o.roomAdmin}function h(){return!!o.userQuiz}function i(){return!!o.debug}function j(a,b){o.eventId=a,o.eventStatus=F.Running,o.eventAdmin=b}function k(){o.eventId=0,o.eventStatus=F.Prepared,o.userEventId=0,o.eventAdmin=!1}function l(a){o.userEventId=a}function m(){return b()&&f()&&!g()}function n(a){this.notifyTweet=a,$.cookie("notifyTweet",a?1:0,{path:"/",expires:100})}var o=this;$.extend(this,a,{isLogined:b,isEntryEvent:c,isEventRunning:d,isEventAdmin:e,isInRoom:f,isRoomAdmin:g,isPostQuestionAllowed:h,isDebug:i,openEvent:j,closeEvent:k,entryEvent:l,canEntryEvent:m,setNotifyTweet:n}),this.eventStatus||(this.eventStatus=F.Prepared),this.notifyTweet=1==$.cookie("notifyTweet"),n(this.notifyTweet)}function m(a){function b(){return this.imageUrl}function c(){return this.imageUrl.replace("_mini","_normal")}function e(){return this.imageUrl.replace("_mini","_bigger")}$.extend(this,a,{getMiniImageUrl:b,getNormalImageUrl:c,getBiggerImageUrl:e}),d(a)}function n(a,b,c){function d(){var a=$(this).attr("data-id");a&&(location.href="/room/"+a)}function e(){var a=n.tabs("option","active"),b=$(0==a?"#event-future":"#event-yours");$("#event-detail").hide(),g(b,"left")}function f(a){$("#room-detail-enter").attr("data-id",a.id),$("#room-detail-name").text(a.name),a.userQuiz&&$("#room-detail-userQuiz").attr("checked","checked"),$("#room-detail-description").text(a.description||""),a.event?($("#room-detail-event").show(),$("#room-detail-title").text(a.event.title||"-"),$("#room-detail-date").text(a.event.execDate?new h(a.event.execDate).datetimeStr():"-"),$("#room-detail-capacity").text(MSG.format(MSG.numberWithPeople,a.event.capacity)),$("#room-detail-description2").text(a.event.description||"")):$("#room-detail-event").hide(),n.find(".tab-pane").hide(),g($("#event-detail"),"right")}function i(a){a.find("tbody tr").click(function(){var a=$.data(this,"room");return a&&f(a),!1}),a.find("tbody tr button").click(function(){var a=$.data($(this).parents("tr")[0],"room");return a&&(location.href="/room/"+a.id),!1})}function j(c,d){for(var e=c.find("tbody"),f={},g=0;g<d.length;g++){var i=d[g],j=$("<tr><td class='event-date'></td><td class='event-title'><img src='"+D+"'/></td><td class='event-capacity'></td><td class='event-enter'><button class='btn blue'>"+MSG.enter+"</button></td></tr>"),k=j.find("img"),l=MSG.undecided,n=i.name,o="";i.event&&(i.event.title&&(n+="("+i.event.title+")"),i.event.status==F.Running?(l=MSG.eventRunning,j.find(".event-date").addClass("in-session")):i.event.execDate&&(l=new h(i.event.execDate).datetimeStr()),i.event.capacity&&(o=""+i.event.capacity+MSG.people)),j.attr("data-room",i.id),j.find(".event-date").text(l),j.find(".event-title").append(n),j.find(".event-capacity").text(o),b[i.owner]?k.attr("src",b[i.owner].getMiniImageUrl()):f[i.owner]?k.attr("data-userId",i.owner):(f[i.owner]=!0,k.attr("data-userId",i.owner),a.request({command:"getUser",data:i.owner,success:function(a){var d=new m(a);b[d.id]=d,c.find("[data-userId="+d.id+"]").attr("src",d.getMiniImageUrl()).removeAttr("data-userId")}})),$.data(j[0],"room",i),e.append(j)}}function k(b){var f=$("#event-future"),g=$("#event-yours");a.request({command:"listRoom",data:{limit:10,offset:0},success:function(a){j(f,a),i(f),n=b.find(".tab-content").tabs({beforeActivate:function(){n.find(".tab-pane").hide()}}).show()}}),c&&a.request({command:"listRoom",data:{limit:10,offset:0,userId:c},success:function(a){j(g,a),i(g)}}),$("#room-detail-enter").click(d),$("#room-detail-back").click(e)}function l(){n=null}var n=null;$.extend(this,{init:k,clear:l})}function o(a,b,c,d){function e(){var c=$("#user-name").val();c&&c!=b.username&&d.request({command:"updateUser",data:{userId:b.userId,name:c},success:function(c){c&&(a.showMessage(MSG.successUpdate),setTimeout(function(){var a=b.isInRoom()?"/room/"+b.roomId:"/";location.href=a},3e3))}})}function f(){$("#user-name").val(b.username),b.notifyTweet&&$("#user-notify-tweet").attr("checked","checked"),$("#user-notify-tweet").change(function(){var a=$(this).is(":checked");b.setNotifyTweet(a)}),$("#btn-user-setting").click(e)}function g(){}$.extend(this,{init:f,clear:g})}function p(a,b,c,d){function e(a,b,d){a.empty();for(var e=0;e<d.length;e++){for(var f=d[e],g=$("<tr></tr>"),i=0;i<b.length;i++){var j=b[i],k=$("<td></td>");if(k.addClass(j),"r-room"==j){var l=$("<img/>");l.attr("src",f.ownerImage),k.append(l),k.append(f.roomName)}else if("r-title"==j)k.text(f.title||new h(f.execDate).datetimeStr());else if("r-point"==j)k.text(f.point);else if("r-correct"==j)k.text(f.correctCount);else if("r-event"==j)k.text(f.eventCount);else if("r-question"==j)k.text(f.questionCount);else if("q-text"==j)k.text(f.question);else if("r-member"==j)k.text(MSG.format(MSG.numberWithPeople,f.userCount));else if("r-publish"==j)k.text(f.publishCount);else if("q-correct"==j&&f.userAnswer){var n=f.correct?"fa-circle-o":"fa-times",o=$("<i class='fa'></i>");o.addClass(n),k.append(o)}f.owner&&!c[f.owner]&&(c[f.owner]=new m({id:f.owner,name:f.ownerName,imageUrl:f.ownerImage})),g.append(k)}a.append(g),$.data(g[0],"obj",f)}}function f(a,b){var c=$("#mypage-events tbody");$("#mypage-events-roomName").text(a.name),$("#mypage-events-total").text(a.rank?a.rank:"-"),e(c,u,b),c.find("tr").click(n)}function i(){var a=$.data(this,"obj"),c=$("#mypage-events-total");c.text("-"),d.request({command:"getUserEvent",data:{roomId:a.roomId,userId:b.userId},success:function(b){var c=$("#mypage-events"),d=c.find("tbody");z=b,$("#mypage-events-roomName").text(a.roomName),e(d,u,b),x.find(".tab-pane").hide(),d.find("tr").click(n),g(c,"right")}}),d.request({command:"getUserTotalRanking",data:{roomId:a.roomId,userId:b.userId},success:function(b){b&&c.text(MSG.format(MSG.numberWithRank,b)),y={id:a.roomId,name:a.roomName,rank:b}}})}function j(a,b){var c=$("#mypage-owners-events tbody");$("#mypage-owners-events-roomName").text(a.name),e(c,v,b),c.find("tr").click(n)}function k(){var a=$.data(this,"obj");$("#mypage-owners-events-roomName").text(a.roomName),d.request({command:"getEventWithCount",data:a.roomId,success:function(b){for(var c=$("#mypage-owners-events"),d=c.find("tbody"),f=[],h=0;h<b.length;h++){var i=b[h].event;i.eventId=i.id,i.userCount=b[h].userCount,i.publishCount=b[h].publishCount,f.push(i)}y={id:a.roomId,name:a.roomName},z=f,e(d,v,f),x.find(".tab-pane").hide(),d.find("tr").click(n),g(c,"right")}})}function l(a){var b=$("#mypage-questions tbody");e(b,w,a),b.find("tr").click(o)}function n(){var a=$.data(this,"obj");console.log("test1: "+a.eventId),d.request({command:"getEventQuestions",data:{eventId:a.eventId,userId:b.userId},success:function(a){var b=$("#mypage-questions"),c=b.find("tbody");A=a,e(c,w,a),c.find("tr").click(o),x.find(".tab-pane").hide(),g(b,"right")}})}function o(){var b=$.data(this,"obj");d.request({command:"getLookback",data:b.publishId,success:function(c){c.userAnswer=b.userAnswer,a.showLookback(c)}})}function p(a){x=a.find(".tab-content").tabs({beforeActivate:function(){x.find(".tab-pane").hide()}}).show(),d.request({command:"entriedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-entries tbody");e(b,s,a),b.find("tr").click(i)}}),d.request({command:"ownedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-owners tbody");e(b,t,a),b.find("tr").click(k)}}),$("#mypage-events-back").click(function(){y=null,z=null,x.find(".tab-pane").hide(),g($("#mypage-entries"),"left")}),$("#mypage-owners-events-back").click(function(){y=null,z=null,x.find(".tab-pane").hide(),g($("#mypage-owners"),"left")}),$("#mypage-questions-back").click(function(){A=null,x.find(".tab-pane").hide(),y.rank?g($("#mypage-events"),"left"):g($("#mypage-owners-events"),"left")}),y&&z&&(y.rank||x.tabs("option","active",1),x.find(".tab-pane").hide(),y.rank?f(y,z):j(y,z),A?(l(A),$("#mypage-questions").show()):y.rank?$("#mypage-events").show():$("#mypage-owners-events").show())}function q(){x=null}function r(){y=null,z=null,A=null}var s=["r-room","r-point","r-correct"],t=["r-room","r-event","r-question"],u=["r-title","r-point","r-correct"],v=["r-title","r-member","r-publish"],w=["q-text","q-correct"],x=null,y=null,z=null,A=null;$.extend(this,{init:p,clear:q,reset:r})}function q(a,b,c){function d(a,b){k&&c.request({command:"tweet",data:{userId:k,msg:a,twitter:b}})}function e(){return a.is(":hidden")&&b.notifyTweet}function f(a){return 0==arguments.length?r.text():void r.text(a)}function g(a){j>i&&q.find("li:first").remove();var b=a.userId==k?"align-left":"align-right",c=$("<li style='display:none;'><div class='contributor'><img/><span/></div><div class='balloon'><div class='balloon-border'><p class='text'></p></div></div></li>"),d=c.find("img"),e=c.find(".contributor span"),f=c.find(".text");c.addClass(b),e.text(a.username),d.attr("src",a.img),f.text(a.msg),q.append(c),c.show("slow",function(){p.scrollTop(p[0].scrollHeight-p.height())})}function h(){var b=$(window).height(),c=0;a.children("div").each(function(){var a=$(this),b=a.height();a.hasClass("tweet-box")||b>0&&(c+=b)}),c+=$("#toolbar").height(),c+=$("#tabbar").height(),p.css("height",b-c-20)}var i=20,j=0,k=b.userId,l=b.hashtag,m=$("#chat-text"),n=$("#chat-twitter"),o=$("#chat-text-len span"),p=a.find(".tweet-box"),q=p.find("ul"),r=$("#room-member");k&&($("#btn-tweet").click(function(){var a=m.val(),b=n.is(":checked");0==a.length||a.length>140||a==l||(m.val(l),d(a,b))}),m.keyup(function(){var a=140-m.val().length;0>=a?o.addClass("error"):o.removeClass("error"),o.text(a)})),l?"#"!=l.charAt(0)&&(l="#"+l):l="",m.val(l),m.keyup(),$.extend(this,{member:f,append:g,tweet:d,isNotifyTweet:e,calcHeight:h})}function r(a,b,d){function f(a){return a.attr("id").substring(5)}function g(){if(m&&m.form()){var c=l||{id:-1,owner:b};j.find(":input").each(function(){var a=$(this),b=f(a);a.is(":checkbox")?c[b]=a.is(":checked"):a.val()&&(c[b]=a.val())}),d.request(l?{command:"updateRoom",data:c,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"makeRoom",data:c,success:function(a){a.id&&(d.close(),location.href="/room/"+a.id)}})}}function h(a){if(k&&!l)return void d.request({command:"getRoom",data:k,success:function(b){l=b,h(a)}});j=$("#make-room-form"),c(j.find(":input")).each(function(){var a=$(this);if(l){var b=f(a);l[b]&&(a.is(":checkbox")?a.attr("checked","checked"):a.val(l[b]))}}),m=j.validate({rules:{"room-name":{required:!0,maxlength:100},"room-tags":{maxlength:100},"room-hashtag":{maxlength:20},"room-description":{maxlength:400}},focusInvalid:!0});var b=$("#btn-make-room").click(g),i=$("#make-room-desc");l?($("#room-admin").show(),i.text(MSG.makeRoomDescForEdit),b.text(MSG.update)):($("#room-admin").hide(),i.text(MSG.makeRoomDescForCreate),b.text(MSG.create)),e(a)}function i(){j=null,m=null,k=0,l=null}var j=null,k=0,l=null,m=null;$.extend(this,{init:h,clear:i,edit:function(a){k=a}})}function s(b,c,d,e){function f(f,g){function h(a){for(var b=0;b<s.length;b++){var c=s[b];if(c.id==a)return c}return null}function i(a,i){var j=$("<tr><td class='q-creator'><img src='"+D+"'/></td><td class='q-text'></td>"+(g?"<td class='q-answerer'></td>":"<td class='q-publish'><button class='btn blue'>"+MSG.publish+"</button></td>")+"</tr>"),k=j.find("img");if(j.attr("data-id",a.id),j.attr("data-at",a.answerType),j.find(".q-text").text(a.question),c[a.createdBy]?k.attr("src",c[a.createdBy].getMiniImageUrl()).after(c[a.createdBy].name):i[a.createdBy]?k.attr("data-userId",a.createdBy):(i[a.createdBy]=!0,k.attr("data-userId",a.createdBy),e.request({command:"getUser",data:a.createdBy,success:function(a){var b=new m(a);c[b.id]=b,f.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId").after(b.name)}})),g){var l=a.correctCount+"/"+a.publishCount;j.find(".q-answerer").text(l),publishedQuestions[a.id]&&j.addClass("q-published")}else d.isEventRunning()?j.find("button").click(function(){var a=$(this).parents("tr"),c=parseInt(a.attr("data-id")),f=a.attr("data-at");e.request({command:"publishQuestion",data:{questionId:c,eventId:d.eventId,includeRanking:f!=E.NoAnswer},success:function(a){"OK"!=a&&b.showMessage(a)}})}):j.find("button").attr("disabled","disabled").removeClass("blue").addClass("disabled");j.click(function(){var a=$(this).attr("data-id");b.showMakeQuestion(h(a))}),t.append(j)}function j(a,b,c){e.request({command:"listQuestion",data:{published:g,offset:a,limit:b},success:function(a){var b=t.parents("table"),d={};s=a,t.empty(),c&&b.hide();for(var e=0;e<a.length;e++)i(a[e],d);c&&b.show("slide",{direction:c},C)}})}function k(){r>0&&(r-=l,j(r,l,"left"),p())}function n(){q>r+l&&(r+=l,j(r,l,"right"),p())}function o(){return 0==arguments.length?q:(q=arguments[0],this)}function p(){a($btnPrev,r>0),a($btnNext,q>r+l)}var q=0,r=0,s=[],t=f.find("table tbody");f.swipe({swipeLeft:function(a){n(),a.stopImmediatePropagation()},swipeRight:function(a){k(),a.stopImmediatePropagation()},tap:function(a,b){B&&$(b).click()}}),$.extend(this,{prev:k,next:n,load:j,count:o,activate:p})}function g(){var a=$tab.tabs("option","active");return 0==a?n:publishedTable}function h(a){e.request({command:"countQuestion",success:function(b){n.count(b.count-b.published),publishedTable.count(b.published),$("#question-stock-count").text(n.count()),$("#question-published-count").text(publishedTable.count()),a&&n.activate()}})}function i(a){n=new f($("#edit-question-stock"),!1),publishedTable=new f($("#edit-question-published"),!0),$tab=a.find(".tab-content").tabs({activate:function(){g().activate()}}),h(!0),d.isEventRunning()&&e.request({command:"getPublishedQuestions",data:d.eventId,success:function(a){for(var b=0;b<a.length;b++)publishedQuestions[a[b]]=!0}}),n.load(0,l),publishedTable.load(0,l),$("#edit-question-new").click(function(){b.showMakeQuestion()}),$btnPrev=$("#edit-question-left").click(function(){g().prev()}),$btnNext=$("#edit-question-right").click(function(){g().next()})}function j(){n&&(h(g()==n),n.load(0,l))}function k(){n=null,publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={}}var l=10,n=null;publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={},$.extend(this,{init:i,clear:k,reload:j})}function t(d,f,g){function h(){$("#make-q-question").val(""),$("#make-q-answers").val(""),$("#make-q-answerType").val(E.FirstRow),$("#make-q-tags").val(""),$("#make-q-description").val(""),$("#make-q-relatedUrl").val("")}function i(){var a={id:0,roomId:f.roomId,createdBy:f.userId};return s&&(a.id=s.id,a.createdBy=s.createdBy),t.find(":input").each(function(){var b=$(this),c=j(b),d=b.val();"answerType"==c&&(d=parseInt(d)),a[c]=d}),a.answers=b(a.answers),a}function j(a){return a.attr("id").substring(7)}function k(){return 0==arguments.length?r:(r=arguments[0],this)}function l(){return r=0,this}function m(){if(y&&y.form()){var b=i();g.request(s&&0==s.publishCount?{command:"updateQuestion",data:b,success:function(){s=b,r?d.showMessage(MSG.successUpdate):d.showQuestionList("left"),a(v,!0)}}:{command:"createQuestion",data:b,success:function(b){f.isRoomAdmin()?(f.isEventAdmin()?(d.showMessage(s?MSG.successCopy:MSG.successUpdate),u.text(MSG.update),x.show("slow"),a(t.find(":input"),!0),a(v,!0)):d.showQuestionList("left"),s=b):(d.showMessage(MSG.questionPosted),h())}})}}function n(){g.request({command:"publishQuestion",data:{questionId:s.id,eventId:r,includeRanking:w.is(":checked")},success:function(a){"OK"!=a&&d.showMessage(a)}})}function o(b){a(w,b),b||w.removeAttr("checked")}function p(b){t=$("#make-q-form"),c(t.find(":input")).each(function(){var a=$(this);if(s){var b=j(a);s[b]&&a.val(s[b])}}),y=t.validate({rules:{"make-q-question":{required:!0},"make-q-answers":{quizChoices:!0,required:!0},"make-q-tags":{maxlength:100},"make-q-relatedUrl":{url:!0,maxlength:256}},focusInvalid:!0}),t.find(":input").change(function(){a(v,!1)}),u=$("#make-q-update-btn").click(m),x=$("#make-q-publish"),w=$("#make-q-includeRank"),s&&r&&x.show(),v=$("#make-q-publish-btn").click(n),e(b),s&&($("#make-q-desc").text(r?MSG.editAndPublishQuestion:MSG.editQuestion),s.publishCount>0?(a(t.find(":input"),!1),u.text(MSG.copy)):u.text(MSG.update),s.answerType==E.NoAnswer&&o(!1)),$("#make-q-answerType").change(function(){var a=$(this).val();o(a!=E.NoAnswer)}),f.isRoomAdmin()?$("#make-q-back-btn").click(function(){d.showQuestionList("left")}).show():u.text(MSG.post)}function q(){s=null,t=null,u=null,v=null,w=null,x=null,y=null}var r=0,s=null,t=null,u=null,v=null,w=null,x=null,y=null;$.extend(this,{openEvent:k,closeEvent:l,init:p,clear:q,edit:function(a){s=a}})}function u(b,c,d){function e(a,b){$("#answer-"+a).find(".answer-cnt .count").text(b)}function f(a){a.removeClass("white disabled").addClass("blue"),a.find("li:first").empty().append("<i class='fa fa-check fa-2x'></i>")}function g(b){a(b,!1),b.removeClass("white").addClass("disabled")}function h(a){a.removeClass("white blue disabled").addClass("green"),a.find("li:first").empty().append("<i class='fa fa-circle-o fa-2x'></i>")}function i(a){a.removeClass("white blue disabled").addClass("red"),a.find("li:first").empty().append("<i class='fa fa-times fa-2x'></i>")}function j(a){if(F)for(var b=0;w>b;b++){var c=""+(b+1),d=a[c]||0;e(c,d)}F.find(".answer-cnt").show()}function k(){var a=(new Date).getTime()-B,e=$(this),h=parseInt(e.attr("id").substring(7));if(!A){if(A=!0,g(F),a>v)return void b.showMessage(MSG.timeLimitExceeded);f(e),G=e,d.request({command:"answer",data:{userId:c.userId,publishId:x.id,eventId:c.eventId,userEventId:c.userEventId,answer:h,time:a}}),j(y)}}function l(a){var b=""+a.answer,d=(y[b]||0)+1;y[b]=d,(c.isEventAdmin()||A)&&e(b,d)}function m(a,b){function c(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&(-1==a||a>d)&&(a=d)}return a}function d(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&d>a&&(a=d)}return a}switch(a.answerType){case E.FirstRow:for(var e=$.isArray(a.answers)?a.answers[0]:a.answers.split("\n")[0],f=0;f<F.length;f++){var g=$(F[f]);if(g.find(".answer").text()==e)return g}break;case E.Most:case E.Least:var h=a.answerType==E.Most?d():c();if(-1==h)return null;var i=[];return F.each(function(){$(this).find(".answer-cnt .count").text()==h&&i.push(this)}),$(i);case E.NoAnswer:return null}throw"IllegalState: "+a.answerType}function n(a,c,d){function e(a,b){var c=!1,d=a.attr("id");return b.each(function(){d==$(this).attr("id")&&(c=!0)}),c}if(F){var f=m(a,c);if(f){if(G){var g=e(G,f);msg=g?MSG.correctAnswer:MSG.wrongAnswer,g||i(G),d&&b.showEffect(msg,1)}h(f)}if(a.description){var j=$("#publish-q-description");j.find("pre").text(a.description),j.show()}if(a.relatedUrl){var k=$("#publish-q-url"),l=k.find("a");l.attr("href",a.relatedUrl).text(a.relatedUrl),k.show()}d?$("#publish-q-detail").slideDown():$("#publish-q-detail").show()}}function o(a){z=a,C&&n(z,y,!0)}function p(){function a(){b--,e.css("width",b+"%"),20>b?e.removeClass("progress-bar-warning").addClass("progress-bar-danger"):60>b&&e.removeClass("progress-bar-success").addClass("progress-bar-warning"),A&&(-1==c&&(c=b+1),f.css("width",c-b+"%")),b>0?setTimeout(a,d):(g(F),j(y),C=!0,z&&n(z,y,!0))}var b=100,c=-1,d=v/100,e=$("#publish-q-progress"),f=$("#publish-q-progress-answered"),h=null,i=0,k=0;e.css("width","100%"),f.css("width","0%"),setTimeout(a,d),H.contents().each(function(){$(this).replaceWith($(this).text().replace(/(\S)/g,"<span>$1</span>"))}),H.append('<span class="cur">_</span>'),h=H.find(".cur"),i=setInterval(function(){h&&h.toggle()},200),k=H.children().size();for(var l=0;k>l;l++){var m=H.children("span:eq("+l+")");l==k-1?setTimeout(function(){m.hide(),clearInterval(i)},50*l+2e3):m.delay(50*l).fadeIn(10)}}function q(a){var d=$("#publish-q-seq");if(H=$("#publish-q-text"),F=a.find(".btn-question").hide(),D){d.hide(),$("#publish-q-progress").hide(),$("#publish-q-ranking").hide(),a.find(".publish-q-animation").hide(),$("#publish-q-back").show(),$("#publish-q-back-btn").click(function(){b.backToMypage()});for(var e=0;e<D.answers.length;e++){var f=$("#answer-"+(e+1)).show();f.find(".answer-seq").text(e+1+"."),f.find(".answer").text(D.answers[e])}D.userAnswer&&(G=$("#answer-"+D.userAnswer)),j(D.answerCounts),g(F),n(D,D.answerCounts,!1),H.text(D.question)}else{if(x){d.text(MSG.format(MSG.questionSeq,x.seq));for(var e=0;e<x.answers.length;e++){var f=$("#answer-"+(e+1)).show();f.find(".answer-seq").text(e+1+"."),f.find(".answer").text(x.answers[e])}H.text(x.question)}z?(a.find(".publish-q-animation").css({"animation-name":"","-webkit-animation-name":""}),j(y),g(F),n(z,y,!1)):x?(a.find(".publish-q-animation").css({"animation-name":"inout","-webkit-animation-name":"inout"}),c.isEventAdmin()?j(y):c.userEventId?F.click(k):g(F)):($("#publish-q-default").hide(),$("#publish-q-none").show()),$("#publish-q-ranking").click(function(){b.showRanking()})}}function r(){z||D||(B=(new Date).getTime(),p())}function s(){F=null,G=null,H=null}function t(a){x=a,y={},z=null,A=!1,B=0,C=!1,D=null}function u(a){D=a}var v=1e4,w=5,x=null,y={},z=null,A=!1,B=0,C=!1,D=null,F=null,G=null,H=null;$.extend(this,{init:q,afterShow:r,clear:s,receiveAnswer:l,receiveAnswerDetail:o,setQuestion:t,setLookback:u})}function v(a,b,c){function d(){return b.isEventRunning()&&!b.isEntryEvent()}function e(){d()&&$(".entry-event").show()}function f(){$(".entry-event").hide()}function g(d){var e={userId:b.userId,username:b.username,userImage:b.userImage,eventId:b.eventId};d&&(e.passcode=d),c.request({command:"entryEvent",data:e,success:function(c){c.error?a.showMessage(c.error):c.requirePass?a.showPasscode():c.userEventId?(b.userEventId=c.userEventId,d&&a.showChat()):alert("Invalid data: "+JSON.stringify(c))}})}function h(){d()&&(g(),$("#entry-event-alert").hide())}function i(){$("#event-passcode-btn").click(function(){var b=$("#event-passcode-user").val();b?g(b):a.showMessage(MSG.invalidPasscode)}),$("#event-cancel-btn").click(function(){a.showChat()})}function j(){}$(".entry-event-btn").click(h),$("#not-entry-event").click(function(){$("#entry-event-alert").hide()}),d()&&e(),$.extend(this,{init:i,clear:j,openEvent:e,closeEvent:f})}function w(a,b,d){function f(a){if(a){for(var b in a){var c=$("#event-"+b);c.length&&c.val(a[b])}if(a.execDate){var d=new h(a.execDate);$("#event-date").val(d.dateStr()),$("#event-time").val(d.timeStr())}}}function g(){var a=$("#event-date").val(),c=$("#event-time").val(),d={id:b.eventId||0,roomId:b.roomId,status:b.eventStatus};return m.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6),c=a.val();c&&(d[b]=a.val())}),a&&(c&&(a+=" "+c),d.execDate=new Date(a).getTime()),d.capacity=parseInt(d.capacity),d}function i(){b.eventStatus==F.Prepared&&(b.eventId?d.request({command:"openEvent",data:{id:b.eventId,admin:b.userId},success:function(b){b?a.showQuestionList():a.showMessage(MSG.failOpenEvent)}}):j(!0))}function j(c){if(n&&n.form()){var e=g();d.request(e.id?{command:"updateEvent",data:e,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"createEvent",data:e,success:function(d){b.eventId=d.id,b.eventStatus=d.status,c?i():a.showMessage(MSG.successUpdate)}})}}function k(a){m=a.find("form"),c(m.find(":input")),n=m.validate({rules:{"event-capacity":{required:!0,digits:!0},"event-title":{maxlength:100},"event-date":{date:!0},"event-time":{time:!0},"event-passcode":{maxlength:100},"event-description":{maxlength:400}},focusInvalid:!0}),e(a),$("#event-start-btn").click(i),$("#event-update-btn").click(function(){j(!1)}),d.request({command:"getCurrentEvent",success:f})}function l(){m=null,n=null}var m=null,n=null;$.extend(this,{init:k,clear:l})}function x(a,b,c){function d(a,b,c){for(var d=0;d<b.length;d++){var e=b[d],g=$("<tr><td class='r-rank'/><td class='r-name'/><td class='r-correct'/><td class='r-time'/></tr>"),h=g.find(".r-rank"),i=g.find(".r-name"),j=$("<img/>");h.text(e.correctCount>0?c+d+1:"-"),j.attr("src",e.imageUrl),i.append(j),i.append(e.username),e.correctCount&&(g.find(".r-correct").text(e.correctCount),g.find(".r-time").text(f(e.time))),a.append(g)}}function e(a,e,f){var g;"boolean"==typeof f&&(g=f?"right":"left"),c.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(b){var c=$("#event-members-tbl"),e=c.find("tbody");e.empty(),g&&c.hide(),d(e,b,a),g&&c.show("slide",{direction:g},C)}})}function g(){b.isEventRunning()&&c.request({command:"closeEvent",data:b.eventId,success:function(b){b&&a.showRanking()
}})}function h(a){$("#event-finish-btn").click(g),c.request({command:"getMemberCount",data:b.eventId,success:function(b){k=new j(a.find(".paging-bar"),b,e,10),e(0,10)}})}function i(){k=null}var k=null;$.extend(this,{init:h,clear:i})}function y(a,b,c,d){function e(a,b,c){c?3>=b?a.html("<span class='badge circle rank-blue'>"+b+"</span>"):a.text(b):a.text("-"),a.attr("data-sortAs",b)}function g(){var a=$(this),b=parseInt(a.attr("data-eventId"));d.request({command:"getEventRanking",data:{eventId:b,limit:10},success:function(a){k($("#ranking-event-detail-tbl"),a),z.find(".tab-pane").hide(),$("#ranking-event-detail").show("slide",{direction:"right"},C)}})}function i(){var a=$(this),e=parseInt(a.attr("data-userId")),f=c[e];d.request({command:"getUserEvent",data:{roomId:b.roomId,userId:e},success:function(b){o(b),$("#ranking-user-img").attr("src",f.getBiggerImageUrl()),$("#ranking-user-name").text(f.name),$("#ranking-user-point").text(a.attr("data-point")),z.find(".tab-pane").hide(),$("#ranking-user").show("slide",{direction:"right"},C)}})}function j(a,b,d){for(var g=$("<tr></tr>"),i=0;i<b.length;i++){var j=$("<td></td>"),k=b[i],l=null;if($.isArray(k)&&(l=k[1],k=k[0]),l||(l=w[k]),l||(l="r-"+k),j.addClass(l),"username"==k&&a.username){var n=$("<img/>");n.attr("src",a.imageUrl),j.append(n),j.append(a.username)}else"title"==k?j.text(a.title||new h(a.execDate).datetimeStr()):"rank"==k?e(j,d,a.correctCount):"time"==k&&a.time?j.text(f(a.time)):a[k]&&j.text(a[k]);g.append(j)}return c[a.userId]||(c[a.userId]=new m({id:a.userId,name:a.username,imageUrl:a.imageUrl})),g}function k(a,b,c){var d=a.find("tbody"),g={};if(d.empty(),c&&x)for(var h=0;h<x.length;h++){var i=x[h],k=j(i,s,h+11);g[i.userId]=k,d.append(k)}for(var h=0;h<b.length;h++){var i=b[h],k=g[i.userId];k?(e(k.find(".r-rank"),h+1),k.find(".r-correct").text(i.correctCount),k.find(".r-time").text(f(i.time))):(k=j(i,s,h+1),d.append(k)),k.addClass("new")}c&&(setTimeout(function(){a.tableSort({sortBy:["numeric","nosort","nosort","nosort"]}),a.find("thead th:first").click(),setTimeout(function(){var a=d.find("tr").not(".new");a.hide("slow",function(){a.remove()})},200)},200),x=b,y=null)}function l(a){var c=$("#ranking-event-tbl").find("tbody");c.empty();for(var d=0;d<a.length;d++){var e=a[d],f=null;e.eventId!=b.eventId&&(f=j(e,t),f.attr("data-eventId",e.eventId),f.click(g),c.append(f))}}function n(a){var b=$("#ranking-total-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],e=j(d,u,c+1);e.attr("data-userId",d.userId),e.attr("data-point",d.point),e.click(i),b.append(e)}}function o(a){function c(a){for(var b=0;b<e.length;b++){var c=$(e[b]);if(c.attr("data-eventId")==a)return c.find(".r-title").text()}return"Unknown"}var d=$("#ranking-user-tbl").find("tbody"),e=$("#ranking-event-tbl").find("tbody tr");d.empty();for(var f=0;f<a.length;f++){var g=a[f],h=null,i=g.point>0?10-g.point+1:"-";g.eventId!=b.eventId&&(g.title=c(g.eventId),h=j(g,v,i),d.append(h))}}function p(){A=$("#ranking-now-tbl"),b.isEventRunning()?d.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(a){a.length&&(y=a)}}):$(".ranking-now").hide(),d.request({command:"getEventWinners",data:{roomId:b.roomId,limit:10},success:l}),d.request({command:"getTotalRanking",data:{roomId:b.roomId,limit:10},success:n}),$("#ranking-event-detail-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-event").show("slide",{direction:"left"},C)}),$("#ranking-user-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-total").show("slide",{direction:"left"},C)}),z=$("#ranking-tab").tabs({active:b.isEventRunning()?0:1,beforeActivate:function(){z.find(".tab-pane").hide()}}).show()}function q(){y&&k(A,y,!0)}function r(){z=null,A=null}var s=["rank","username","correctCount","time"],t=["title",["username","r-winners"],"correctCount","time"],u=["rank","username","point","correctCount"],v=["title","rank","point","correctCount"],w={username:"r-name",correctCount:"r-correct"},x=null,y=null,z=null,A=null;$.extend(this,{init:p,afterShow:q,clear:r})}function z(){function a(a,b,d){c&&c.log(a,b,d)}function b(a){c=a}var c=null;$.extend(this,{log:a,setImpl:b})}function A(a,b){function c(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),f>d&&e.find("tr:first").remove();var g=$("<tr><td></td><td></td><td><div class='pull-right'></div></td></tr>"),h=g.find("td");$(h.get(0)).text(a),$(h.get(1)).text(b),c&&$(h.get(2)).find("div").text(c),e.append(g),f++,console.log(a+", "+b+(c?", "+c+"ms":""))}var d=10,e=a.find("table tbody"),f=0;b.onRequest(function(a,b){var d=a;b&&(d+=", "+JSON.stringify(b)),c("send",d)}).onMessage(function(a,b){var d=(new Date).getTime();c("receive",JSON.stringify(a),d-b)}),$("#chk-use-ajax").bootstrapSwitch().on("switchChange",function(){var a=$(this).is(":checked");b.useAjax(a?"/ajax":!1)}),$("#btn-debug-msg").click(function(){$("#effect-dialog").animateDialog("Start!",{name:"rotateZoom"});var a=$(".publish-q-animation");a.css({"animation-name":"inout","-webkit-animation-name":"inout"}),a.hide(),setTimeout(function(){a.show()},0)}),$.extend(this,{log:c})}$.validator.addMethod("quizChoices",function(a){if(!a||0==a.length)return!1;var b=a.split("\n").filter(function(a){return a.length>0});return b.length<=1||b.length>5?!1:!0},MSG.invalidQuizChoices),$.validator.addMethod("time",function(a,b){return this.optional(b)||/^\d{2}:\d{2}$/.test(a)},MSG.invalidTime);var B="ontouchstart"in window,C=300,D="/assets/images/twitter_default_profile.png",E={FirstRow:0,Most:1,Least:2,NoAnswer:3},F={Prepared:0,Running:1,Finished:2},C=300;flect.QuizApp=function(a){function b(a,b){$.sidr("close");var c=$.extend({name:a},fb[a]);b?c.effect="none":bb.pushDynamic(a),ab.children("div").hide(),W.show(c)}function c(a,b,c){function d(){$.sidr("close"),e.is(":visible")||(ab.children("div").hide(),e.show("slide",{direction:"right"},C,c),bb.pushStatic(a))}var e=$("#"+a);b?$.sidr("close",d):d()}function d(){c("chat",!1,X.calcHeight)}function e(){var a={name:"mypage",direction:"left",beforeShow:P.init,afterHide:P.clear};ab.children("div").hide(),W.show(a),bb.pushState({method:"function",func:e},"/mypage")}function f(a){var b={name:"publish-question",beforeShow:function(b){Z.setLookback(a),Z.init(b)},afterHide:function(){Z.clear(),Z.setLookback(null)}};ab.children("div").hide(),W.show(b),bb.pushState({method:"lookback",qa:a},"/room/"+db.roomId+"/question")}function g(a){if(Z){var b={name:"publish-question",effect:"none",beforeShow:function(b){a&&Z.setQuestion(a),Z.init(b)},afterShow:Z.afterShow,afterHide:Z.clear};ab.children("div").hide(),W.show(b),bb.pushDynamic("publish-question")}}function h(){b("ranking")}function j(a){if(Y){var b=$.extend({name:"edit-question"},fb["edit-question"]);a&&("none"==a?b.effect="none":b.direction=a),ab.children("div").hide(),W.show(b),bb.pushDynamic("edit-question")}}function D(a){R&&(a&&R.edit(a),ab.children("div").hide(),W.show({name:"make-question",beforeShow:R.init,afterHide:R.clear}),bb.pushState({method:"function",func:function(){D(a)}}))}function E(){b("passcode")}function F(a,b){L.show(a,b)}function G(a,b){M.show(a,b)}function H(a,b){X&&X.tweet(a,b)}function I(){if(window.sessionStorage&&sessionStorage.clear(),K=new z,L=new flect.MessageDialog($("#msg-dialog")),M=new k($("#effect-dialog")),N=new flect.Connection(db.uri,K),O=new n(N,eb,db.userId),W=new flect.TemplateManager(N,$("#content-dynamic")),Z=new u(cb,db,N),bb=new i(cb,db),ab=$("#content"),db.isDebug()&&(K.setImpl(new A($("#debug"),N,L)),$("#btn-debug").click(function(){return c("debug",!0),!1}),N.onOpen(function(a){console.log("onOpen"),console.log(a)}).onClose(function(a){console.log("onClose"),console.log(a)}).onSocketError(function(a){console.log("onSocketError"),console.log(a)}).onServerError(function(a){console.log(a),alert(a)})),N.addEventListener("redirect",function(a){location.href=a}),db.isLogined()&&(eb[db.userId]=new m({id:db.userId,name:db.username,imageUrl:db.userImage}),P=new p(cb,db,eb,N),Q=new o(cb,db,eb,N),S=new r(cb,db.userId,N),$("#menu-mypage").click(function(){return b("mypage"),!1}),$("#menu-settings").click(function(){return b("user-setting"),!1})),db.isInRoom()){var a=$("#chat");X=new q(a,db,N),$(".menu-chat").click(function(){return c("chat",$(this).parents("#sidr").length>0,X.calcHeight),!1}),$("#toolbar-ranking").click(function(){return h(),!1}),$("#toolbar-question").click(function(){return db.isEventAdmin()?j():g(),!1}),N.addEventListener("chat",function(a){X.append(a),a.userId!=db.userId&&X.isNotifyTweet()&&L.notifyTweet(a)}),N.addEventListener("member",X.member),N.addEventListener("newEntry",function(a){var b=new m(a);eb[b.id]=b,L.notifyUserAction(b,MSG.newEntry)}),N.ready(function(){0==X.member()&&N.request({command:"member"})}),N.addEventListener("startEvent",function(a){var b=a.id,c=a.admin;M.show(MSG.start),db.openEvent(b,c==db.userId),R&&R.openEvent(db.eventId),V&&setTimeout(V.openEvent,3e3)}),N.addEventListener("finishEvent",function(){M.show(MSG.finish),db.closeEvent(),R&&R.closeEvent(),V&&V.closeEvent()}),N.addEventListener("question",function(a){g(a)}),N.addEventListener("answer",Z.receiveAnswer),N.addEventListener("answerDetail",Z.receiveAnswerDetail),_=new y(cb,db,eb,N)}(db.isRoomAdmin()||db.isPostQuestionAllowed())&&(R=new t(cb,db,N),db.isEventRunning()&&R.openEvent(db.eventId)),db.isRoomAdmin()&&(Y=new s(cb,eb,db,N),T=new w(cb,db,N),N.addEventListener("postQuestion",function(a){var b=a,c=eb[b];Y.reload(),c?L.notifyUserAction(c,MSG.postQuestionMessage):N.request({command:"getUser",data:b,success:function(a){var b=new m(a);eb[b.id]=b,L.notifyUserAction(b,MSG.postQuestionMessage)}})}),U=new x(cb,db,N)),db.canEntryEvent()&&(V=new v(cb,db,N)),$("#btn-menu").sidr({onOpen:function(){$("#toolbar").css("left","260px").find(".header-center").hide()},onClose:function(){$("#toolbar").css("left","0px").find(".header-center").show()}}),$("#content").swipe({swipeLeft:function(){$.sidr("close")},swipeRight:function(){$.sidr("open")},tap:function(a,b){B&&$(b).click()}}),N.polling(25e3,{command:"noop",log:"user="+(db.isLogined()?db.username:"(Anonymous)")}),$("#sidr a.dynamic").click(function(){var a=$(this).attr("href").substring(1);return $.sidr("close",function(){b(a)}),!1}),$(".dropdown-button").click(function(){return $(this).next("ul").toggle(),!1}),$(".dropdown-menu a").click(function(){var a=$(this);return a.parents(".dropdown-menu").hide(),"#"!=a.attr("href")})}function J(a){function c(){location.href=db.isInRoom()?"/room/"+db.roomId:"/"}var e=location.pathname;if("/"==e||"/home"==e)b("home",a);else if("/mypage"==e)db.isLogined()?b("mypage",a):c();else if("/makeRoom"==e)db.isLogined()?b("make-room",a):c();else if("/userSetting"==e)db.isLogined()?b("user-setting",a):c();else if("/help"==e)b("help",a);else{var f=e.substring(1).split("/");switch(2==f.length&&f.push(db.isRoomAdmin()?"questionList":"chat"),f[2]){case"question":b("publish-question",a);break;case"ranking":b("ranking",a);break;case"chat":a?($("#chat").show(),X.calcHeight()):d();break;case"editRoom":db.isRoomAdmin()?b("edit-room",a):c();break;case"event":db.isRoomAdmin()?b("edit-event",a):c();break;case"questionList":db.isRoomAdmin()?b("edit-question",a):c();break;case"postQuestion":!db.isRoomAdmin()&&db.isPostQuestionAllowed()?b("post-question",a):c()}}}var K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ab,bb,cb=this,db=new l(a),eb={};I(),K.log("params",db);var fb={home:{beforeShow:O.init,afterHide:O.clear}};db.isLogined()&&$.extend(fb,{mypage:{beforeShow:function(a){P.reset(),P.init(a)},afterHide:P.clear},"user-setting":{beforeShow:Q.init,afterHide:Q.clear},"make-room":{beforeShow:function(a){S.clear(),S.init(a)},afterHide:S.clear},"publish-question":{name:"publish-question",beforeShow:Z.init,afterHide:Z.clear},"edit-room":{name:"make-room",beforeShow:function(a){S.clear(),S.edit(db.roomId),S.init(a)},afterHide:S.clear}}),db.isRoomAdmin()?($.extend(fb,{"edit-question":{beforeShow:Y.init,afterHide:Y.clear}}),$.extend(fb,{"edit-event":{beforeShow:function(a){db.isEventRunning()?U.init(a):T.init(a)},name:function(){return db.isEventRunning()?"event-members":"edit-event"},afterHide:function(){db.isEventRunning()?U.clear():T.clear()}}})):db.isPostQuestionAllowed()&&$.extend(fb,{"post-question":{name:"make-question",beforeShow:R.init,afterHide:R.clear}}),db.isInRoom()&&$.extend(fb,{ranking:{name:"ranking",beforeShow:_.init,afterShow:_.afterShow,afterHide:_.clear}}),V&&$.extend(fb,{passcode:{name:"passcode",beforeShow:V.init,afterHide:V.clear}}),$.extend(this,{showQuestionList:j,showMakeQuestion:D,showPasscode:E,showChat:d,showRanking:h,showQuestion:g,showLookback:f,showMessage:F,showEffect:G,showDynamic:b,showStatic:c,showInitial:J,backToMypage:e,tweet:H}),N.ready(function(){J(!0)})}});