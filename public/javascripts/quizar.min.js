/*! quizar 2014-04-03 */
"undefined"==typeof flect&&(flect={}),$(function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}flect.Connection=function(b,c){function d(){if(0==arguments.length)return y;var a=arguments[0];return y=a?a:null,t}function e(a){return u.onRequest&&u.onRequest(a.command,a.data),y?f(a):g(a),t}function f(b){c.log("ajax",b.command);var d=(new Date).getTime(),e=++v,f=b.url?b.url:y,g=b.success;if(b.command&&(a(f,"/")||(f+="/"),f+=b.command,delete b.command),f+="?id="+e,b.log&&(f+="&log="+b.log,delete b.log),b.url=f,b.type||(b.type="POST"),b.data){var h=JSON.stringify(b.data);b.data={data:h}}b.success=function(a){if(u.onMessage&&u.onMessage(a,d),a){if("error"==a.type)return void(u.onServerError&&u.onServerError(a.data));var c=g;c||(c=x[b.command]),c&&c(a.data)}},$.ajax(b)}function g(a){c.log("ws",a.command);var b=(new Date).getTime(),d=++v;w[d]=b,a.success&&(x[d]=a.success);var e={id:d,command:a.command,data:a.data};a.log&&(e.log=a.log),socket.send(JSON.stringify(e))}function h(a,b){return x[a]=b,t}function i(a){return delete x[a],t}function j(a){A=0;for(var b=0;b<z.length;b++)z[b]();z=[],u.onOpen&&u.onOpen(a)}function k(a){var b=JSON.parse(a.data),d=w[b.id],e=null;return d&&delete w[b.id],u.onMessage&&u.onMessage(b,d),"error"==b.type?void(u.onServerError&&u.onServerError(b.data)):(b.id&&x[b.id]?(e=x[b.id],delete x[b.id]):b.command&&x[b.command]&&(e=x[b.command]),void(e?e(b.data):c.log("UnknownMessage",a.data)))}function l(a){u.onClose&&u.onClose(a),s>A&&(A++,setTimeout(function(){socket=r()},1e3*A))}function m(a){u.onSocketError&&u.onSocketError(a)}function n(a,b){return setInterval(function(){q()&&e($.extend(!0,{},b))},a)}function o(a){q()?a():z.push(a)}function p(){q()&&(A=s,socket.close())}function q(){return 1==socket.readyState}function r(){var a=new WebSocket(b);return a.onopen=j,a.onmessage=k,a.onerror=m,a.onclose=l,a}var s=5,t=this,u={},v=0,w={},x={},y=null,z=[],A=0;socket=r(),$.extend(this,{useAjax:d,request:e,addEventListener:h,removeEventListener:i,polling:n,ready:o,close:p,isConnected:q,onOpen:function(a){return u.onOpen=a,this},onClose:function(a){return u.onClose=a,this},onRequest:function(a){return u.onRequest=a,this},onMessage:function(a){return u.onMessage=a,this},onSocketError:function(a){return u.onSocketError=a,this},onServerError:function(a){return u.onServerError=a,this}})}}),"undefined"==typeof flect&&(flect={}),$(function(){function a(){function a(a){return c[a]}function b(a,b){c[a]=b}var c={};$.extend(this,{getItem:a,setItem:b})}var b=300;flect.TemplateManager=function(c,d){function e(a){"string"==typeof a&&(a={name:a});var b=a.name;"function"==typeof b&&(b=b());var c=h.getItem("template."+b);c?g(c,a):f(b,function(c){h.setItem("template."+b,c),g(c,a)})}function f(a,b){c.request({command:"template",log:a,data:{name:a},success:b})}function g(a,c){function e(){c.afterShow&&c.afterShow(d)}i&&i(d),d.hide(),j&&j(d),d.empty(),d.html(a),c.beforeShow&&c.beforeShow(d),i=c.beforeHide,j=c.afterHide,setTimeout(function(){var a=c.direction||"right",f=c.effect;"none"==f?d.show(0,e):d.show("slide",{direction:a},b,e)},0)}var h=window.sessionStorage?window.sessionStorage:new a,i=null,j=null;$.extend(this,{show:e,loadTemplate:f})}}),"undefined"==typeof flect&&(flect={}),$(function(){flect.MessageDialog=function(a){function b(b){b=b||3,a.css({"animation-name":"fade","-webkit-animation-name":"fade","animation-duration":b+"s","-webkit-animation-duration":b+"s"}),a.show(),setTimeout(function(){if(a.hide(),a.css("animation-name",""),a.css("-webkit-animation-name",""),f=!1,g.length>0){var b=g;g=[],setTimeout(function(){c(b)},10)}else if(h.length>0){var b=h;h=[],setTimeout(function(){d(b)},10)}},1e3*b)}function c(c,d){if(f)return void g.push(c);f=!0,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var h=$("<span class='message'></span>");h.text(c[e]),a.append(h)}b(d)}function d(c,d){if(f)return void h.push(c);f=!0,d=d||3,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var g=c[e],i=$("<div class='tweet'><img/><p></p><p></p></div>");i.find("img").attr("src",g.img),i.find("p:first").text(g.username),i.find("p:last").text(g.msg),a.append(i)}b(d)}function e(a,b){d({userId:a.id,username:a.name,msg:b,img:a.imageUrl})}var f=!1,g=[],h=[];$.extend(this,{show:c,notifyTweet:d,notifyUserAction:e})}}),$(function(){function a(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}function b(a){return a.split("\n").filter(function(a){return a.length>0}).join("\n")}function c(a){return a.each(function(){var a=$(this),b=a.attr("id");b&&a.attr("name",b)}),a}function d(a){for(var b in a)delete a[b]}function e(a,b){b||(b=a.find(".option-panel"),a=a.find(".option-ctrl")),a.click(function(){var c=a.find("i");c.hasClass("fa-caret-down")?(c.removeClass("fa-caret-down").addClass("fa-caret-up"),a.addClass("active")):(c.removeClass("fa-caret-up").addClass("fa-caret-down"),a.removeClass("active")),b.slideToggle()})}function f(a){var b=a.find(".paging-bar");if(b.length){var c=b.parent(),d=b.find("button.back-btn");d.length&&c.swipe({swipeRight:function(a){d.click(),a.stopImmediatePropagation()},tap:function(a,b){C&&$(b).click()}})}}function g(a){return Math.round(a/10)/100}function h(a,b){a.show("slide",{direction:b},D)}function i(){function a(){var a=e.getFullYear(),b=e.getMonth()+1,c=e.getDate();return 10>b&&(b="0"+b),10>c&&(c="0"+c),a+"-"+b+"-"+c}function b(){var a=e.getHours(),b=e.getMinutes();return 10>a&&(a="0"+a),10>b&&(b="0"+b),a+":"+b}function c(){return a().substring(5)+" "+b()}function d(){return e.getTime()}var e;switch(arguments.length){case 1:e=new Date(arguments[0]);break;case 2:e=new Date(arguments[0]+" "+arguments[1])}$.extend(this,{dateStr:a,timeStr:b,datetimeStr:c,getTime:d})}function j(a,b){function c(){var a=0,b=Number.MAX_VALUE;for(var c in m)b>c&&(b=c),a++;a>k&&delete m[c]}function d(a){switch(a){case"home":return"/home";case"mypage":return"/mypage";case"user-setting":return"/userSetting";case"make-room":return"/makeRoom";case"help":return"/help";case"publish-question":return j+"/question";case"ranking":return j+"/ranking";case"edit-room":return j+"/editRoom";case"edit-event":return j+"/event";case"edit-question":return j+"/questionList";case"post-question":return j+"/postQuestion";case"chat":return j+"/chat";case"debug":return j}return null}function e(a){g({method:"dynamic",id:a},d(a))}function f(a){g({method:"static",id:a},d(a))}function g(a,b){l&&(a.seq=null==n?1:n.seq+1,"function"==a.method&&(c(),m[a.seq]=a.func,delete a.func),n=a,history.pushState(a,null,b))}function h(a,b){return null==a||null==b?!1:"lookback"!=a.method||"dynamic"!=b.method?!1:a.seq<=b.seq?!1:!0}function i(b){var c=b.originalEvent.state;if(c||n){l=!1;try{if(null==c)a.showInitial(!1);else if("dynamic"==c.method)h(n,c)?a.backToMypage():a.showDynamic(c.id);else if("static"==c.method)a.showStatic(c.id);else if("function"==c.method){var d=m[c.seq];d&&d()}else"lookback"==c.method?a.showLookback(c.qa):console.log("popState: "+JSON.stringify(c))}finally{n=c,l=!0}}}var j="/room/"+b.roomId,k=20,l=!0,m={},n=null;$(window).on("popstate",i),$.extend(this,{pushState:g,pushDynamic:e,pushStatic:f})}function k(b,c,d,e){function f(){k>0&&(k-=e,d(k,e,!1),h())}function g(){c>k+e&&(k+=e,d(k,e,!0),h())}function h(){a(l,k>0),a(m,c>k+e)}function i(){return 0==arguments.length?c:(c=arguments[0],this)}function j(){l=null,m=null}var k=0,l=b.find(".paging-bar-left"),m=b.find(".paging-bar-right");e=e||10,l.click(f),m.click(g),h(),b.parent().swipe({swipeLeft:function(a){g(),a.stopImmediatePropagation()},swipeRight:function(a){f(),a.stopImmediatePropagation()},tap:function(a,b){C&&$(b).click()}}),$.extend(this,{prev:f,next:g,recordCount:i,release:j})}function l(a){function b(b,c){c||(c=5),a.animateDialog(b,{name:"rotateZoom",duration:c+"s"})}$.extend(this,{show:b})}function m(a){function b(){return!!o.userId}function c(){return!!o.userEventId}function d(){return o.eventStatus==G.Running}function e(){return!!o.eventAdmin}function f(){return!!o.roomId}function g(){return!!o.roomAdmin}function h(){return!!o.userQuiz}function i(){return!!o.debug}function j(a,b){o.eventId=a,o.eventStatus=G.Running,o.eventAdmin=b}function k(){o.eventId=0,o.eventStatus=G.Prepared,o.userEventId=0,o.eventAdmin=!1}function l(a){o.userEventId=a}function m(){return b()&&f()&&!g()}function n(a){this.notifyTweet=a,$.cookie("notifyTweet",a?1:0,{path:"/",expires:100})}var o=this;$.extend(this,a,{isLogined:b,isEntryEvent:c,isEventRunning:d,isEventAdmin:e,isInRoom:f,isRoomAdmin:g,isPostQuestionAllowed:h,isDebug:i,openEvent:j,closeEvent:k,entryEvent:l,canEntryEvent:m,setNotifyTweet:n}),this.eventStatus||(this.eventStatus=G.Prepared),this.notifyTweet=1==$.cookie("notifyTweet"),n(this.notifyTweet)}function n(a){function b(){return this.imageUrl}function c(){return this.imageUrl.replace("_mini","_normal")}function e(){return this.imageUrl.replace("_mini","_bigger")}$.extend(this,a,{getMiniImageUrl:b,getNormalImageUrl:c,getBiggerImageUrl:e}),d(a)}function o(a,b,c){function d(){var a=$(this).attr("data-id");a&&(location.href="/room/"+a)}function e(){var a=o.tabs("option","active"),b=$(0==a?"#event-future":"#event-yours");$("#event-detail").hide(),h(b,"left")}function g(a){$("#room-detail-enter").attr("data-id",a.id),$("#room-detail-name").text(a.name),a.userQuiz&&$("#room-detail-userQuiz").attr("checked","checked"),$("#room-detail-description").text(a.description||""),a.event?($("#room-detail-event").show(),$("#room-detail-title").text(a.event.title||"-"),$("#room-detail-date").text(a.event.execDate?new i(a.event.execDate).datetimeStr():"-"),$("#room-detail-capacity").text(MSG.format(MSG.numberWithPeople,a.event.capacity)),$("#room-detail-description2").text(a.event.description||"")):$("#room-detail-event").hide(),o.find(".tab-pane").hide(),h($("#event-detail"),"right")}function j(a){a.find("tbody tr").click(function(){var a=$.data(this,"room");return a&&g(a),!1}),a.find("tbody tr button").click(function(){var a=$.data($(this).parents("tr")[0],"room");return a&&(location.href="/room/"+a.id),!1})}function k(c,d){for(var e=c.find("tbody"),f={},g=0;g<d.length;g++){var h=d[g],j=$("<tr><td class='event-date'></td><td class='event-title'><img src='"+E+"'/></td><td class='event-capacity'></td><td class='event-enter'><button class='btn blue'>"+MSG.enter+"</button></td></tr>"),k=j.find("img"),l=MSG.undecided,m=h.name,o="";h.event&&(h.event.title&&(m+="("+h.event.title+")"),h.event.status==G.Running?(l=MSG.eventRunning,j.find(".event-date").addClass("in-session")):h.event.execDate&&(l=new i(h.event.execDate).datetimeStr()),h.event.capacity&&(o=MSG.format(MSG.numberWithPeople,h.event.capacity))),j.attr("data-room",h.id),j.find(".event-date").text(l),j.find(".event-title").append(m),j.find(".event-capacity").text(o),b[h.owner]?k.attr("src",b[h.owner].getMiniImageUrl()):f[h.owner]?k.attr("data-userId",h.owner):(f[h.owner]=!0,k.attr("data-userId",h.owner),a.request({command:"getUser",data:h.owner,success:function(a){var d=new n(a);b[d.id]=d,c.find("[data-userId="+d.id+"]").attr("src",d.getMiniImageUrl()).removeAttr("data-userId")}})),$.data(j[0],"room",h),e.append(j)}}function l(b){var g=$("#event-future"),h=$("#event-yours");a.request({command:"listRoom",data:{limit:10,offset:0},success:function(a){k(g,a),j(g),o=b.find(".tab-content").tabs({beforeActivate:function(){o.find(".tab-pane").hide()}}).show()}}),c&&a.request({command:"listRoom",data:{limit:10,offset:0,userId:c},success:function(a){k(h,a),j(h)}}),$("#room-detail-enter").click(d),$("#room-detail-back").click(e),f($("#event-detail"))}function m(){o=null}var o=null;$.extend(this,{init:l,clear:m})}function p(a,b,c,d){function e(){var c=$("#user-name").val();c&&c!=b.username&&d.request({command:"updateUser",data:{userId:b.userId,name:c},success:function(c){c&&(a.showMessage(MSG.successUpdate),setTimeout(function(){var a=b.isInRoom()?"/room/"+b.roomId:"/";location.href=a},3e3))}})}function f(){$("#user-name").val(b.username),b.notifyTweet&&$("#user-notify-tweet").attr("checked","checked"),$("#user-notify-tweet").change(function(){var a=$(this).is(":checked");b.setNotifyTweet(a)}),$("#btn-user-setting").click(e)}function g(){}$.extend(this,{init:f,clear:g})}function q(a,b,c,d){function e(a,b,d){a.empty();for(var e=0;e<d.length;e++){for(var f=d[e],g=$("<tr></tr>"),h=0;h<b.length;h++){var j=b[h],k=$("<td></td>");if(k.addClass(j),"r-room"==j){var l=$("<img/>");l.attr("src",f.ownerImage),k.append(l),k.append(f.roomName)}else if("r-title"==j)k.text(f.title||new i(f.execDate).datetimeStr());else if("r-point"==j)k.text(f.point);else if("r-correct"==j)k.text(f.correctCount);else if("r-event"==j)k.text(f.eventCount);else if("r-question"==j)k.text(f.questionCount);else if("q-text"==j)k.text(f.question);else if("r-member"==j)k.text(MSG.format(MSG.numberWithPeople,f.userCount));else if("r-publish"==j)k.text(f.publishCount);else if("q-correct"==j&&f.userAnswer){var m=f.correct?"fa-circle-o":"fa-times",o=$("<i class='fa'></i>");o.addClass(m),k.append(o)}f.owner&&!c[f.owner]&&(c[f.owner]=new n({id:f.owner,name:f.ownerName,imageUrl:f.ownerImage})),g.append(k)}a.append(g),$.data(g[0],"obj",f)}}function g(a,b){var c=$("#mypage-events tbody");$("#mypage-events-roomName").text(a.name),$("#mypage-events-total").text(a.rank?a.rank:"-"),e(c,v,b),c.find("tr").click(o)}function j(){var a=$.data(this,"obj"),c=$("#mypage-events-total");c.text("-"),d.request({command:"getUserEvent",data:{roomId:a.roomId,userId:b.userId},success:function(b){var c=$("#mypage-events"),d=c.find("tbody");A=b,$("#mypage-events-roomName").text(a.roomName),e(d,v,b),y.find(".tab-pane").hide(),d.find("tr").click(o),h(c,"right")}}),d.request({command:"getUserTotalRanking",data:{roomId:a.roomId,userId:b.userId},success:function(b){b&&c.text(MSG.format(MSG.numberWithRank,b)),z={id:a.roomId,name:a.roomName,rank:b}}})}function k(a,b){var c=$("#mypage-owners-events tbody");$("#mypage-owners-events-roomName").text(a.name),e(c,w,b),c.find("tr").click(o)}function l(){var a=$.data(this,"obj");$("#mypage-owners-events-roomName").text(a.roomName),d.request({command:"getEventWithCount",data:a.roomId,success:function(b){for(var c=$("#mypage-owners-events"),d=c.find("tbody"),f=[],g=0;g<b.length;g++){var i=b[g].event;i.eventId=i.id,i.userCount=b[g].userCount,i.publishCount=b[g].publishCount,f.push(i)}z={id:a.roomId,name:a.roomName},A=f,e(d,w,f),y.find(".tab-pane").hide(),d.find("tr").click(o),h(c,"right")}})}function m(a){var b=$("#mypage-questions tbody");e(b,x,a),b.find("tr").click(p)}function o(){var a=$.data(this,"obj");d.request({command:"getEventQuestions",data:{eventId:a.eventId,userId:b.userId},success:function(a){var b=$("#mypage-questions"),c=b.find("tbody");B=a,e(c,x,a),c.find("tr").click(p),y.find(".tab-pane").hide(),h(b,"right")}})}function p(){var b=$.data(this,"obj");d.request({command:"getLookback",data:b.publishId,success:function(c){c.userAnswer=b.userAnswer,a.showLookback(c)}})}function q(a){y=a.find(".tab-content").tabs({beforeActivate:function(){y.find(".tab-pane").hide()}}).show(),d.request({command:"entriedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-entries tbody");e(b,t,a),b.find("tr").click(j)}}),d.request({command:"ownedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-owners tbody");e(b,u,a),b.find("tr").click(l)}}),$("#mypage-events-back").click(function(){z=null,A=null,y.find(".tab-pane").hide(),h($("#mypage-entries"),"left")}),$("#mypage-owners-events-back").click(function(){z=null,A=null,y.find(".tab-pane").hide(),h($("#mypage-owners"),"left")}),$("#mypage-questions-back").click(function(){B=null,y.find(".tab-pane").hide(),z.rank?h($("#mypage-events"),"left"):h($("#mypage-owners-events"),"left")}),z&&A&&(z.rank||y.tabs("option","active",1),y.find(".tab-pane").hide(),z.rank?g(z,A):k(z,A),B?(m(B),$("#mypage-questions").show()):z.rank?$("#mypage-events").show():$("#mypage-owners-events").show()),f($("#mypage-events")),f($("#mypage-owners-events")),f($("#mypage-questions"))}function r(){y=null}function s(){z=null,A=null,B=null}var t=["r-room","r-point","r-correct"],u=["r-room","r-event","r-question"],v=["r-title","r-point","r-correct"],w=["r-title","r-member","r-publish"],x=["q-text","q-correct"],y=null,z=null,A=null,B=null;$.extend(this,{init:q,clear:r,reset:s})}function r(a,b,c){function d(a,b){k&&c.request({command:"tweet",data:{userId:k,msg:a,twitter:b}})}function e(){return a.is(":hidden")&&b.notifyTweet}function f(a){return 0==arguments.length?r.text():void r.text(a)}function g(a){j>i&&q.find("li:first").remove();var b=a.userId==k?"align-left":"align-right",c=$("<li style='display:none;'><div class='contributor'><img/><span/></div><div class='balloon'><div class='balloon-border'><p class='text'></p></div></div></li>"),d=c.find("img"),e=c.find(".contributor span"),f=c.find(".text");c.addClass(b),e.text(a.username),d.attr("src",a.img),f.text(a.msg),q.append(c),c.show("slow",function(){p.scrollTop(p[0].scrollHeight-p.height())}),j++,o.text(j)}function h(){var b=$(window).height(),c=0;a.children("div").each(function(){var a=$(this),b=a.outerHeight();a.hasClass("tweet-box")||b>0&&(c+=b)}),c+=$("#toolbar").outerHeight(),c+=$("#tabbar").outerHeight(),p.css("height",b-c-24)}var i=20,j=0,k=b.userId,l=b.hashtag,m=$("#chat-text"),n=$("#chat-twitter"),o=$("#chat-text-len span"),p=a.find(".tweet-box"),q=p.find("ul"),r=$("#room-member");k&&($("#btn-tweet").click(function(){var a=m.val(),b=n.is(":checked");0==a.length||a.length>140||a==l||(m.val(l),d(a,b))}),m.keyup(function(){var a=140-m.val().length;0>=a?o.addClass("error"):o.removeClass("error"),o.text(a)})),l?"#"!=l.charAt(0)&&(l="#"+l):l="",m.val(l),m.keyup(),$.extend(this,{member:f,append:g,tweet:d,isNotifyTweet:e,calcHeight:h})}function s(a,b,d){function f(a){return a.attr("id").substring(5)}function g(){if(m&&m.form()){var c=l||{id:-1,owner:b};j.find(":input").each(function(){var a=$(this),b=f(a);a.is(":checkbox")?c[b]=a.is(":checked"):a.val()&&(c[b]=a.val())}),d.request(l?{command:"updateRoom",data:c,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"makeRoom",data:c,success:function(a){a.id&&(d.close(),location.href="/room/"+a.id)}})}}function h(a){if(k&&!l)return void d.request({command:"getRoom",data:k,success:function(b){l=b,h(a)}});j=$("#make-room-form"),c(j.find(":input")).each(function(){var a=$(this);if(l){var b=f(a);l[b]&&(a.is(":checkbox")?a.attr("checked","checked"):a.val(l[b]))}}),m=j.validate({rules:{"room-name":{required:!0,maxlength:100},"room-tags":{maxlength:100},"room-hashtag":{maxlength:20},"room-description":{maxlength:400}},focusInvalid:!0});var b=$("#btn-make-room").click(g),i=$("#make-room-desc");l?($("#room-admin").show(),i.text(MSG.makeRoomDescForEdit),b.text(MSG.update)):($("#room-admin").hide(),i.text(MSG.makeRoomDescForCreate),b.text(MSG.create)),e(a)}function i(){j=null,m=null,k=0,l=null}var j=null,k=0,l=null,m=null;$.extend(this,{init:h,clear:i,edit:function(a){k=a}})}function t(b,c,d,e){function f(f,g){function h(a){for(var b=0;b<s.length;b++){var c=s[b];if(c.id==a)return c}return null}function i(a,i){var j=$("<tr><td class='q-creator'><img src='"+E+"'/></td><td class='q-text'></td>"+(g?"<td class='q-answerer'></td>":"<td class='q-publish'><button class='btn blue'>"+MSG.publish+"</button></td>")+"</tr>"),k=j.find("img");if(j.attr("data-id",a.id),j.attr("data-at",a.answerType),j.find(".q-text").text(a.question),c[a.createdBy]?k.attr("src",c[a.createdBy].getMiniImageUrl()).after(c[a.createdBy].name):i[a.createdBy]?k.attr("data-userId",a.createdBy):(i[a.createdBy]=!0,k.attr("data-userId",a.createdBy),e.request({command:"getUser",data:a.createdBy,success:function(a){var b=new n(a);c[b.id]=b,f.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId").after(b.name)}})),g){var l=a.correctCount+"/"+a.publishCount;j.find(".q-answerer").text(l),publishedQuestions[a.id]&&j.addClass("q-published")}else d.isEventRunning()?j.find("button").click(function(){var a=$(this).parents("tr"),c=parseInt(a.attr("data-id")),f=a.attr("data-at");e.request({command:"publishQuestion",data:{questionId:c,eventId:d.eventId,includeRanking:f!=F.NoAnswer},success:function(a){"OK"!=a&&b.showMessage(a)}})}):j.find("button").attr("disabled","disabled").removeClass("blue").addClass("disabled");j.click(function(){var a=$(this).attr("data-id");b.showMakeQuestion(h(a))}),t.append(j)}function j(a,b,c){e.request({command:"listQuestion",data:{published:g,offset:a,limit:b},success:function(a){var b=t.parents("table"),d={};s=a,t.empty(),c&&b.hide();for(var e=0;e<a.length;e++)i(a[e],d);c&&b.show("slide",{direction:c},D)}})}function k(){r>0&&(r-=l,j(r,l,"left"),p())}function m(){q>r+l&&(r+=l,j(r,l,"right"),p())}function o(){return 0==arguments.length?q:(q=arguments[0],this)}function p(){a($btnPrev,r>0),a($btnNext,q>r+l)}var q=0,r=0,s=[],t=f.find("table tbody");f.swipe({swipeLeft:function(a){m(),a.stopImmediatePropagation()},swipeRight:function(a){k(),a.stopImmediatePropagation()},tap:function(a,b){C&&$(b).click()}}),$.extend(this,{prev:k,next:m,load:j,count:o,activate:p})}function g(){var a=$tab.tabs("option","active");return 0==a?m:publishedTable}function h(a){e.request({command:"countQuestion",success:function(b){m.count(b.count-b.published),publishedTable.count(b.published),$("#question-stock-count").text(m.count()),$("#question-published-count").text(publishedTable.count()),a&&m.activate()}})}function i(a){m=new f($("#edit-question-stock"),!1),publishedTable=new f($("#edit-question-published"),!0),$tab=a.find(".tab-content").tabs({activate:function(){g().activate()}}),h(!0),d.isEventRunning()&&e.request({command:"getPublishedQuestions",data:d.eventId,success:function(a){for(var b=0;b<a.length;b++)publishedQuestions[a[b]]=!0}}),m.load(0,l),publishedTable.load(0,l),$("#edit-question-new").click(function(){b.showMakeQuestion()}),$btnPrev=$("#edit-question-left").click(function(){g().prev()}),$btnNext=$("#edit-question-right").click(function(){g().next()})}function j(){m&&(h(g()==m),m.load(0,l))}function k(){m=null,publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={}}var l=10,m=null;publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={},$.extend(this,{init:i,clear:k,reload:j})}function u(d,f,g){function h(){$("#make-q-question").val(""),$("#make-q-answers").val(""),$("#make-q-answerType").val(F.FirstRow),$("#make-q-tags").val(""),$("#make-q-description").val(""),$("#make-q-relatedUrl").val("")}function i(){var a={id:0,roomId:f.roomId,createdBy:f.userId};return s&&(a.id=s.id,a.createdBy=s.createdBy),t.find(":input").each(function(){var b=$(this),c=j(b),d=b.val();"answerType"==c&&(d=parseInt(d)),a[c]=d}),a.answers=b(a.answers),a}function j(a){return a.attr("id").substring(7)}function k(){return 0==arguments.length?r:(r=arguments[0],this)}function l(){return r=0,this}function m(){if(y&&y.form()){var b=i();g.request(s&&0==s.publishCount?{command:"updateQuestion",data:b,success:function(){s=b,r?d.showMessage(MSG.successUpdate):d.showQuestionList("left"),a(v,!0)}}:{command:"createQuestion",data:b,success:function(b){f.isRoomAdmin()?f.isEventAdmin()?(d.showMessage(s?MSG.successCopy:MSG.successUpdate),u.text(MSG.update),x.show("slow"),a(t.find(":input"),!0),a(v,!0),s=b):d.showQuestionList("left"):(d.showMessage(MSG.questionPosted),h())}})}}function n(){g.request({command:"publishQuestion",data:{questionId:s.id,eventId:r,includeRanking:w.is(":checked")},success:function(a){"OK"!=a&&d.showMessage(a)}})}function o(b){a(w,b),b||w.removeAttr("checked")}function p(b){t=$("#make-q-form"),c(t.find(":input")).each(function(){var a=$(this);if(s){var b=j(a);s[b]&&a.val(s[b])}}),y=t.validate({rules:{"make-q-question":{required:!0},"make-q-answers":{quizChoices:!0,required:!0},"make-q-tags":{maxlength:100},"make-q-relatedUrl":{url:!0,maxlength:256}},focusInvalid:!0}),t.find(":input").change(function(){a(v,!1)}),u=$("#make-q-update-btn").click(m),x=$("#make-q-publish"),w=$("#make-q-includeRank"),s&&r&&x.show(),v=$("#make-q-publish-btn").click(n),e(b),s&&($("#make-q-desc").text(r?MSG.editAndPublishQuestion:MSG.editQuestion),s.publishCount>0?(a(t.find(":input"),!1),u.text(MSG.copy)):u.text(MSG.update),s.answerType==F.NoAnswer&&o(!1)),$("#make-q-answerType").change(function(){var a=$(this).val();o(a!=F.NoAnswer)}),f.isRoomAdmin()?$("#make-q-back-btn").click(function(){d.showQuestionList("left")}).show():u.text(MSG.post)}function q(){s=null,t=null,u=null,v=null,w=null,x=null,y=null}var r=0,s=null,t=null,u=null,v=null,w=null,x=null,y=null;$.extend(this,{openEvent:k,closeEvent:l,init:p,clear:q,edit:function(a){s=a}})}function v(b,c,d){function e(a,b){$("#answer-"+a).find(".answer-cnt .count").text(b)}function g(a){a.removeClass("white disabled").addClass("blue"),a.find("li:first").empty().append("<i class='fa fa-check fa-2x'></i>")}function h(b){a(b,!1),b.removeClass("white").addClass("disabled")}function i(a){a.removeClass("white blue disabled").addClass("green"),a.find("li:first").empty().append("<i class='fa fa-circle-o fa-2x'></i>")}function j(a){a.removeClass("white blue disabled").addClass("red"),a.find("li:first").empty().append("<i class='fa fa-times fa-2x'></i>")}function k(a){if(G)for(var b=0;x>b;b++){var c=""+(b+1),d=a[c]||0;e(c,d)}G.find(".answer-cnt").show()}function l(){var a=(new Date).getTime()-C,e=$(this),f=parseInt(e.attr("id").substring(7));if(!B){if(B=!0,h(G),a>w)return void b.showMessage(MSG.timeLimitExceeded);g(e),H=e,d.request({command:"answer",data:{userId:c.userId,publishId:y.id,eventId:c.eventId,userEventId:c.userEventId,answer:f,time:a}}),k(z)}}function m(a){var b=""+a.answer,d=(z[b]||0)+1;z[b]=d,(c.isEventAdmin()||B)&&e(b,d)}function n(a,b){function c(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&(-1==a||a>d)&&(a=d)}return a}function d(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&d>a&&(a=d)}return a}switch(a.answerType){case F.FirstRow:for(var e=$.isArray(a.answers)?a.answers[0]:a.answers.split("\n")[0],f=0;f<G.length;f++){var g=$(G[f]);if(g.find(".answer").text()==e)return g}break;case F.Most:case F.Least:var h=a.answerType==F.Most?d():c();if(-1==h)return null;var i=[];return G.each(function(){$(this).find(".answer-cnt .count").text()==h&&i.push(this)}),$(i);case F.NoAnswer:return null}throw"IllegalState: "+a.answerType}function o(a,c,d){function e(a,b){var c=!1,d=a.attr("id");return b.each(function(){d==$(this).attr("id")&&(c=!0)}),c}if(G){var f=n(a,c);if(f){if(H){var g=e(H,f);msg=g?MSG.correctAnswer:MSG.wrongAnswer,g||j(H),d&&b.showEffect(msg,3)}i(f)}if(a.description){var h=$("#publish-q-description");h.find("pre").text(a.description),h.show()}if(a.relatedUrl){var k=$("#publish-q-url"),l=k.find("a");l.attr("href",a.relatedUrl).text(a.relatedUrl),k.show()}d?$("#publish-q-detail").slideDown():$("#publish-q-detail").show()}}function p(a){A=a,D&&o(A,z,!0)}function q(){function a(){b--,e.css("width",b+"%"),20>b?e.removeClass("progress-bar-warning").addClass("progress-bar-danger"):60>b&&e.removeClass("progress-bar-success").addClass("progress-bar-warning"),B&&(-1==c&&(c=b+1),f.css("width",c-b+"%")),b>0?setTimeout(a,d):(h(G),k(z),A?o(A,z,!0):D=!0)}var b=100,c=-1,d=w/100,e=$("#publish-q-progress"),f=$("#publish-q-progress-answered"),g=null,i=0,j=0;e.css("width","100%"),f.css("width","0%"),setTimeout(a,d),I.contents().each(function(){$(this).replaceWith($(this).text().replace(/(\S)/g,"<span>$1</span>"))}),I.append('<span class="cur">_</span>'),g=I.find(".cur"),i=setInterval(function(){g&&g.toggle()},200),j=I.children().size();for(var l=0;j>l;l++){var m=I.children("span:eq("+l+")");l==j-1?setTimeout(function(){m.hide(),clearInterval(i)},50*l+2e3):m.delay(50*l).fadeIn(10)}}function r(a){var d=$("#publish-q-seq");if(I=$("#publish-q-text"),G=a.find(".btn-question").hide(),E){d.hide(),$("#publish-q-progress").hide(),$("#publish-q-ranking").hide(),a.find(".publish-q-animation").hide(),$("#publish-q-back").show(),$("#publish-q-back-btn").click(function(){b.backToMypage()});for(var e=0;e<E.answers.length;e++){var g=$("#answer-"+(e+1)).show();g.find(".answer-seq").text(e+1+"."),g.find(".answer").text(E.answers[e])}E.userAnswer&&(H=$("#answer-"+E.userAnswer)),k(E.answerCounts),h(G),o(E,E.answerCounts,!1),I.text(E.question),f(a)}else{if(y){d.text(MSG.format(MSG.questionSeq,y.seq));for(var e=0;e<y.answers.length;e++){var g=$("#answer-"+(e+1)).show();g.find(".answer-seq").text(e+1+"."),g.find(".answer").text(y.answers[e])}I.text(y.question)}A?(a.find(".publish-q-animation").css({"animation-name":"","-webkit-animation-name":""}),k(z),h(G),o(A,z,!1)):y?(a.find(".publish-q-animation").css({"animation-name":"inout","-webkit-animation-name":"inout"}),c.isEventAdmin()?k(z):c.userEventId?G.click(l):h(G)):($("#publish-q-default").hide(),$("#publish-q-none").show()),$("#publish-q-ranking").click(function(){b.showRanking()})}}function s(){A||E||(C=(new Date).getTime(),q())}function t(){G=null,H=null,I=null}function u(a){y=a,z={},A=null,B=!1,C=0,D=!1,E=null}function v(a){E=a}var w=1e4,x=5,y=null,z={},A=null,B=!1,C=0,D=!1,E=null,G=null,H=null,I=null;$.extend(this,{init:r,afterShow:s,clear:t,receiveAnswer:m,receiveAnswerDetail:p,setQuestion:u,setLookback:v})}function w(a,b,c){function d(){return b.isEventRunning()&&!b.isEntryEvent()}function e(){d()&&$(".entry-event").show()}function f(){$(".entry-event").hide()}function g(d){var e={userId:b.userId,username:b.username,userImage:b.userImage,eventId:b.eventId};d&&(e.passcode=d),c.request({command:"entryEvent",data:e,success:function(c){c.error?a.showMessage(c.error):c.requirePass?a.showPasscode():c.userEventId?(b.userEventId=c.userEventId,d&&a.showChat()):alert("Invalid data: "+JSON.stringify(c))}})}function h(){d()&&(g(),$("#entry-event-alert").hide())}function i(){$("#event-passcode-btn").click(function(){var b=$("#event-passcode-user").val();b?g(b):a.showMessage(MSG.invalidPasscode)}),$("#event-cancel-btn").click(function(){a.showChat()})}function j(){}$(".entry-event-btn").click(h),$("#not-entry-event").click(function(){$("#entry-event-alert").hide()}),d()&&e(),$.extend(this,{init:i,clear:j,openEvent:e,closeEvent:f})}function x(a,b,d){function f(a){if(a){for(var b in a){var c=$("#event-"+b);c.length&&c.val(a[b])}if(a.execDate){var d=new i(a.execDate);$("#event-date").val(d.dateStr()),$("#event-time").val(d.timeStr())}}}function g(){var a=$("#event-date").val(),c=$("#event-time").val(),d={id:b.eventId||0,roomId:b.roomId,status:b.eventStatus};return m.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6),c=a.val();c&&(d[b]=a.val())}),a&&(c&&(a+=" "+c),d.execDate=new Date(a).getTime()),d.capacity=parseInt(d.capacity),d}function h(){b.eventStatus==G.Prepared&&(b.eventId?d.request({command:"openEvent",data:{id:b.eventId,admin:b.userId},success:function(b){b?a.showQuestionList():a.showMessage(MSG.failOpenEvent)}}):j(!0))}function j(c){if(n&&n.form()){var e=g();d.request(e.id?{command:"updateEvent",data:e,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"createEvent",data:e,success:function(d){b.eventId=d.id,b.eventStatus=d.status,c?h():a.showMessage(MSG.successUpdate)}})}}function k(a){m=a.find("form"),c(m.find(":input")),n=m.validate({rules:{"event-capacity":{required:!0,digits:!0},"event-title":{maxlength:100},"event-date":{date:!0},"event-time":{time:!0},"event-passcode":{maxlength:100},"event-description":{maxlength:400}},focusInvalid:!0}),e(a),$("#event-start-btn").click(h),$("#event-update-btn").click(function(){j(!1)}),d.request({command:"getCurrentEvent",success:f})}function l(){m=null,n=null}var m=null,n=null;$.extend(this,{init:k,clear:l})}function y(a,b,c){function d(a,b,c){for(var d=0;d<b.length;d++){var e=b[d],f=$("<tr><td class='r-rank'/><td class='r-name'/><td class='r-correct'/><td class='r-time'/></tr>"),h=f.find(".r-rank"),i=f.find(".r-name"),j=$("<img/>");h.text(e.correctCount>0?c+d+1:"-"),j.attr("src",e.imageUrl),i.append(j),i.append(e.username),e.correctCount&&(f.find(".r-correct").text(e.correctCount),f.find(".r-time").text(g(e.time))),a.append(f)}}function e(a,e,f){var g;
"boolean"==typeof f&&(g=f?"right":"left"),c.request({command:"getEventRanking",data:{eventId:b.eventId,offset:a,limit:e},success:function(b){var c=$("#event-members-tbl"),e=c.find("tbody");e.empty(),g&&c.hide(),d(e,b,a),g&&c.show("slide",{direction:g},D)}})}function f(){b.isEventRunning()&&c.request({command:"closeEvent",data:b.eventId,success:function(b){b&&a.showRanking()}})}function h(a){$("#event-finish-btn").click(f),c.request({command:"getMemberCount",data:b.eventId,success:function(b){j=new k(a.find(".paging-bar"),b,e,10),e(0,10)}})}function i(){j=null}var j=null;$.extend(this,{init:h,clear:i})}function z(a,b,c,d){function e(a,b,c){c?3>=b?a.html("<span class='badge circle rank-blue'>"+b+"</span>"):a.text(b):a.text("-"),a.attr("data-sortAs",b)}function h(){var a=$(this),b=parseInt(a.attr("data-eventId"));d.request({command:"getEventRanking",data:{eventId:b,limit:10},success:function(a){l($("#ranking-event-detail-tbl"),a),A.find(".tab-pane").hide(),$("#ranking-event-detail").show("slide",{direction:"right"},D)}})}function j(){var a=$(this),e=parseInt(a.attr("data-userId")),f=c[e];d.request({command:"getUserEvent",data:{roomId:b.roomId,userId:e},success:function(b){p(b),$("#ranking-user-img").attr("src",f.getBiggerImageUrl()),$("#ranking-user-name").text(f.name),$("#ranking-user-point").text(a.attr("data-point")),A.find(".tab-pane").hide(),$("#ranking-user").show("slide",{direction:"right"},D)}})}function k(a,b,d){for(var f=$("<tr></tr>"),h=0;h<b.length;h++){var j=$("<td></td>"),k=b[h],l=null;if($.isArray(k)&&(l=k[1],k=k[0]),l||(l=x[k]),l||(l="r-"+k),j.addClass(l),"username"==k&&a.username){var m=$("<img/>");m.attr("src",a.imageUrl),j.append(m),j.append(a.username)}else"title"==k?j.text(a.title||new i(a.execDate).datetimeStr()):"rank"==k?e(j,d,a.correctCount):"time"==k&&a.time?j.text(g(a.time)):a[k]&&j.text(a[k]);f.append(j)}return c[a.userId]||(c[a.userId]=new n({id:a.userId,name:a.username,imageUrl:a.imageUrl})),f}function l(a,b,c){var d=a.find("tbody"),f={};if(d.empty(),c&&y)for(var h=0;h<y.length;h++){var i=y[h],j=k(i,t,h+11);f[i.userId]=j,d.append(j)}for(var h=0;h<b.length;h++){var i=b[h],j=f[i.userId];j?(e(j.find(".r-rank"),h+1,i.correctCount),j.find(".r-correct").text(i.correctCount),j.find(".r-time").text(g(i.time))):(j=k(i,t,h+1),d.append(j)),j.addClass("new")}c&&(setTimeout(function(){a.tableSort({sortBy:["numeric","nosort","nosort","nosort"]}),a.find("thead th:first").click(),setTimeout(function(){var a=d.find("tr").not(".new");a.hide("slow",function(){a.remove()})},200)},200),y=b,z=null)}function m(a){var c=$("#ranking-event-tbl").find("tbody");c.empty();for(var d=0;d<a.length;d++){var e=a[d],f=null;e.eventId!=b.eventId&&(f=k(e,u),f.attr("data-eventId",e.eventId),f.click(h),c.append(f))}}function o(a){var b=$("#ranking-total-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],e=k(d,v,c+1);e.attr("data-userId",d.userId),e.attr("data-point",d.point),e.click(j),b.append(e)}}function p(a){function c(a){for(var b=0;b<e.length;b++){var c=$(e[b]);if(c.attr("data-eventId")==a)return c.find(".r-title").text()}return"Unknown"}var d=$("#ranking-user-tbl").find("tbody"),e=$("#ranking-event-tbl").find("tbody tr");d.empty();for(var f=0;f<a.length;f++){var g=a[f],h=null,i=g.point>0?10-g.point+1:"-";g.eventId!=b.eventId&&(g.title=c(g.eventId),h=k(g,w,i),d.append(h))}}function q(){B=$("#ranking-now-tbl"),b.isEventRunning()?d.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(a){a.length&&(z=a),C&&l(B,z,!0)}}):$(".ranking-now").hide(),d.request({command:"getEventWinners",data:{roomId:b.roomId,limit:10},success:m}),d.request({command:"getTotalRanking",data:{roomId:b.roomId,limit:10},success:o}),$("#ranking-event-detail-back").click(function(){A.find(".tab-pane").hide(),$("#ranking-event").show("slide",{direction:"left"},D)}),$("#ranking-user-back").click(function(){A.find(".tab-pane").hide(),$("#ranking-total").show("slide",{direction:"left"},D)}),f($("#ranking-event-detail")),f($("#ranking-user")),A=$("#ranking-tab").tabs({active:b.isEventRunning()?0:1,beforeActivate:function(){A.find(".tab-pane").hide()}}).show()}function r(){z&&l(B,z,!0),C=!0}function s(){A=null,B=null,C=!1}var t=["rank","username","correctCount","time"],u=["title",["username","r-winners"],"correctCount","time"],v=["rank","username","point","correctCount"],w=["title","rank","point","correctCount"],x={username:"r-name",correctCount:"r-correct"},y=null,z=null,A=null,B=null,C=!1;$.extend(this,{init:q,afterShow:r,clear:s})}function A(){function a(a,b,d){c&&c.log(a,b,d)}function b(a){c=a}var c=null;$.extend(this,{log:a,setImpl:b})}function B(a,b){function c(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),f>d&&e.find("tr:first").remove();var g=$("<tr><td></td><td></td><td><div class='pull-right'></div></td></tr>"),h=g.find("td");$(h.get(0)).text(a),$(h.get(1)).text(b),c&&$(h.get(2)).find("div").text(c),e.append(g),f++,console.log(a+", "+b+(c?", "+c+"ms":""))}var d=10,e=a.find("table tbody"),f=0;b.onRequest(function(a,b){var d=a;b&&(d+=", "+JSON.stringify(b)),c("send",d)}).onMessage(function(a,b){var d=(new Date).getTime();c("receive",JSON.stringify(a),d-b)}),$("#chk-use-ajax").bootstrapSwitch().on("switchChange",function(){var a=$(this).is(":checked");b.useAjax(a?"/ajax":!1)}),$("#btn-debug-msg").click(function(){$("#effect-dialog").animateDialog("Start!",{name:"rotateZoom"});var a=$(".publish-q-animation");a.css({"animation-name":"inout","-webkit-animation-name":"inout"}),a.hide(),setTimeout(function(){a.show()},0)}),$.extend(this,{log:c})}$.validator.addMethod("quizChoices",function(a){if(!a||0==a.length)return!1;var b=a.split("\n").filter(function(a){return a.length>0});return b.length<=1||b.length>5?!1:!0},MSG.invalidQuizChoices),$.validator.addMethod("time",function(a,b){return this.optional(b)||/^\d{2}:\d{2}$/.test(a)},MSG.invalidTime);var C="ontouchstart"in window,D=300,E="/assets/images/twitter_default_profile.png",F={FirstRow:0,Most:1,Least:2,NoAnswer:3},G={Prepared:0,Running:1,Finished:2},D=300;flect.QuizApp=function(a){function b(a,b){$.sidr("close");var c=$.extend({name:a},fb[a]);b?c.effect="none":bb.pushDynamic(a),ab.children("div").hide(),W.show(c)}function c(a,b,c){function d(){$.sidr("close"),e.is(":visible")||(ab.children("div").hide(),e.show("slide",{direction:"right"},D,c),bb.pushStatic(a))}var e=$("#"+a);b?$.sidr("close",d):d()}function d(){c("chat",!1,X.calcHeight)}function e(){var a={name:"mypage",direction:"left",beforeShow:P.init,afterHide:P.clear};ab.children("div").hide(),W.show(a),bb.pushState({method:"function",func:e},"/mypage")}function f(a){var b={name:"publish-question",beforeShow:function(b){Z.setLookback(a),Z.init(b)},afterHide:function(){Z.clear(),Z.setLookback(null)}};ab.children("div").hide(),W.show(b),bb.pushState({method:"lookback",qa:a},"/room/"+db.roomId+"/question")}function g(a){if(Z){var b={name:"publish-question",effect:"none",beforeShow:function(b){a&&Z.setQuestion(a),Z.init(b)},afterShow:Z.afterShow,afterHide:Z.clear};ab.children("div").hide(),W.show(b),bb.pushDynamic("publish-question")}}function h(){b("ranking")}function i(a){if(Y){var b=$.extend({name:"edit-question"},fb["edit-question"]);a&&("none"==a?b.effect="none":b.direction=a),ab.children("div").hide(),W.show(b),bb.pushDynamic("edit-question")}}function k(a){R&&(a&&R.edit(a),ab.children("div").hide(),W.show({name:"make-question",beforeShow:R.init,afterHide:R.clear}),bb.pushState({method:"function",func:function(){k(a)}}))}function E(){b("passcode")}function F(a,b){L.show(a,b)}function G(a,b){M.show(a,b)}function H(a,b){X&&X.tweet(a,b)}function I(){if(window.sessionStorage&&sessionStorage.clear(),K=new A,L=new flect.MessageDialog($("#msg-dialog")),M=new l($("#effect-dialog")),N=new flect.Connection(db.uri,K),O=new o(N,eb,db.userId),W=new flect.TemplateManager(N,$("#content-dynamic")),Z=new v(cb,db,N),bb=new j(cb,db),ab=$("#content"),db.isDebug()&&(K.setImpl(new B($("#debug"),N,L)),$("#btn-debug").click(function(){return c("debug",!0),!1}),N.onOpen(function(a){console.log("onOpen"),console.log(a)}).onClose(function(a){console.log("onClose"),console.log(a)}).onSocketError(function(a){console.log("onSocketError"),console.log(a)}).onServerError(function(a){console.log(a),alert(a)})),N.addEventListener("redirect",function(a){location.href=a}),db.isLogined()&&(eb[db.userId]=new n({id:db.userId,name:db.username,imageUrl:db.userImage}),P=new q(cb,db,eb,N),Q=new p(cb,db,eb,N),S=new s(cb,db.userId,N),$("#menu-mypage").click(function(){return b("mypage"),!1}),$("#menu-settings").click(function(){return b("user-setting"),!1})),db.isInRoom()){var a=$("#chat");X=new r(a,db,N),$(".menu-chat").click(function(){return c("chat",$(this).parents("#sidr").length>0,X.calcHeight),!1}),$("#toolbar-ranking").click(function(){return h(),!1}),$("#toolbar-question").click(function(){return db.isRoomAdmin()?((!db.isEventRunning()||db.isEventAdmin())&&i(),!1):(g(),!1)}),N.addEventListener("chat",function(a){X.append(a),a.userId!=db.userId&&X.isNotifyTweet()&&L.notifyTweet(a)}),N.addEventListener("member",X.member),N.addEventListener("newEntry",function(a){var b=new n(a);eb[b.id]=b,L.notifyUserAction(b,MSG.newEntry)}),N.ready(function(){0==X.member()&&N.request({command:"member"})}),N.addEventListener("startEvent",function(a){var b=a.id,c=a.admin;M.show(MSG.start),db.openEvent(b,c==db.userId),R&&R.openEvent(db.eventId),V&&setTimeout(V.openEvent,3e3)}),N.addEventListener("finishEvent",function(){M.show(MSG.finish),db.closeEvent(),R&&R.closeEvent(),V&&V.closeEvent()}),N.addEventListener("question",function(a){g(a)}),N.addEventListener("answer",Z.receiveAnswer),N.addEventListener("answerDetail",Z.receiveAnswerDetail),_=new z(cb,db,eb,N)}(db.isRoomAdmin()||db.isPostQuestionAllowed())&&(R=new u(cb,db,N),db.isEventRunning()&&R.openEvent(db.eventId)),db.isRoomAdmin()&&(Y=new t(cb,eb,db,N),T=new x(cb,db,N),N.addEventListener("postQuestion",function(a){var b=a,c=eb[b];Y.reload(),c?L.notifyUserAction(c,MSG.postQuestionMessage):N.request({command:"getUser",data:b,success:function(a){var b=new n(a);eb[b.id]=b,L.notifyUserAction(b,MSG.postQuestionMessage)}})}),U=new y(cb,db,N)),db.canEntryEvent()&&(V=new w(cb,db,N)),$("#btn-menu").sidr({onOpen:function(){$("#toolbar").css("left","260px"),$("#tabbar").css("left","260px")},onClose:function(){$("#toolbar").css("left","0px"),$("#tabbar").css("left","0px")}}),$("#content").swipe({swipeLeft:function(){$.sidr("close")},swipeRight:function(){$.sidr("open")},tap:function(a,b){$.sidr("close"),C&&$(b).click()}}),N.polling(25e3,{command:"noop",log:"user="+(db.isLogined()?db.username:"(Anonymous)")}),$("#sidr a.dynamic").click(function(){var a=$(this).attr("href").substring(1);return $.sidr("close",function(){b(a)}),!1}),$(".dropdown-button").click(function(){return $(this).next("ul").toggle(),!1}),$(".dropdown-menu a").click(function(){var a=$(this);return a.parents(".dropdown-menu").hide(),"#"!=a.attr("href")})}function J(a){function c(){location.href=db.isInRoom()?"/room/"+db.roomId:"/"}var e=location.pathname;if("/"==e||"/home"==e)b("home",a);else if("/mypage"==e)db.isLogined()?b("mypage",a):c();else if("/makeRoom"==e)db.isLogined()?b("make-room",a):c();else if("/userSetting"==e)db.isLogined()?b("user-setting",a):c();else if("/help"==e)b("help",a);else{var f=e.substring(1).split("/");switch(2==f.length&&f.push(db.isRoomAdmin()?"questionList":"chat"),f[2]){case"question":b("publish-question",a);break;case"ranking":b("ranking",a);break;case"chat":a?($("#chat").show(),X.calcHeight()):d();break;case"editRoom":db.isRoomAdmin()?b("edit-room",a):c();break;case"event":db.isRoomAdmin()?b("edit-event",a):c();break;case"questionList":db.isRoomAdmin()?b("edit-question",a):c();break;case"postQuestion":!db.isRoomAdmin()&&db.isPostQuestionAllowed()?b("post-question",a):c()}}}var K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ab,bb,cb=this,db=new m(a),eb={};if(!window.WebSocket)return void $("#content").prepend("<div class='alert alert-danger'>"+MSG.websocketNotSupported+"</div>");I(),K.log("params",db);var fb={home:{beforeShow:O.init,afterHide:O.clear}};db.isLogined()&&$.extend(fb,{mypage:{beforeShow:function(a){P.reset(),P.init(a)},afterHide:P.clear},"user-setting":{beforeShow:Q.init,afterHide:Q.clear},"make-room":{beforeShow:function(a){S.clear(),S.init(a)},afterHide:S.clear},"publish-question":{name:"publish-question",beforeShow:Z.init,afterHide:Z.clear},"edit-room":{name:"make-room",beforeShow:function(a){S.clear(),S.edit(db.roomId),S.init(a)},afterHide:S.clear}}),db.isRoomAdmin()?($.extend(fb,{"edit-question":{beforeShow:Y.init,afterHide:Y.clear}}),$.extend(fb,{"edit-event":{beforeShow:function(a){db.isEventRunning()?U.init(a):T.init(a)},name:function(){return db.isEventRunning()?"event-members":"edit-event"},afterHide:function(){db.isEventRunning()?U.clear():T.clear()}}})):db.isPostQuestionAllowed()&&$.extend(fb,{"post-question":{name:"make-question",beforeShow:R.init,afterHide:R.clear}}),db.isInRoom()&&$.extend(fb,{ranking:{name:"ranking",beforeShow:_.init,afterShow:_.afterShow,afterHide:_.clear}}),V&&$.extend(fb,{passcode:{name:"passcode",beforeShow:V.init,afterHide:V.clear}}),$.extend(this,{showQuestionList:i,showMakeQuestion:k,showPasscode:E,showChat:d,showRanking:h,showQuestion:g,showLookback:f,showMessage:F,showEffect:G,showDynamic:b,showStatic:c,showInitial:J,backToMypage:e,tweet:H}),N.ready(function(){J(!0)})}});