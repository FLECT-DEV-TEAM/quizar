/*! quizar 2014-03-24 */
"undefined"==typeof flect&&(flect={}),$(function(){function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}flect.Connection=function(b,c){function d(){if(0==arguments.length)return y;var a=arguments[0];return y=a?a:null,t}function e(a){return q()?(u.onRequest&&u.onRequest(a.command,a.data),y?f(a):g(a),t):(o(function(){e(a)}),void(socket=r()))}function f(b){c.log("ajax",b.command);var d=(new Date).getTime(),e=++v,f=b.url?b.url:y,g=b.success;if(b.command&&(a(f,"/")||(f+="/"),f+=b.command,delete b.command),f+="?id="+e,b.log&&(f+="&log="+b.log,delete b.log),b.url=f,b.type||(b.type="POST"),b.data){var h=JSON.stringify(b.data);b.data={data:h}}b.success=function(a){if(u.onMessage&&u.onMessage(a,d),a){if("error"==a.type)return void(u.onServerError&&u.onServerError(a.data));var c=g;c||(c=x[b.command]),c&&c(a.data)}},$.ajax(b)}function g(a){c.log("ws",a.command);var b=(new Date).getTime(),d=++v;w[d]=b,a.success&&(x[d]=a.success);var e={id:d,command:a.command,data:a.data};a.log&&(e.log=a.log),socket.send(JSON.stringify(e))}function h(a,b){return x[a]=b,t}function i(a){return delete x[a],t}function j(a){A=0;for(var b=0;b<z.length;b++)z[b]();z=[],u.onOpen&&u.onOpen(a)}function k(a){var b=JSON.parse(a.data),d=w[b.id],e=null;return d&&delete w[b.id],u.onMessage&&u.onMessage(b,d),"error"==b.type?void(u.onServerError&&u.onServerError(b.data)):(b.id&&x[b.id]?(e=x[b.id],delete x[b.id]):b.command&&x[b.command]&&(e=x[b.command]),void(e?e(b.data):c.log("UnknownMessage",a.data)))}function l(a){u.onClose&&u.onClose(a),s>A&&(A++,setTimeout(function(){socket=r()},1e3*A))}function m(a){u.onSocketError&&u.onSocketError(a)}function n(a,b){return setInterval(function(){e($.extend(!0,{},b))},a)}function o(a){q()?a():z.push(a)}function p(){q()&&(A=s,socket.close())}function q(){return 1==socket.readyState}function r(){var a=new WebSocket(b);return a.onopen=j,a.onmessage=k,a.onerror=m,a.onclose=l,a}var s=5,t=this,u={},v=0,w={},x={},y=null,z=[],A=0;socket=r(),$.extend(this,{useAjax:d,request:e,addEventListener:h,removeEventListener:i,polling:n,ready:o,close:p,isConnected:q,onOpen:function(a){return u.onOpen=a,this},onClose:function(a){return u.onClose=a,this},onRequest:function(a){return u.onRequest=a,this},onMessage:function(a){return u.onMessage=a,this},onSocketError:function(a){return u.onSocketError=a,this},onServerError:function(a){return u.onServerError=a,this}})}}),"undefined"==typeof flect&&(flect={}),$(function(){function a(){function a(a){return c[a]}function b(a,b){c[a]=b}var c={};$.extend(this,{getItem:a,setItem:b})}var b=300;flect.TemplateManager=function(c,d){function e(a){"string"==typeof a&&(a={name:a});var b=a.name;"function"==typeof b&&(b=b());var c=h.getItem("template."+b);c?g(c,a):f(b,function(c){h.setItem("template."+b,c),g(c,a)})}function f(a,b){c.request({command:"template",log:a,data:{name:a},success:b})}function g(a,c){function e(){c.afterShow&&c.afterShow(d)}i&&i(d),d.hide(),j&&j(d),d.empty(),d.html(a),c.beforeShow&&c.beforeShow(d),i=c.beforeHide,j=c.afterHide,setTimeout(function(){var a=c.direction||"right",f=c.effect;"none"==f?d.show(0,e):d.show("slide",{direction:a},b,e)},0)}var h=window.sessionStorage?window.sessionStorage:new a,i=null,j=null;$.extend(this,{show:e,loadTemplate:f})}}),"undefined"==typeof flect&&(flect={}),$(function(){flect.MessageDialog=function(a){function b(b){b=b||3,a.css({"animation-name":"fade","-webkit-animation-name":"fade","animation-duration":b+"s","-webkit-animation-duration":b+"s"}),a.show(),setTimeout(function(){if(a.hide(),a.css("animation-name",""),a.css("-webkit-animation-name",""),f=!1,g.length>0){var b=g;g=[],setTimeout(function(){c(b)},10)}else if(h.length>0){var b=h;h=[],setTimeout(function(){d(b)},10)}},1e3*b)}function c(c,d){if(f)return void g.push(c);f=!0,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var h=$("<span class='message'></span>");h.text(c[e]),a.append(h)}b(d)}function d(c,d){if(f)return void h.push(c);f=!0,d=d||3,$.isArray(c)||(c=[c]),a.empty();for(var e=0;e<c.length;e++){var g=c[e],i=$("<div class='tweet'><img/><p></p><p></p></div>");i.find("img").attr("src",g.img),i.find("p:first").text(g.username),i.find("p:last").text(g.msg),a.append(i)}b(d)}function e(a,b){d({userId:a.id,username:a.name,msg:b,img:a.imageUrl})}var f=!1,g=[],h=[];$.extend(this,{show:c,notifyTweet:d,notifyUserAction:e})}}),$(function(){function a(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}function b(a){return a.split("\n").filter(function(a){return a.length>0}).join("\n")}function c(a){return a.each(function(){var a=$(this),b=a.attr("id");b&&a.attr("name",b)}),a}function d(a){for(var b in a)delete a[b]}function e(a,b){b||(b=a.find(".option-panel"),a=a.find(".option-ctrl")),a.click(function(){var c=a.find("i");c.hasClass("fa-caret-down")?(c.removeClass("fa-caret-down").addClass("fa-caret-up"),a.addClass("active")):(c.removeClass("fa-caret-up").addClass("fa-caret-down"),a.removeClass("active")),b.slideToggle()})}function f(a){return Math.round(a/10)/100}function g(a,b){a.show("slide",{direction:b},A)}function h(){function a(){var a=e.getFullYear(),b=e.getMonth()+1,c=e.getDate();return 10>b&&(b="0"+b),10>c&&(c="0"+c),a+"-"+b+"-"+c}function b(){var a=e.getHours(),b=e.getMinutes();return 10>a&&(a="0"+a),10>b&&(b="0"+b),a+":"+b}function c(){return a().substring(5)+" "+b()}function d(){return e.getTime()}var e;switch(arguments.length){case 1:e=new Date(arguments[0]);break;case 2:e=new Date(arguments[0]+" "+arguments[1])}$.extend(this,{dateStr:a,timeStr:b,datetimeStr:c,getTime:d})}function i(b,c,d,e){function f(){l>0&&(l-=e,d(l,e,!1),h())}function g(){c>l+e&&(l+=e,d(l,e,!0),h())}function h(){a(m,l>0),a(n,c>l+e)}function i(){return 0==arguments.length?c:(c=arguments[0],this)}function j(){return{swipeLeft:function(a){g(),a.stopImmediatePropagation()},swipeRight:function(a){f(),a.stopImmediatePropagation()},tap:function(a,b){z&&$(b).click()}}}function k(){m=null,n=null}var l=0,m=b.find(".paging-bar-left"),n=b.find(".paging-bar-right");e=e||10,m.click(f),n.click(g),h(),$.extend(this,{prev:f,next:g,recordCount:i,swipeParams:j,release:k})}function j(a){function b(b,c){c||(c=5),a.animateDialog(b,{name:"rotateZoom",duration:c+"s"})}$.extend(this,{show:b})}function k(a){function b(){return!!n.userId}function c(){return!!n.userEventId}function d(){return n.eventStatus==D.Running}function e(){return!!n.eventAdmin}function f(){return!!n.roomId}function g(){return!!n.roomAdmin}function h(){return!!n.userQuiz}function i(){return!!n.debug}function j(a,b){n.eventId=a,n.eventStatus=D.Running,n.eventAdmin=b}function k(){n.eventId=0,n.eventStatus=D.Prepared,n.userEventId=0,n.eventAdmin=!1}function l(a){n.userEventId=a}function m(){return b()&&f()&&!g()}var n=this;$.extend(this,a,{isLogined:b,isEntryEvent:c,isEventRunning:d,isEventAdmin:e,isInRoom:f,isRoomAdmin:g,isPostQuestionAllowed:h,isDebug:i,openEvent:j,closeEvent:k,entryEvent:l,canEntryEvent:m}),this.eventStatus||(this.eventStatus=D.Prepared)}function l(a){function b(){return this.imageUrl}function c(){return this.imageUrl.replace("_mini","_normal")}function e(){return this.imageUrl.replace("_mini","_bigger")}$.extend(this,a,{getMiniImageUrl:b,getNormalImageUrl:c,getBiggerImageUrl:e}),d(a)}function m(a,b,c){function d(){var a=$(this).attr("data-id");a&&(location.href="/room/"+a)}function e(){var a=n.tabs("option","active"),b=$(0==a?"#event-future":"#event-yours");$("#event-detail").hide(),g(b,"left")}function f(a){$("#room-detail-enter").attr("data-id",a.id),$("#room-detail-name").text(a.name),a.userQuiz&&$("#room-detail-userQuiz").attr("checked","checked"),$("#room-detail-description").val(a.description||""),a.event?($("#room-detail-event").show(),$("#room-detail-title").text(a.event.title||"-"),$("#room-detail-date").text(a.event.exceDate?new h(a.event.execDate).datetimeStr():"-"),$("#room-detail-capacity").text(a.event.capacity),$("#room-detail-description2").val(a.event.description||"")):$("#room-detail-event").hide(),n.find(".tab-pane").hide(),g($("#event-detail"),"right")}function i(a){a.find("tbody tr").click(function(){var a=$.data(this,"room");a&&f(a)})}function j(c,d){for(var e=c.find("tbody"),f={},g=0;g<d.length;g++){var i=d[g],j=$("<tr><td class='event-date'></td><td class='event-title'><img src='"+B+"'/></td><td class='event-capacity'></td></tr>"),k=j.find("img"),m=MSG.undecided,n=i.name,o="";i.event&&(i.event.title&&(n+="("+i.event.title+")"),i.event.status==D.Running?m=MSG.eventRunning:i.event.execDate&&(m=new h(i.event.execDate).datetimeStr()),i.event.capacity&&(o=""+i.event.capacity+MSG.people)),j.attr("data-room",i.id),j.find(".event-date").text(m),j.find(".event-title").append(n),j.find(".event-capacity").text(o),b[i.owner]?k.attr("src",b[i.owner].getMiniImageUrl()):f[i.owner]?k.attr("data-userId",i.owner):(f[i.owner]=!0,k.attr("data-userId",i.owner),a.request({command:"getUser",data:i.owner,success:function(a){var d=new l(a);b[d.id]=d,c.find("[data-userId="+d.id+"]").attr("src",d.getMiniImageUrl()).removeAttr("data-userId")}})),$.data(j[0],"room",i),e.append(j)}}function k(b){var f=$("#event-future"),g=$("#event-yours");a.request({command:"listRoom",data:{limit:10,offset:0},success:function(a){j(f,a),i(f),n=b.find(".tab-content").tabs({beforeActivate:function(){n.find(".tab-pane").hide()}}).show()}}),c&&a.request({command:"listRoom",data:{limit:10,offset:0,userId:c},success:function(a){j(g,a),i(g)}}),$("#room-detail-enter").click(d),$("#room-detail-back").click(e)}function m(){n=null}var n=null;$.extend(this,{init:k,clear:m})}function n(a,b,c,d){function e(a,b,d){a.empty();for(var e=0;e<d.length;e++){for(var f=d[e],g=$("<tr></tr>"),i=0;i<b.length;i++){var j=b[i],k=$("<td></td>");if(k.addClass(j),"r-room"==j){var m=$("<img/>");m.attr("src",f.ownerImage),k.append(m),k.append(f.roomName)}else if("r-title"==j)k.text(f.title||new h(f.execDate).datetimeStr());else if("r-point"==j)k.text(f.point);else if("r-correct"==j)k.text(f.correctCount);else if("r-event"==j)k.text(f.eventCount);else if("r-question"==j)k.text(f.questionCount);else if("q-text"==j)k.text(f.question);else if("q-correct"==j&&f.userAnswer){var n=f.correct?"fa-circle-o":"fa-times",o=$("<i class='fa'></i>");o.addClass(n),k.append(o)}c[f.owner]||(c[f.owner]=new l({id:f.owner,name:f.ownerName,imageUrl:f.ownerImage})),g.append(k)}a.append(g),$.data(g[0],"obj",f)}}function f(){var a=$.data(this,"obj");location.href="/room/"+a.roomId}function i(a,b){var c=$("#mypage-events tbody");$("#mypage-events-roomName").text(a.name),$("#mypage-events-total").text(a.rank?a.rank:"-"),e(c,t,b),c.find("tr").click(m)}function j(){var a=$.data(this,"obj"),c=$("#mypage-events-total");c.text("-"),d.request({command:"getUserEvent",data:{roomId:a.roomId,userId:b.userId},success:function(b){var c=$("#mypage-events"),d=c.find("tbody");x=b,$("#mypage-events-roomName").text(a.roomName),e(d,t,b),v.find(".tab-pane").hide(),d.find("tr").click(m),g(c,"right")}}),d.request({command:"getUserTotalRanking",data:{roomId:a.roomId,userId:b.userId},success:function(b){b&&c.text(b),w={id:a.roomId,name:a.roomName,rank:b}}})}function k(a){var b=$("#mypage-questions tbody");e(b,u,a),b.find("tr").click(n)}function m(){var a=$.data(this,"obj");d.request({command:"getEventQuestions",data:{eventId:a.eventId,userId:b.userId},success:function(a){var b=$("#mypage-questions"),c=b.find("tbody");y=a,e(c,u,a),c.find("tr").click(n),v.find(".tab-pane").hide(),g(b,"right")}})}function n(){var b=$.data(this,"obj");d.request({command:"getLookback",data:b.publishId,success:function(c){c.userAnswer=b.userAnswer,a.showLookback(c)}})}function o(a){v=a.find(".tab-content").tabs({beforeActivate:function(){v.find(".tab-pane").hide()}}),d.request({command:"entriedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-entries tbody");e(b,r,a),b.find("tr").click(j),v.show()}}),d.request({command:"ownedRooms",data:{limit:100,offset:0,userId:b.userId},success:function(a){var b=$("#mypage-owners tbody");e(b,s,a),b.find("tr").click(f)}}),$("#mypage-events-back").click(function(){w=null,x=null,v.find(".tab-pane").hide(),g($("#mypage-entries"),"left")}),$("#mypage-questions-back").click(function(){y=null,v.find(".tab-pane").hide(),g($("#mypage-events"),"left")}),w&&x&&(v.find(".tab-pane").hide(),i(w,x),y?(k(y),$("#mypage-questions").show()):$("#mypage-events").show())}function p(){v=null}function q(){w=null,x=null,y=null}var r=["r-room","r-point","r-correct"],s=["r-room","r-event","r-question"],t=["r-title","r-point","r-correct"],u=["q-text","q-correct"],v=null,w=null,x=null,y=null;$.extend(this,{init:o,clear:p,reset:q})}function o(a,b,c,d){function e(a,c){b&&d.request({command:"tweet",data:{userId:b,msg:a,twitter:c}})}function f(){return a.is(":hidden")&&$("#chat-notify").is(":checked")}function g(a){return 0==arguments.length?o.text():void o.text(a)}function h(a){j>i&&n.find("li:first").remove();var c=a.userId==b?"align-left":"align-right",d=$("<li style='display:none;'><div class='contributor'><img/><span/></div><div class='balloon'><div class='balloon-border'><p class='text'></p></div></div></li>"),e=d.find("img"),f=d.find(".contributor span"),g=d.find(".text");d.addClass(c),f.text(a.username),e.attr("src",a.img),g.text(a.msg),n.append(d),d.show("slow"),j++}var i=20,j=0,k=$("#chat-text"),l=$("#chat-twitter"),m=$("#chat-text-len"),n=a.find(".tweet-box ul"),o=$("#room-member");b&&($("#btn-tweet").click(function(){var a=k.val(),b=l.is(":checked");0==a.length||a.length>140||a==c||(k.val(c),e(a,b))}),k.keyup(function(){var a=140-k.val().length;0>=a?m.addClass("error"):m.removeClass("error"),m.text(a)})),c?"#"!=c.charAt(0)&&(c="#"+c):c="",k.val(c),$.extend(this,{member:g,append:h,tweet:e,isNotifyTweet:f})}function p(a,b,d){function f(a){return a.attr("id").substring(5)}function g(){if(m&&m.form()){var c=l||{id:-1,owner:b};j.find(":input").each(function(){var a=$(this),b=f(a);a.is(":checkbox")?c[b]=a.is(":checked"):a.val()&&(c[b]=a.val())}),d.request(l?{command:"updateRoom",data:c,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"makeRoom",data:c,success:function(a){a.id&&(d.close(),location.href="/room/"+a.id)}})}}function h(a){if(k&&!l)return void d.request({command:"getRoom",data:k,success:function(b){l=b,h(a)}});j=$("#make-room-form"),c(j.find(":input")).each(function(){var a=$(this);if(l){var b=f(a);l[b]&&(a.is(":checkbox")?a.attr("checked","checked"):a.val(l[b]))}}),m=j.validate({rules:{"room-name":{required:!0,maxlength:100},"room-tags":{maxlength:100},"room-hashtag":{maxlength:20},"room-description":{maxlength:400}},focusInvalid:!0});var b=$("#btn-make-room").click(g),i=$("#make-room-desc");l?($("#room-admin").show(),i.text(MSG.makeRoomDescForEdit),b.text(MSG.update)):($("#room-admin").hide(),i.text(MSG.makeRoomDescForCreate),b.text(MSG.create)),e(a)}function i(){j=null,m=null,k=0,l=null}var j=null,k=0,l=null,m=null;$.extend(this,{init:h,clear:i,edit:function(a){k=a}})}function q(b,c,d,e){function f(f,g){function h(a){for(var b=0;b<s.length;b++){var c=s[b];if(c.id==a)return c}return null}function i(a,i){var j=$("<tr><td class='q-creator'><img src='"+B+"'/></td><td class='q-text'></td>"+(g?"<td class='q-answerer'></td>":"<td class='q-publish'><button class='btn blue'>"+MSG.publish+"</button></td>")+"</tr>"),k=j.find("img");if(j.attr("data-id",a.id),j.attr("data-at",a.answerType),j.find(".q-text").text(a.question),c[a.createdBy]?k.attr("src",c[a.createdBy].getMiniImageUrl()).after(c[a.createdBy].name):i[a.createdBy]?k.attr("data-userId",a.createdBy):(i[a.createdBy]=!0,k.attr("data-userId",a.createdBy),e.request({command:"getUser",data:a.createdBy,success:function(a){var b=new l(a);c[b.id]=b,f.find("[data-userId="+b.id+"]").attr("src",b.getMiniImageUrl()).removeAttr("data-userId").after(b.name)}})),g){var m=a.correctCount+"/"+a.publishCount;j.find(".q-answerer").text(m),publishedQuestions[a.id]&&j.addClass("q-published")}else d.isEventRunning()?j.find("button").click(function(){var a=$(this).parents("tr"),c=parseInt(a.attr("data-id")),f=a.attr("data-at");e.request({command:"publishQuestion",data:{questionId:c,eventId:d.eventId,includeRanking:f!=C.NoAnswer},success:function(a){"OK"!=a&&b.showMessage(a)}})}):j.find("button").attr("disabled","disabled").removeClass("blue").addClass("disabled");j.click(function(){var a=$(this).attr("data-id");b.showMakeQuestion(h(a))}),t.append(j)}function j(a,b,c){e.request({command:"listQuestion",data:{published:g,offset:a,limit:b},success:function(a){var b=t.parents("table"),d={};s=a,t.empty(),c&&b.hide();for(var e=0;e<a.length;e++)i(a[e],d);c&&b.show("slide",{direction:c},A)}})}function k(){r>0&&(r-=m,j(r,m,"left"),p())}function n(){q>r+m&&(r+=m,j(r,m,"right"),p())}function o(){return 0==arguments.length?q:(q=arguments[0],this)}function p(){a($btnPrev,r>0),a($btnNext,q>r+m)}var q=0,r=0,s=[],t=f.find("table tbody");f.swipe({swipeLeft:function(a){n(),a.stopImmediatePropagation()},swipeRight:function(a){k(),a.stopImmediatePropagation()},tap:function(a,b){z&&$(b).click()}}),$.extend(this,{prev:k,next:n,load:j,count:o,activate:p})}function g(){var a=$tab.tabs("option","active");return 0==a?n:publishedTable}function h(a){e.request({command:"countQuestion",success:function(b){n.count(b.count-b.published),publishedTable.count(b.published),$("#question-stock-count").text(n.count()),$("#question-published-count").text(publishedTable.count()),a&&n.activate()}})}function i(a){n=new f($("#edit-question-stock"),!1),publishedTable=new f($("#edit-question-published"),!0),$tab=a.find(".tab-content").tabs({activate:function(){g().activate()}}),h(!0),d.isEventRunning()&&e.request({command:"getPublishedQuestions",data:d.eventId,success:function(a){for(var b=0;b<a.length;b++)publishedQuestions[a[b]]=!0}}),n.load(0,m),publishedTable.load(0,m),$("#edit-question-new").click(function(){b.showMakeQuestion()}),$btnPrev=$("#edit-question-left").click(function(){g().prev()}),$btnNext=$("#edit-question-right").click(function(){g().next()})}function j(){n&&(h(g()==n),n.load(0,m))}function k(){n=null,publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={}}var m=10,n=null;publishedTable=null,$tab=null,$btnPrev=null,$btnNext=null,publishedQuestions={},$.extend(this,{init:i,clear:k,reload:j})}function r(d,f,g){function h(){$("#make-q-question").val(""),$("#make-q-answers").val(""),$("#make-q-answerType").val(C.FirstRow),$("#make-q-tags").val(""),$("#make-q-description").val(""),$("#make-q-relatedUrl").val("")}function i(){var a={id:0,roomId:f.roomId,createdBy:f.userId};return s&&(a.id=s.id,a.createdBy=s.createdBy),t.find(":input").each(function(){var b=$(this),c=j(b),d=b.val();"answerType"==c&&(d=parseInt(d)),a[c]=d}),a.answers=b(a.answers),a}function j(a){return a.attr("id").substring(7)}function k(){return 0==arguments.length?r:(r=arguments[0],this)}function l(){return r=0,this}function m(){if(s&&s.publishCount>0&&d.showMessage("Can not update published question"),y&&y.form()){var b=i();g.request(s?{command:"updateQuestion",data:b,success:function(){s=b,r?d.showMessage(MSG.successUpdate):d.showQuestionList("left"),a(v,!0)}}:{command:"createQuestion",data:b,success:function(b){f.isRoomAdmin()?(s=b,f.isEventAdmin()?(d.showMessage(MSG.successUpdate),u.text(MSG.update),x.show("slow"),a(v,!0)):d.showQuestionList("left")):(d.showMessage(MSG.questionPosted),h())}})}}function n(){g.request({command:"publishQuestion",data:{questionId:s.id,eventId:r,includeRanking:w.is(":checked")},success:function(a){"OK"!=a&&d.showMessage(a)}})}function o(b){a(w,b),b||w.removeAttr("checked")}function p(b){t=$("#make-q-form"),c(t.find(":input")).each(function(){var a=$(this);if(s){var b=j(a);s[b]&&a.val(s[b])}}),y=t.validate({rules:{"make-q-question":{required:!0},"make-q-answers":{quizChoices:!0,required:!0},"make-q-tags":{maxlength:100},"make-q-relatedUrl":{url:!0,maxlength:256}},focusInvalid:!0}),t.find(":input").change(function(){a(v,!1)}),u=$("#make-q-update-btn").click(m),x=$("#make-q-publish"),w=$("#make-q-includeRank"),s&&r&&x.show(),v=$("#make-q-publish-btn").click(n),e(b),s&&($("#make-q-desc").text(r?MSG.editAndPublishQuestion:MSG.editQuestion),u.text(MSG.update),s.publishCount>0&&(a(t.find(":input"),!1),a(u,!1)),s.answerType==C.NoAnswer&&o(!1)),$("#make-q-answerType").change(function(){var a=$(this).val();o(a!=C.NoAnswer)}),f.isRoomAdmin()?$("#make-q-back-btn").click(function(){d.showQuestionList("left")}).show():u.text(MSG.post)}function q(){s=null,t=null,u=null,v=null,w=null,x=null,y=null}var r=0,s=null,t=null,u=null,v=null,w=null,x=null,y=null;$.extend(this,{openEvent:k,closeEvent:l,init:p,clear:q,edit:function(a){s=a}})}function s(b,c,d){function e(a,b){$("#answer-"+a).find(".answer-cnt .count").text(b)}function f(a){a.removeClass("white disabled").addClass("blue"),a.find("li:first").empty().append("<i class='fa fa-check fa-2x'></i>")}function g(b){a(b,!1),b.removeClass("white").addClass("disabled")}function h(a){a.removeClass("white blue disabled").addClass("green"),a.find("li:first").empty().append("<i class='fa fa-circle-o fa-2x'></i>")}function i(a){a.removeClass("white blue disabled").addClass("red"),a.find("li:first").empty().append("<i class='fa fa-times fa-2x'></i>")}function j(a){if(F)for(var b=0;w>b;b++){var c=""+(b+1),d=a[c]||0;e(c,d)}F.find(".answer-cnt").show()}function k(){var a=(new Date).getTime()-B,e=$(this),h=parseInt(e.attr("id").substring(7));if(!A){if(A=!0,g(F),f(e),G=e,a>v)return void b.showMessage("timeLimitExceeded");d.request({command:"answer",data:{userId:c.userId,publishId:x.id,eventId:c.eventId,userEventId:c.userEventId,answer:h,time:a}}),j(y)}}function l(a){var b=""+a.answer,d=(y[b]||0)+1;y[b]=d,(c.isEventAdmin()||A)&&e(b,d)}function m(a,b){function c(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&(-1==a||a>d)&&(a=d)}return a}function d(){var a=-1;for(var c in b){var d=b[c]||0;0!=d&&d>a&&(a=d)}return a}switch(a.answerType){case C.FirstRow:for(var e=$.isArray(a.answers)?a.answers[0]:a.answers.split("\n")[0],f=0;f<F.length;f++){var g=$(F[f]);if(g.find(".answer").text()==e)return g}break;case C.Most:case C.Least:var h=a.answerType==C.Most?d():c();if(-1==h)return null;var i=[];return F.each(function(){$(this).find(".answer-cnt .count").text()==h&&i.push(this)}),$(i);case C.NoAnswer:return null}throw"IllegalState: "+a.answerType}function n(a,c,d){function e(a,b){var c=!1,d=a.attr("id");return b.each(function(){d==$(this).attr("id")&&(c=!0)}),c}if(F){var f=m(a,c);if(f){if(G){var g=e(G,f);msg=g?MSG.correctAnswer:MSG.wrongAnswer,g||i(G),d&&b.showEffect(msg,1)}h(f)}if(a.description){var j=$("#publish-q-description");j.find("textarea").val(a.description),j.show()}if(a.relatedUrl){var k=$("#publish-q-url"),l=k.find("a");l.attr("href",a.relatedUrl).text(a.relatedUrl),k.show()}d?$("#publish-q-detail").slideDown():$("#publish-q-detail").show()}}function o(a){z=a,D&&n(z,y,!0)}function p(){function a(){b--,e.css("width",b+"%"),20>b?e.removeClass("progress-bar-warning").addClass("progress-bar-danger"):60>b&&e.removeClass("progress-bar-success").addClass("progress-bar-warning"),A&&(-1==c&&(c=b+1),f.css("width",c-b+"%")),b>0?setTimeout(a,d):(g(F),j(y),D=!0,z&&n(z,y,!0))}var b=100,c=-1,d=v/100,e=$("#publish-q-progress"),f=$("#publish-q-progress-answered"),h=null,i=0,k=0;e.css("width","100%"),f.css("width","0%"),setTimeout(a,d),H.contents().each(function(){$(this).replaceWith($(this).text().replace(/(\S)/g,"<span>$1</span>"))}),H.append('<span class="cur">_</span>'),h=H.find(".cur"),i=setInterval(function(){h&&h.toggle()},200),k=H.children().size();for(var l=0;k>l;l++){var m=H.children("span:eq("+l+")");l==k-1?setTimeout(function(){m.hide(),clearInterval(i)},50*l+2e3):m.delay(50*l).fadeIn(10)}}function q(a){var d=$("#publish-q-seq");if(H=$("#publish-q-text"),F=a.find(".btn-question").hide(),E){d.hide(),$("#publish-q-progress").hide(),$("#publish-q-ranking").hide(),a.find(".publish-q-animation").hide(),$("#publish-q-back").show(),$("#publish-q-back-btn").click(function(){b.backToMypage()});for(var e=0;e<E.answers.length;e++){var f=$("#answer-"+(e+1)).show();f.find(".answer-seq").text(e+1+"."),f.find(".answer").text(E.answers[e])}E.userAnswer&&(G=$("#answer-"+E.userAnswer)),j(E.answerCounts),g(F),n(E,E.answerCounts,!1),H.text(E.question)}else{if(x){d.text(MSG.format(MSG.questionSeq,x.seq));for(var e=0;e<x.answers.length;e++){var f=$("#answer-"+(e+1)).show();f.find(".answer-seq").text(e+1+"."),f.find(".answer").text(x.answers[e])}H.text(x.question)}z?(a.find(".publish-q-animation").css({"animation-name":"","-webkit-animation-name":""}),j(y),g(F),n(z,y,!1)):x?(a.find(".publish-q-animation").css({"animation-name":"inout","-webkit-animation-name":"inout"}),c.isEventAdmin()?j(y):c.userEventId?F.click(k):g(F)):($("#publish-q-default").hide(),$("#publish-q-none").show()),$("#publish-q-ranking").click(function(){b.showRanking()})}}function r(){z||E||(B=(new Date).getTime(),p())}function s(){F=null,G=null,H=null}function t(a){x=a,y={},z=null,A=!1,B=0,D=!1,E=null}function u(a){E=a}var v=1e4,w=5,x=null,y={},z=null,A=!1,B=0,D=!1,E=null,F=null,G=null,H=null;$.extend(this,{init:q,afterShow:r,clear:s,receiveAnswer:l,receiveAnswerDetail:o,setQuestion:t,setLookback:u})}function t(a,b,c){function d(){return b.isEventRunning()&&!b.isEntryEvent()}function e(){d()&&$(".entry-event").show()}function f(){$(".entry-event").hide()}function g(d){var e={userId:b.userId,username:b.username,userImage:b.userImage,eventId:b.eventId};d&&(e.passcode=d),c.request({command:"entryEvent",data:e,success:function(c){c.error?a.showMessage(c.error):c.requirePass?a.showPasscode():c.userEventId?(b.userEventId=c.userEventId,d&&a.showChat()):alert("Invalid data: "+JSON.stringify(c))}})}function h(){d()&&(g(),$("#entry-event-alert").hide())}function i(){$("#event-passcode-btn").click(function(){var a=$("#event-passcode-user").val();g(a)}),$("#event-cancel-btn").click(function(){a.showChat()})}function j(){}$(".entry-event-btn").click(h),$("#not-entry-event").click(function(){$("#entry-event-alert").hide()}),d()&&e(),$.extend(this,{init:i,clear:j,openEvent:e,closeEvent:f})}function u(a,b,d){function f(a){if(a){for(var b in a){var c=$("#event-"+b);c.length&&c.val(a[b])}if(a.execDate){var d=new h(a.execDate);$("#event-date").val(d.dateStr()),$("#event-time").val(d.timeStr())}}}function g(){var a=$("#event-date").val(),c=$("#event-time").val(),d={id:b.eventId||0,roomId:b.roomId,status:b.eventStatus};return m.find(":input.auto-collect").each(function(){var a=$(this),b=a.attr("id").substring(6),c=a.val();c&&(d[b]=a.val())}),a&&(c&&(a+=" "+c),d.execDate=new Date(a).getTime()),d.capacity=parseInt(d.capacity),d}function i(){b.eventStatus==D.Prepared&&(b.eventId?d.request({command:"openEvent",data:{id:b.eventId,admin:b.userId},success:function(b){b?a.showQuestionList():a.showMessage(MSG.failOpenEvent)}}):j(!0))}function j(c){if(n&&n.form()){var e=g();d.request(e.id?{command:"updateEvent",data:e,success:function(){a.showMessage(MSG.successUpdate)}}:{command:"createEvent",data:e,success:function(d){b.eventId=d.id,b.eventStatus=d.status,c?i():a.showMessage(MSG.successUpdate)}})}}function k(a){m=a.find("form"),c(m.find(":input")),n=m.validate({rules:{"event-capacity":{required:!0,digits:!0},"event-title":{maxlength:100},"event-date":{date:!0},"event-time":{time:!0},"event-passcode":{maxlength:100},"event-description":{maxlength:400}},focusInvalid:!0}),e(a),$("#event-start-btn").click(i),$("#event-update-btn").click(function(){j(!1)}),d.request({command:"getCurrentEvent",success:f})}function l(){m=null,n=null}var m=null,n=null;$.extend(this,{init:k,clear:l})}function v(a,b,c){function d(a,b,c){for(var d=0;d<b.length;d++){var e=b[d],g=$("<tr><td class='r-rank'/><td class='r-name'/><td class='r-correct'/><td class='r-time'/></tr>"),h=g.find(".r-rank"),i=g.find(".r-name"),j=$("<img/>");h.text(e.correctCount>0?c+d+1:"-"),j.attr("src",e.imageUrl),i.append(j),i.append(e.username),e.correctCount&&(g.find(".r-correct").text(e.correctCount),g.find(".r-time").text(f(e.time))),a.append(g)}}function e(a,e,f){var g;"boolean"==typeof f&&(g=f?"right":"left"),c.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(b){var c=$("#event-members-tbl"),e=c.find("tbody");e.empty(),g&&c.hide(),d(e,b,a),g&&c.show("slide",{direction:g},A)}})}function g(){b.isEventRunning()&&c.request({command:"closeEvent",data:b.eventId,success:function(b){b&&a.showRanking()}})}function h(a){$("#event-finish-btn").click(g),c.request({command:"getMemberCount",data:b.eventId,success:function(b){k=new i(a.find(".paging-bar"),b,e,10),e(0,10)}})}function j(){k=null}var k=null;$.extend(this,{init:h,clear:j})}function w(a,b,c,d){function e(a,b,c){c?3>=b?a.html("<span class='badge circle rank-blue'>"+b+"</span>"):a.text(b):a.text("-"),a.attr("data-sortAs",b)}function g(){var a=$(this),b=parseInt(a.attr("data-eventId"));d.request({command:"getEventRanking",data:{eventId:b,limit:10},success:function(a){k($("#ranking-event-detail-tbl"),a),z.find(".tab-pane").hide(),$("#ranking-event-detail").show("slide",{direction:"right"},A)}})}function i(){var a=$(this),e=parseInt(a.attr("data-userId")),f=c[e];d.request({command:"getUserEvent",data:{roomId:b.roomId,userId:e},success:function(b){o(b),$("#ranking-user-img").attr("src",f.getBiggerImageUrl()),$("#ranking-user-name").text(f.name),$("#ranking-user-point").text(a.attr("data-point")),z.find(".tab-pane").hide(),$("#ranking-user").show("slide",{direction:"right"},A)}})}function j(a,b,d){for(var g=$("<tr></tr>"),i=0;i<b.length;i++){var j=$("<td></td>"),k=b[i],m=null;if($.isArray(k)&&(m=k[1],k=k[0]),m||(m=w[k]),m||(m="r-"+k),j.addClass(m),"username"==k&&a.username){var n=$("<img/>");n.attr("src",a.imageUrl),j.append(n),j.append(a.username)}else"title"==k?j.text(a.title||new h(a.execDate).datetimeStr()):"rank"==k?e(j,d,a.correctCount):"time"==k&&a.time?j.text(f(a.time)):a[k]&&j.text(a[k]);g.append(j)}return c[a.userId]||(c[a.userId]=new l({id:a.userId,name:a.username,imageUrl:a.imageUrl})),g}function k(a,b,c){var d=a.find("tbody"),g={};if(d.empty(),c&&x)for(var h=0;h<x.length;h++){var i=x[h],k=j(i,s,h+11);g[i.userId]=k,d.append(k)}for(var h=0;h<b.length;h++){var i=b[h],k=g[i.userId];k?(e(k.find(".r-rank"),h+1),k.find(".r-correct").text(i.correctCount),k.find(".r-time").text(f(i.time))):(k=j(i,s,h+1),d.append(k)),k.addClass("new")}c&&(setTimeout(function(){a.tableSort({sortBy:["numeric","nosort","nosort","nosort"]}),a.find("thead th:first").click(),setTimeout(function(){var a=d.find("tr").not(".new");a.hide("slow",function(){a.remove()})},200)},200),x=b,y=null)}function m(a){var c=$("#ranking-event-tbl").find("tbody");c.empty();for(var d=0;d<a.length;d++){var e=a[d],f=null;e.eventId!=b.eventId&&(f=j(e,t),f.attr("data-eventId",e.eventId),f.click(g),c.append(f))}}function n(a){var b=$("#ranking-total-tbl").find("tbody");b.empty();for(var c=0;c<a.length;c++){var d=a[c],e=j(d,u,c+1);e.attr("data-userId",d.userId),e.attr("data-point",d.point),e.click(i),b.append(e)}}function o(a){function c(a){for(var b=0;b<e.length;b++){var c=$(e[b]);if(c.attr("data-eventId")==a)return c.find(".r-title").text()}return"Unknown"}var d=$("#ranking-user-tbl").find("tbody"),e=$("#ranking-event-tbl").find("tbody tr");d.empty();for(var f=0;f<a.length;f++){var g=a[f],h=null,i=g.point>0?10-g.point+1:"-";g.eventId!=b.eventId&&(g.title=c(g.eventId),h=j(g,v,i),d.append(h))}}function p(){B=$("#ranking-now-tbl"),b.isEventRunning()?d.request({command:"getEventRanking",data:{eventId:b.eventId,limit:10},success:function(a){a.length&&(y=a)}}):$(".ranking-now").hide(),d.request({command:"getEventWinners",data:{roomId:b.roomId,limit:10},success:m}),d.request({command:"getTotalRanking",data:{roomId:b.roomId,limit:10},success:n}),$("#ranking-event-detail-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-event").show("slide",{direction:"left"},A)}),$("#ranking-user-back").click(function(){z.find(".tab-pane").hide(),$("#ranking-total").show("slide",{direction:"left"},A)}),z=$("#ranking-tab").tabs({active:b.isEventRunning()?0:1,beforeActivate:function(){z.find(".tab-pane").hide()}}).show()}function q(){y&&k(B,y,!0)
}function r(){z=null,B=null,console.log("Ranking#clear")}var s=["rank","username","correctCount","time"],t=["title",["username","r-winners"],"correctCount","time"],u=["rank","username","point","correctCount"],v=["title","rank","point","correctCount"],w={username:"r-name",correctCount:"r-correct"},x=null,y=null,z=null,B=null;$.extend(this,{init:p,afterShow:q,clear:r})}function x(){function a(a,b,d){c&&c.log(a,b,d)}function b(a){c=a}var c=null;$.extend(this,{log:a,setImpl:b})}function y(a,b){function c(a,b,c){"object"==typeof b&&(b=JSON.stringify(b)),f>d&&e.find("tr:first").remove();var g=$("<tr><td></td><td></td><td><div class='pull-right'></div></td></tr>"),h=g.find("td");$(h.get(0)).text(a),$(h.get(1)).text(b),c&&$(h.get(2)).find("div").text(c),e.append(g),f++,console.log(a+", "+b+(c?", "+c+"ms":""))}var d=10,e=a.find("table tbody"),f=0;b.onRequest(function(a,b){var d=a;b&&(d+=", "+JSON.stringify(b)),c("send",d)}).onMessage(function(a,b){var d=(new Date).getTime();c("receive",JSON.stringify(a),d-b)}),$("#chk-use-ajax").bootstrapSwitch().on("switchChange",function(){var a=$(this).is(":checked");b.useAjax(a?"/ajax":!1)}),$("#btn-debug-msg").click(function(){$("#effect-dialog").animateDialog("Start!",{name:"rotateZoom"});var a=$(".publish-q-animation");a.css({"animation-name":"inout","-webkit-animation-name":"inout"}),a.hide(),setTimeout(function(){a.show()},0)}),$.extend(this,{log:c})}$.validator.addMethod("quizChoices",function(a){if(!a||0==a.length)return!1;var b=a.split("\n").filter(function(a){return a.length>0});return b.length<=1||b.length>5?!1:!0},MSG.invalidQuizChoices),$.validator.addMethod("time",function(a,b){return this.optional(b)||/^\d{2}:\d{2}$/.test(a)},MSG.invalidTime);var z="ontouchstart"in window,A=300,B="/assets/images/twitter_default_profile.png",C={FirstRow:0,Most:1,Least:2,NoAnswer:3},D={Prepared:0,Running:1,Finished:2},A=300;flect.QuizApp=function(a){function b(a,b){function c(){d.is(":visible")||(W.children("div").hide(),d.show("slide",{direction:"right"},A))}var d=$("#"+a);b?$.sidr("close",c):c()}function c(){b("chat",!1)}function d(){var a={name:"mypage",direction:"left",beforeShow:L.init,afterHide:L.clear};W.children("div").hide(),R.show(a)}function e(a){var b={name:"publish-question",beforeShow:function(b){U.setLookback(a),U.init(b)},afterHide:function(){U.clear(),U.setLookback(null)}};W.children("div").hide(),R.show(b)}function f(a){if(U){var b={name:"publish-question",effect:"none",beforeShow:function(b){a&&U.setQuestion(a),U.init(b)},afterShow:U.afterShow,afterHide:U.clear};W.children("div").hide(),R.show(b)}}function g(){W.children("div").hide(),R.show(_.ranking)}function h(a){if(T){var b=$.extend({name:"edit-question"},_["edit-question"]);a&&(b.direction=a),W.children("div").hide(),R.show(b)}}function i(a){M&&(a&&M.edit(a),W.children("div").hide(),R.show({name:"make-question",beforeShow:M.init,afterHide:M.clear}))}function B(){Q&&(W.children("div").hide(),R.show({name:"passcode",beforeShow:Q.init,afterHide:Q.clear}))}function C(a,b){H.show(a,b)}function D(a,b){I.show(a,b)}function E(a,b){S&&S.tweet(a,b)}function F(){if(window.sessionStorage&&sessionStorage.clear(),G=new x,H=new flect.MessageDialog($("#msg-dialog")),I=new j($("#effect-dialog")),J=new flect.Connection(Y.uri,G),K=new m(J,Z,Y.userId),R=new flect.TemplateManager(J,$("#content-dynamic")),U=new s(X,Y,J),W=$("#content"),Y.isDebug()&&(G.setImpl(new y($("#debug"),J,H)),$("#btn-debug").click(function(){return b("debug",!0),!1}),J.onOpen(function(a){console.log("onOpen"),console.log(a)}).onClose(function(a){console.log("onClose"),console.log(a)}).onSocketError(function(a){console.log("onSocketError"),console.log(a)}).onServerError(function(a){console.log(a),alert(a)})),J.addEventListener("redirect",function(a){location.href=a}),Y.isLogined()&&(Z[Y.userId]=new l({id:Y.userId,name:Y.username,imageUrl:Y.userImage}),L=new n(X,Y,Z,J),N=new p(app,Y.userId,J)),Y.isInRoom()){var a=$("#chat");S=new o(a,Y.userId,Y.hashtag,J),$(".menu-chat").click(function(){return b("chat",$(this).parents("#sidr").length>0),!1}),$("#toolbar-ranking").click(function(){return g(),!1}),$("#toolbar-question").click(function(){return Y.isEventAdmin()?h():f(),!1}),J.addEventListener("chat",function(a){S.append(a),a.userId!=Y.userId&&S.isNotifyTweet()&&H.notifyTweet(a)}),J.addEventListener("member",S.member),J.addEventListener("newEntry",function(a){var b=new l(a);Z[b.id]=b,H.notifyUserAction(b,MSG.newEntry)}),J.ready(function(){0==S.member()&&J.request({command:"member"})}),J.addEventListener("startEvent",function(a){var b=a.id,c=a.admin;I.show(MSG.start),Y.openEvent(b,c==Y.userId),M&&M.openEvent(Y.eventId),Q&&setTimeout(Q.openEvent,3e3)}),J.addEventListener("finishEvent",function(){I.show(MSG.finish),Y.closeEvent(),M&&M.closeEvent(),Q&&Q.closeEvent()}),J.addEventListener("question",function(a){f(a)}),J.addEventListener("answer",U.receiveAnswer),J.addEventListener("answerDetail",U.receiveAnswerDetail),V=new w(X,Y,Z,J)}$("#home").length&&J.ready(function(){K.init($("#home"))}),(Y.isRoomAdmin()||Y.isPostQuestionAllowed())&&(M=new r(X,Y,J),Y.isEventRunning()&&M.openEvent(Y.eventId)),Y.isRoomAdmin()&&(T=new q(X,Z,Y,J),O=new u(X,Y,J),J.addEventListener("postQuestion",function(a){var b=a,c=Z[b];T.reload(),c?H.notifyUserAction(c,MSG.postQuestionMessage):J.request({command:"getUser",data:b,success:function(a){var b=new l(a);Z[b.id]=b,H.notifyUserAction(b,MSG.postQuestionMessage)}})}),P=new v(X,Y,J)),Y.canEntryEvent()&&(Q=new t(X,Y,J)),$("#btn-menu").sidr({onOpen:function(){$("#toolbar").css("left","260px").find(".header-center").hide()},onClose:function(){$("#toolbar").css("left","0px").find(".header-center").show()}}),$("#content").swipe({swipeLeft:function(){$.sidr("close")},swipeRight:function(){$.sidr("open")},tap:function(a,b){z&&$(b).click()}}),J.polling(25e3,{command:"noop",log:"user="+(Y.isLogined()?Y.username:"(Anonymous)")}),$("#sidr a.dynamic").click(function(){var a=$(this).attr("href").substring(1),b=$.extend({name:a},_[a]);return $.sidr("close",function(){W.children("div").hide(),R.show(b)}),!1}),$(".dropdown-button").click(function(){return $(this).next("ul").toggle(),!1}),$(".dropdown-menu a").click(function(){var a=$(this);return a.parents(".dropdown-menu").hide(),"#"!=a.attr("href")})}var G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X=this,Y=new k(a),Z={};F(),G.log("params",Y);var _={home:{beforeShow:K.init,afterHide:K.clear}};Y.isLogined()&&$.extend(_,{mypage:{beforeShow:function(a){L.reset(),L.init(a)},afterHide:L.clear},"make-room":{beforeShow:function(a){N.clear(),N.init(a)},afterHide:N.clear},"publish-question":{name:"publish-question",beforeShow:U.init,afterHide:U.clear},"edit-room":{name:"make-room",beforeShow:function(a){N.clear(),N.edit(Y.roomId),N.init(a)},afterHide:N.clear}}),Y.isRoomAdmin()?($.extend(_,{"edit-question":{beforeShow:T.init,afterHide:T.clear}}),$.extend(_,{"edit-event":{beforeShow:function(a){Y.isEventRunning()?P.init(a):O.init(a)},name:function(){return Y.isEventRunning()?"event-members":"edit-event"},afterHide:function(){Y.isEventRunning()?P.clear():O.clear()}}})):Y.isPostQuestionAllowed()&&$.extend(_,{"post-question":{name:"make-question",beforeShow:M.init,afterHide:M.clear}}),Y.isInRoom()&&$.extend(_,{ranking:{name:"ranking",beforeShow:V.init,afterShow:V.afterShow,afterHide:V.clear}}),$.extend(this,{showQuestionList:h,showMakeQuestion:i,showPasscode:B,showChat:c,showRanking:g,showQuestion:f,showLookback:e,showMessage:C,showEffect:D,backToMypage:d,tweet:E})}});